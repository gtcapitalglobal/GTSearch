<!DOCTYPE html>
<html>
<head>
    <title>Teste - BotÃ£o Analisar Selecionadas</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        button { padding: 10px 20px; margin: 10px 0; cursor: pointer; }
        .success { background: #4CAF50; color: white; border: none; }
        .error { background: #f44336; color: white; border: none; }
        #log { background: #f5f5f5; padding: 15px; margin-top: 20px; max-height: 400px; overflow-y: auto; }
        .log-entry { margin: 5px 0; padding: 5px; border-left: 3px solid #2196F3; }
    </style>
</head>
<body>
    <h1>ğŸ” DiagnÃ³stico do BotÃ£o "Analisar Selecionadas"</h1>
    
    <div>
        <button id="testBtn" class="success" onclick="testAnalyzeFunction()">
            ğŸ“Š Testar FunÃ§Ã£o analyzeSelectedProperties()
        </button>
        
        <button class="success" onclick="loadCSVAndTest()">
            ğŸ“ Carregar Polk.csv e Testar
        </button>
        
        <button class="error" onclick="clearLog()">
            ğŸ—‘ï¸ Limpar Log
        </button>
    </div>
    
    <div id="log"></div>
    
    <script>
        let allNewProperties = [];
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.style.borderLeftColor = type === 'error' ? '#f44336' : type === 'success' ? '#4CAF50' : '#2196F3';
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        function analyzeSelectedProperties() {
            log('ğŸš€ FunÃ§Ã£o analyzeSelectedProperties() foi chamada!', 'success');
            
            const rowCheckboxes = document.querySelectorAll('.row-checkbox:checked');
            log(`ğŸ“‹ Checkboxes marcados: ${rowCheckboxes.length}`);
            
            if (rowCheckboxes.length === 0) {
                alert('Selecione pelo menos uma propriedade para analisar.');
                log('âš ï¸ Nenhum checkbox marcado - mostrando alert', 'error');
                return;
            }
            
            const selectedProperties = [];
            rowCheckboxes.forEach(cb => {
                const index = parseInt(cb.getAttribute('data-index'));
                const property = allNewProperties[index];
                
                if (property) {
                    selectedProperties.push(property);
                }
            });
            
            log(`âœ… Propriedades selecionadas: ${selectedProperties.length}`, 'success');
            log(`ğŸ“¦ Salvando no localStorage...`);
            
            localStorage.setItem('selectedProperties', JSON.stringify(selectedProperties));
            
            log(`âœ… Salvo no localStorage!`, 'success');
            log(`ğŸ”„ Redirecionando para analysis.html...`);
            
            // Comentar o redirect para ver os logs
            // window.location.href = 'analysis.html';
            log(`âš ï¸ Redirect comentado para teste - descomente para funcionar`, 'error');
        }
        
        function testAnalyzeFunction() {
            log('=== INICIANDO TESTE ===');
            log(`1. Verificando se funÃ§Ã£o existe: ${typeof analyzeSelectedProperties}`);
            log(`2. allNewProperties length: ${allNewProperties.length}`);
            
            try {
                analyzeSelectedProperties();
            } catch (e) {
                log(`âŒ ERRO: ${e.message}`, 'error');
                log(`Stack: ${e.stack}`, 'error');
            }
        }
        
        function loadCSVAndTest() {
            log('ğŸ“ Carregando Polk.csv...');
            
            fetch('/upload/Polk.csv')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return response.text();
                })
                .then(csvText => {
                    log('âœ… CSV carregado com sucesso!', 'success');
                    
                    Papa.parse(csvText, {
                        header: true,
                        skipEmptyLines: true,
                        complete: (results) => {
                            allNewProperties = results.data;
                            log(`âœ… ${allNewProperties.length} propriedades parseadas!`, 'success');
                            log(`ğŸ“‹ Primeira propriedade: ${JSON.stringify(allNewProperties[0]).substring(0, 100)}...`);
                            
                            // Criar checkbox fake para teste
                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.className = 'row-checkbox';
                            checkbox.setAttribute('data-index', '0');
                            checkbox.checked = true;
                            document.body.appendChild(checkbox);
                            
                            log('âœ… Checkbox de teste criado e marcado', 'success');
                            log('ğŸ¯ Agora clique em "Testar FunÃ§Ã£o" para simular o click no botÃ£o!');
                        }
                    });
                })
                .catch(error => {
                    log(`âŒ Erro ao carregar CSV: ${error.message}`, 'error');
                });
        }
        
        log('âœ… PÃ¡gina de teste carregada!', 'success');
        log('ğŸ“ Clique em "Carregar Polk.csv e Testar" para comeÃ§ar');
    </script>
</body>
</html>

