<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An√°lise Detalhada - GTSearch v22.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="florida-counties-api.js"></script>
    <script src="flood-zones-data.js"></script>
    <script src="property-analysis-widget.js"></script>
    <style>
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        .map-container { height: 450px; width: 100%; }
        .tab-button { transition: all 0.3s; }
        .tab-button.active { background-color: #3b82f6; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: grid; }
        .photo-gallery { position: relative; overflow: hidden; }
        .photo-nav { position: absolute; top: 50%; transform: translateY(-50%); z-index: 10; }
        
        /* Responsivo: bot√µes laterais em mobile */
        .scale-125 {
            transform: scale(1.25);
            transition: transform 0.3s ease;
        }
        
        /* Bot√µes laterais - estilo compacto */
        .property-section-grid {
            display: grid;
            grid-template-columns: 1fr 140px;
            gap: 20px;
            align-items: start;
        }
        
        .actions-sidebar {
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: sticky;
            top: 20px;
        }
        
        .actions-sidebar h3 {
            font-size: 11px;
            font-weight: 600;
            color: #718096;
            text-align: center;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .actions-sidebar button {
            padding: 10px 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .actions-sidebar button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .actions-sidebar button .icon {
            font-size: 18px;
            line-height: 1;
        }
        
        .actions-sidebar button .label {
            font-size: 11px;
            line-height: 1;
        }
        
        @media (max-width: 768px) {
            .property-section-grid {
                grid-template-columns: 1fr !important;
            }
            .actions-sidebar {
                flex-direction: row !important;
                position: static !important;
            }
            .actions-sidebar button {
                flex-direction: row !important;
                padding: 14px 24px !important;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-2">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-3 mb-2">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <img src="logo.png" alt="GTSearch Logo" class="h-12">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">
                            üìä An√°lise Detalhada <span class="text-lg text-gray-500">v22.0</span>
                        </h1>
                        <p class="text-xs text-gray-400">Vers√£o: 11/19/2025 √†s 14:45 (Miami)</p>
                        <p class="text-sm text-gray-600 mt-0.5" id="propertyCount">Carregando...</p>
                    </div>
                </div>
                <button onclick="voltarAoDashboard()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold text-sm">
                    ‚Üê Voltar ao Dashboard
                </button>
            </div>
        </div>

        <!-- Barra de A√ß√µes R√°pidas -->
        <div class="bg-white rounded-lg shadow-lg mb-3 p-4">
            <div class="flex items-center justify-between gap-4">
                <div class="flex items-center gap-3">
                    <span class="text-sm font-semibold text-gray-700">A√ß√µes R√°pidas:</span>
                    <button onclick="deletarPropriedade()" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-semibold text-sm shadow-md hover:shadow-lg">
                        ‚ùå Deletar
                    </button>
                    <button onclick="aprovarPropriedade()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-semibold text-sm shadow-md hover:shadow-lg">
                        ‚úÖ Aprovar
                    </button>
                    <button onclick="window.location.href='investment.html'" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-semibold text-sm shadow-md hover:shadow-lg">
                        üëÅÔ∏è Ver Aprovadas (<span id="approvedCount">0</span>)
                    </button>
                    <button onclick="anteriorPropriedade()" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors font-semibold text-sm shadow-md hover:shadow-lg">
                        ‚¨ÖÔ∏è Anterior
                    </button>
                    <button onclick="proximaPropriedade()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold text-sm shadow-md hover:shadow-lg">
                        ‚û°Ô∏è Pr√≥xima
                    </button>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-sm px-3 py-1 bg-green-100 rounded-lg">
                        <span class="font-semibold text-green-700">‚úÖ Aprovadas:</span>
                        <span id="approved-count" class="text-green-800 font-bold">0</span>
                    </div>
                    <div class="text-sm">
                        <span class="font-semibold text-gray-700">Progresso:</span>
                        <span id="progress-text" class="text-gray-600">0 de 0</span>
                    </div>
                    <div class="w-48 bg-gray-200 rounded-full h-2.5">
                        <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="bg-white rounded-lg shadow-lg mb-3">
            <div class="flex border-b border-gray-200">
                <button class="tab-button active flex-1 px-4 py-2 font-semibold text-sm text-gray-700 hover:bg-blue-50" data-tab="google-maps">
                    üó∫Ô∏è Google Maps
                </button>
                <button class="tab-button flex-1 px-4 py-2 font-semibold text-sm text-gray-700 hover:bg-blue-50" data-tab="terrain-map">
                    üèîÔ∏è Terreno + Mapa
                </button>
                <button class="tab-button flex-1 px-4 py-2 font-semibold text-sm text-gray-700 hover:bg-blue-50" data-tab="photos">
                    üì∏ Fotos
                </button>
                <button class="tab-button flex-1 px-4 py-2 font-semibold text-sm text-gray-700 hover:bg-blue-50" data-tab="aerial-image">
                    üõ∞Ô∏è Imagem A√©rea
                </button>
            </div>

            <!-- Tab Content: Google Maps -->
            <div class="tab-content p-3" id="google-maps">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <h3 class="text-sm font-bold text-gray-800 mb-2">üõ∞Ô∏è Vista Sat√©lite</h3>
                        <div id="satellite-map" class="map-container bg-gray-200 rounded-lg flex items-center justify-center">
                            <button id="load-satellite-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors">
                                üîç Carregar Imagem
                            </button>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-sm font-bold text-gray-800 mb-2">üö∂ Street View</h3>
                        <div id="street-view" class="map-container bg-gray-200 rounded-lg flex items-center justify-center">
                            <button id="load-streetview-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors">
                                üîç Carregar Imagem
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab Content: Terrain + Map -->
            <div class="tab-content p-3" id="terrain-map">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <h3 class="text-sm font-bold text-gray-800 mb-2">üèûÔ∏è Vista Terreno (Relevo)</h3>
                        <div id="terrain-map-view" class="map-container bg-gray-200 rounded-lg flex items-center justify-center">
                            <button id="load-terrain-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors">
                                üîç Carregar Imagem
                            </button>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-sm font-bold text-gray-800 mb-2">üó∫Ô∏è Mapa Normal</h3>
                        <div id="normal-map" class="map-container bg-gray-200 rounded-lg flex items-center justify-center">
                            <button id="load-normalmap-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors">
                                üîç Carregar Imagem
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab Content: Photos -->
            <div class="tab-content p-3" id="photos">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <h3 class="text-sm font-bold text-gray-800 mb-2">üè° Zillow Photos</h3>
                        <div id="zillow-photos" class="map-container bg-gray-200 rounded-lg flex items-center justify-center photo-gallery">
                            <button id="load-zillow-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors">
                                üîç Carregar Fotos
                            </button>
                            <button class="photo-nav left-4 bg-white p-2 rounded-full shadow-lg hidden" id="zillow-prev">‚óÑ</button>
                            <img id="zillow-photo" src="" alt="Zillow Photo" class="w-full h-full object-cover rounded-lg hidden">
                            <div id="zillow-loading" class="text-gray-500 hidden">Carregando fotos...</div>
                            <button class="photo-nav right-4 bg-white p-2 rounded-full shadow-lg hidden" id="zillow-next">‚ñ∫</button>
                        </div>
                        <p class="text-center text-sm text-gray-600 mt-2" id="zillow-counter">0 / 0</p>
                    </div>
                    <div>
                        <h3 class="text-sm font-bold text-gray-800 mb-2">üè† Realtor Photos</h3>
                        <div id="realtor-photos" class="map-container bg-gray-200 rounded-lg flex items-center justify-center photo-gallery">
                            <button id="load-realtor-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors">
                                üîç Carregar Fotos
                            </button>
                            <button class="photo-nav left-4 bg-white p-2 rounded-full shadow-lg hidden" id="realtor-prev">‚óÑ</button>
                            <img id="realtor-photo" src="" alt="Realtor Photo" class="w-full h-full object-cover rounded-lg hidden">
                            <div id="realtor-loading" class="text-gray-500 hidden">Carregando fotos...</div>
                            <button class="photo-nav right-4 bg-white p-2 rounded-full shadow-lg hidden" id="realtor-next">‚ñ∫</button>
                        </div>
                        <p class="text-center text-sm text-gray-600 mt-2" id="realtor-counter">0 / 0</p>
                    </div>
                </div>
            </div>
            
            <!-- Tab Content: Aerial Image (NAIP) -->
            <div class="tab-content p-3" id="aerial-image">
                <div class="space-y-3">
                    <div>
                        <h3 class="text-sm font-bold text-gray-800 mb-2">üõ∞Ô∏è Imagem A√©rea NAIP (USDA)</h3>
                        <div class="bg-gray-100 rounded-lg p-3 mb-2">
                            <div class="grid grid-cols-3 gap-2 text-xs text-gray-600 mb-2">
                                <div>
                                    <span class="font-semibold">üìç Localiza√ß√£o:</span>
                                    <span id="naip-location">-</span>
                                </div>
                                <div>
                                    <span class="font-semibold">üìè √Årea:</span>
                                    <span id="naip-area">-</span>
                                </div>
                                <div>
                                    <span class="font-semibold">üìÖ Atualiza√ß√£o:</span>
                                    <span>2023 (estimado)</span>
                                </div>
                            </div>
                            <div class="text-xs text-gray-500">
                                üìå Resolu√ß√£o: 1 metro | Fonte: USDA National Agriculture Imagery Program
                            </div>
                        </div>
                        <div class="relative bg-gray-200 rounded-lg flex items-center justify-center" style="height: 500px;">
                            <button id="load-naip-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors z-10">
                                üîç Carregar Imagem A√©rea
                            </button>
                            <img id="naip-image" src="" alt="NAIP Aerial Image" class="w-full h-full object-contain rounded-lg hidden">
                            <div id="naip-loading" class="absolute inset-0 flex items-center justify-center text-gray-500 hidden">
                                ‚è≥ Carregando imagem a√©rea...
                            </div>
                            <div id="naip-error" class="absolute inset-0 flex items-center justify-center text-red-600 hidden">
                                ‚ùå Erro ao carregar imagem a√©rea
                            </div>
                        </div>
                        <div class="flex gap-2 mt-2">
                            <button onclick="downloadNAIPImage()" class="px-3 py-1 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-xs font-semibold">
                                ‚¨áÔ∏è Baixar Imagem
                            </button>
                            <button onclick="refreshNAIPImage()" class="px-3 py-1 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors text-xs font-semibold">
                                üîÑ Atualizar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Se√ß√£o 1: Informa√ß√µes da Propriedade (IP) -->
        <div class="bg-white rounded-lg shadow-lg p-4 mb-3">
            <h2 class="text-lg font-bold text-gray-800 mb-3">üìã Informa√ß√µes da Propriedade</h2>
            <div class="property-section-grid">
                <!-- Conte√∫do Principal -->
                <div class="grid grid-cols-2 gap-x-6 gap-y-3 text-sm">
                <!-- Coluna Esquerda -->
                <div class="space-y-2">
                    <div>
                        <span class="text-red-600 text-xs font-bold">üî¥ Auction Date:</span>
                        <span class="font-bold ml-2 text-red-600" id="prop-next-auction-1">-</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-gray-600 text-xs font-medium">Parcel #:</span>
                        <span class="font-semibold" id="prop-parcel-1">-</span>
                        <button onclick="copyParcelNumber()" class="text-blue-600 hover:text-blue-800 transition-colors text-xs" title="Copiar Parcel #">
                            üìã Copiar
                        </button>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-gray-600 text-xs font-medium">Address:</span>
                        <span class="font-semibold ml-2" id="prop-address-full-1">-</span>
                        <button onclick="copyAddress()" class="text-blue-600 hover:text-blue-800 transition-colors text-xs" title="Copiar Address">
                            üìã Copiar
                        </button>
                    </div>
                    <div>
                        <span class="text-gray-600 text-xs font-medium">Acres:</span>
                        <span class="font-semibold ml-2" id="prop-acres-1">-</span>
                    </div>
                    <div>
                        <span class="text-gray-600 text-xs font-medium">Square Feet:</span>
                        <span class="font-semibold ml-2" id="prop-sqft-1">-</span>
                    </div>
                    <div>
                        <span class="text-gray-600 text-xs font-medium">Owner:</span>
                        <span class="font-semibold ml-2" id="prop-owner-1">-</span>
                    </div>
                </div>
                
                <!-- Coluna Direita -->
                <div class="space-y-2">
                    <div>
                        <span class="text-gray-600 text-xs font-medium">Amount Due (Bid Inicial):</span>
                        <span class="font-semibold ml-2 text-green-600" id="prop-amount-1">-</span>
                    </div>
                    <div>
                        <span class="text-gray-600 text-xs font-medium">County:</span>
                        <span class="font-semibold ml-2" id="prop-county-1">-</span>
                        <span class="text-gray-500 text-xs">(Appraisal)</span>
                    </div>
                    <div>
                        <span class="text-gray-600 text-xs font-medium">Type:</span>
                        <span class="font-semibold ml-2" id="prop-type-1">-</span>
                    </div>
                    <div>
                        <span class="text-gray-600 text-xs font-medium">Zoneamento:</span>
                        <span class="font-semibold ml-2" id="prop-zoning-1">-</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-gray-600 text-xs font-medium">Coordinates:</span>
                        <span class="font-semibold ml-2 text-xs" id="prop-coordinates-1">-</span>
                        <button onclick="copyCoordinates()" class="text-blue-600 hover:text-blue-800 transition-colors text-xs" title="Copiar Coordinates">
                            üìã Copiar
                        </button>
                    </div>
                    <div>
                        <button onclick="openGoogleMaps()" class="px-3 py-1 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-xs font-semibold">
                            üìç View on Google Maps
                        </button>
                    </div>
                    <div>
                        <span class="text-gray-600 text-xs font-medium">üåä FEMA Flood Risk:</span>
                        <span class="font-semibold ml-2" id="prop-fema-risk-1">‚è≥ Carregando...</span>
                    </div>
                </div>
                
                    <!-- Legal Description (largura completa) -->
                    <div class="col-span-2 mt-2">
                        <div class="flex items-center gap-2">
                            <span class="text-gray-600 text-xs font-medium">Legal Description:</span>
                            <button onclick="copyLegalDescription()" class="text-blue-600 hover:text-blue-800 transition-colors text-xs" title="Copiar Legal Description">
                                üìã
                            </button>
                        </div>
                        <div class="font-semibold ml-2 text-xs mt-1 break-words whitespace-pre-wrap" id="prop-legal-1">-</div>
                    </div>
                </div>
                
                <!-- A√ß√µes R√°pidas na Lateral -->
                <div class="actions-sidebar">
                    <h3>A√ß√µes R√°pidas</h3>
                    <button onclick="deletarPropriedade()" class="bg-red-600 text-white hover:bg-red-700">
                        <span class="icon">‚úï</span>
                        <span class="label">Deletar</span>
                    </button>
                    <button onclick="aprovarPropriedade()" class="bg-green-600 text-white hover:bg-green-700">
                        <span class="icon">‚úì</span>
                        <span class="label">Aprovar</span>
                    </button>
                    <button onclick="anteriorPropriedade()" class="bg-blue-500 text-white hover:bg-blue-600">
                        <span class="icon">‚¨Ö</span>
                        <span class="label">Anterior</span>
                    </button>
                    <button onclick="proximaPropriedade()" class="bg-blue-600 text-white hover:bg-blue-700">
                        <span class="icon">‚û°</span>
                        <span class="label">Pr√≥xima</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Se√ß√£o 2: Detalhes Adicionais -->
        <div class="bg-white rounded-lg shadow-lg p-4 mb-3">
            <h2 class="text-lg font-bold text-gray-800 mb-3">üìä Detalhes Adicionais</h2>
            <div class="grid grid-cols-3 gap-6 text-sm">
                <!-- Coluna 1 -->
                <div class="space-y-3">
                    <div class="pb-2 border-b border-gray-300">
                        <h3 class="text-base font-bold text-gray-700">Parcel Number:</h3>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="font-semibold" id="prop-parcel-2">-</span>
                            <button onclick="copyParcelNumber()" class="text-blue-600 hover:text-blue-800 transition-colors text-xs" title="Copiar Parcel #">
                                üìã
                            </button>
                        </div>
                    </div>
                    <div>
                        <span class="text-gray-600 text-xs font-medium">Case (CS):</span>
                        <span class="font-semibold ml-2" id="prop-cs-2">-</span>
                    </div>
                    <div>
                        <span class="text-gray-600 text-xs font-medium">PIN/PPIN:</span>
                        <span class="font-semibold ml-2" id="prop-pin-2">-</span>
                    </div>
                    <div>
                        <span class="text-gray-600 text-xs font-medium">Certificate #:</span>
                        <span class="font-semibold ml-2" id="prop-cert-2">-</span>
                    </div>
                    <div>
                        <span class="text-gray-600 text-xs font-medium">Account #:</span>
                        <span class="font-semibold ml-2" id="prop-account-2">-</span>
                    </div>
                </div>
                
                <!-- Coluna 2 -->
                <div class="space-y-2">
                    <div>
                        <span class="text-gray-600 text-xs font-medium">üèûÔ∏è Land Value:</span>
                        <span class="font-semibold ml-2 text-green-600" id="prop-land-value-2">-</span>
                    </div>
                    <div>
                        <span class="text-gray-600 text-xs font-medium">üè† Improvements:</span>
                        <span class="font-semibold ml-2 text-green-600" id="prop-improvements-2">-</span>
                    </div>
                    <div>
                        <span class="text-gray-600 text-xs font-medium">Total Value:</span>
                        <span class="font-semibold ml-2 text-green-600" id="prop-total-value-2">-</span>
                    </div>
                </div>
                
                <!-- Coluna 3 -->
                <div class="space-y-2">
                    <div>
                        <span class="text-gray-600 text-xs font-medium">Opportunity Zone:</span>
                        <span class="font-semibold ml-2" id="prop-opportunity-zone-2">-</span>
                    </div>
                    <div>
                        <span class="text-gray-600 text-xs font-medium">Occupancy:</span>
                        <span class="font-semibold ml-2" id="prop-occupancy-2">-</span>
                    </div>
                    <div>
                        <span class="text-gray-600 text-xs font-medium">Status:</span>
                        <span class="font-semibold ml-2" id="prop-status-2">-</span>
                    </div>
                    <div>
                        <span class="text-gray-600 text-xs font-medium">Tax Years:</span>
                        <span class="font-semibold ml-2" id="prop-tax-years-2">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Se√ß√£o 2.5: An√°lise Autom√°tica de Propriedade (NOVO) -->
        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg shadow-lg p-4 mb-3 border-2 border-blue-200">
            <div class="flex items-center justify-between mb-3">
                <h2 class="text-lg font-bold text-gray-800 flex items-center">
                    <span class="text-2xl mr-2">üîç</span>
                    An√°lise Autom√°tica de Propriedade
                    <span class="ml-2 text-xs bg-blue-600 text-white px-2 py-1 rounded-full">NOVO</span>
                </h2>
                <div class="flex gap-2">
                    <button id="analyze-property-btn" onclick="analyzeCurrentProperty()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold text-sm shadow-md hover:shadow-lg">
                        üîç Analisar Propriedade
                    </button>
                    <button id="batch-analyze-btn" onclick="batchAnalyzeAll()" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-semibold text-sm shadow-md hover:shadow-lg">
                        üì¶ Analisar Todas
                    </button>
                </div>
            </div>
            <p class="text-sm text-gray-600 mb-4">
                An√°lise autom√°tica de FEMA Flood Zone, Wetlands, Land Use (Assessor) e Zoning (Planning) para qualquer condado da Florida.
            </p>
            <div id="property-analysis-widget"></div>
        </div>

        <!-- Se√ß√£o: Hist√≥rico de An√°lises -->
        <div class="bg-white rounded-lg shadow-lg p-4 mb-3">
            <h2 class="text-lg font-bold text-gray-800 mb-3">üìä Hist√≥rico de An√°lises</h2>
            <div id="history-panel"></div>
        </div>

        <!-- Se√ß√£o 3: Contact Information -->
        <div class="bg-white rounded-lg shadow-lg p-4 mb-3">
            <h2 class="text-lg font-bold text-gray-800 mb-3">üìß Contact Information</h2>
            <div class="text-sm">
                <h4 class="font-semibold text-gray-800 mb-2">Owner Address:</h4>
                <div class="space-y-1 text-gray-700">
                    <div id="owner-name-section">-</div>
                    <div id="owner-address-section">-</div>
                    <div id="owner-city-state-zip-section">-</div>
                </div>
            </div>
        </div>


        <!-- Se√ß√£o 5: An√°lise Geogr√°fica e Ambiental -->
        <div class="bg-white rounded-lg shadow-lg p-4 mb-3">
            <h2 class="text-lg font-bold text-gray-800 mb-3">üåç An√°lise Geogr√°fica e Ambiental</h2>
            <div class="space-y-4 text-sm">
                <!-- Locais Pr√≥ximos -->
                <div>
                    <h3 class="text-sm font-bold text-gray-700 mb-2">üèòÔ∏è Locais Pr√≥ximos:</h3>
                    <div class="flex gap-6" id="nearby-places-section">
                        <div>üè´ <span id="schools-count-section">-</span> Escolas</div>
                        <div>üè• <span id="hospitals-count-section">-</span> Hospitais</div>
                        <div>üõí <span id="supermarkets-count-section">-</span> Supermercados</div>
                        <div>üå≥ <span id="parks-count-section">-</span> Parques</div>
                    </div>
                </div>
                
                <!-- Eleva√ß√£o do Terreno (USGS) -->
                <div>
                    <h3 class="text-sm font-bold text-gray-700 mb-2">üèîÔ∏è Eleva√ß√£o e Topografia (USGS):</h3>
                    <div class="bg-gray-50 rounded-lg p-3 space-y-2" id="elevation-info-section">
                        <div class="flex items-center gap-2">
                            <span class="text-gray-600 text-xs">‚õ∞Ô∏è Altitude:</span>
                            <span class="font-semibold text-sm" id="elevation-value-section">‚è≥ Carregando...</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-gray-600 text-xs">üíß Risco de Inunda√ß√£o:</span>
                            <span class="font-semibold text-sm" id="flood-risk-section">-</span>
                        </div>
                        <div class="text-xs text-gray-500" id="elevation-description">
                            Aguardando dados...
                        </div>
                        <div class="text-xs text-gray-400">
                            üìå Fonte: USGS Elevation API (Resolu√ß√£o: 1 metro)
                        </div>
                    </div>
                </div>
                
                <!-- FEMA Flood Risk -->
                <div>
                    <h3 class="text-sm font-bold text-gray-700 mb-2">üåä FEMA Flood Risk:</h3>
                    <div id="fema-flood-content-section">
                        <p class="text-gray-600 text-sm">üí° Os dados FEMA ser√£o carregados automaticamente quando dispon√≠veis</p>
                    </div>
                </div>
                
                <!-- Explica√ß√£o Inteligente de Flood Zone -->
                <div id="flood-zone-explanation-section" style="display: none;">
                    <!-- Ser√° preenchido dinamicamente via JavaScript -->
                </div>
                

            </div>
        </div>


        <!-- Se√ß√£o 6: An√°lise de Constru√ß√µes (OpenStreetMap) -->
        <div class="bg-white rounded-lg shadow-lg p-4 mb-3">
            <h2 class="text-lg font-bold text-gray-800 mb-3">üè≠ An√°lise de Constru√ß√µes (OpenStreetMap)</h2>
            <div class="space-y-4 text-sm">
                <!-- Resumo da Constru√ß√£o -->
                <div class="bg-green-50 p-3 rounded-lg">
                    <h3 class="text-sm font-bold text-gray-700 mb-2">üìä Resumo da Constru√ß√£o:</h3>
                    <div class="grid grid-cols-2 gap-x-6 gap-y-2">
                        <div>
                            <span class="text-gray-600 text-xs">‚úÖ Status:</span>
                            <span class="font-semibold ml-2" id="osm-status">‚è≥ Carregando...</span>
                        </div>
                        <div>
                            <span class="text-gray-600 text-xs">üè† Tipo:</span>
                            <span class="font-semibold ml-2" id="osm-type">‚è≥ Carregando...</span>
                        </div>
                        <div>
                            <span class="text-gray-600 text-xs">üìè √Årea Constru√≠da:</span>
                            <span class="font-semibold ml-2" id="osm-area">‚è≥ Carregando...</span>
                        </div>
                        <div>
                            <span class="text-gray-600 text-xs">üìä Andares:</span>
                            <span class="font-semibold ml-2" id="osm-floors">‚è≥ Carregando...</span>
                        </div>
                        <div>
                            <span class="text-gray-600 text-xs">üìê Taxa de Ocupa√ß√£o:</span>
                            <span class="font-semibold ml-2" id="osm-coverage">‚è≥ Carregando...</span>
                        </div>
                        <div>
                            <span class="text-gray-600 text-xs">üå≥ √Årea Livre:</span>
                            <span class="font-semibold ml-2" id="osm-free-area">‚è≥ Carregando...</span>
                        </div>
                        <div>
                            <span class="text-gray-600 text-xs">üí∞ Valor Estimado:</span>
                            <span class="font-semibold ml-2" id="osm-value">‚è≥ Carregando...</span>
                        </div>
                        <div>
                            <span class="text-gray-600 text-xs">üìÖ Dados atualizados:</span>
                            <span class="font-semibold ml-2" id="osm-updated">‚è≥ Carregando...</span>
                        </div>
                    </div>
                    <div class="text-xs text-gray-500 mt-2">
                        üìå Fonte: OpenStreetMap via Overpass API
                    </div>
                </div>

                <!-- An√°lise de Aproveitamento -->
                <div>
                    <h3 class="text-sm font-bold text-gray-700 mb-2">‚úÖ Potencial de Expans√£o:</h3>
                    <ul class="list-disc list-inside text-gray-700 space-y-1 text-xs" id="osm-expansion-potential">
                        <li>‚è≥ Carregando...</li>
                    </ul>
                </div>

                <!-- Compara√ß√£o com Vizinhos -->
                <div class="bg-blue-50 p-3 rounded-lg">
                    <h3 class="text-sm font-bold text-gray-700 mb-2">üèûÔ∏è Compara√ß√£o com Vizinhos (OSM):</h3>
                    <div id="osm-neighbor-comparison">‚è≥ Carregando...</div>
                </div>
            </div>
        </div>

        <!-- Se√ß√£o 7: An√°lise Demogr√°fica (Census Bureau) -->
        <div class="bg-white rounded-lg shadow-lg p-4 mb-3">
            <h2 class="text-lg font-bold text-gray-800 mb-3">üìä An√°lise Demogr√°fica (Census Bureau)</h2>
            <div class="space-y-4 text-sm">
                <!-- Dados da Vizinhan√ßa -->
                <div class="bg-purple-50 p-3 rounded-lg">
                    <h3 class="text-sm font-bold text-gray-700 mb-2">üèûÔ∏è Dados da Vizinhan√ßa:</h3>
                    <div class="grid grid-cols-3 gap-x-4 gap-y-2 text-xs">
                        <div>
                            <span class="text-gray-600">üìç Bloco Censit√°rio:</span>
                            <span class="font-semibold ml-2" id="census-block">‚è≥ Carregando...</span>
                        </div>
                        <div>
                            <span class="text-gray-600">üìä Tract:</span>
                            <span class="font-semibold ml-2" id="census-tract">‚è≥ Carregando...</span>
                        </div>
                        <div>
                            <span class="text-gray-600">üèõÔ∏è Condado:</span>
                            <span class="font-semibold ml-2" id="census-county">‚è≥ Carregando...</span>
                        </div>
                    </div>
                    <div class="text-xs text-gray-500 mt-2">
                        üìå Fonte: US Census Bureau TIGER/Line
                    </div>
                </div>

                <!-- Popula√ß√£o -->
                <div>
                    <h3 class="text-sm font-bold text-gray-700 mb-2">üë• Popula√ß√£o (raio 500m):</h3>
                    <div id="census-population">‚è≥ Carregando...</div>
                </div>

                <!-- Economia -->
                <div>
                    <h3 class="text-sm font-bold text-gray-700 mb-2">üíµ Economia:</h3>
                    <div id="census-income">‚è≥ Carregando...</div>
                </div>

                <!-- Crescimento -->
                <div>
                    <h3 class="text-sm font-bold text-gray-700 mb-2">üìà Crescimento e Tend√™ncias:</h3>
                    <div id="census-growth">‚è≥ Carregando...</div>
                </div>

                <!-- Habita√ß√£o -->
                <div>
                    <h3 class="text-sm font-bold text-gray-700 mb-2">üè† Habita√ß√£o:</h3>
                    <div id="census-housing">‚è≥ Carregando...</div>
                </div>

                <!-- An√°lise de Investimento -->
                <div class="bg-yellow-50 p-3 rounded-lg">
                    <h3 class="text-sm font-bold text-gray-700 mb-2">üéØ An√°lise de Investimento:</h3>
                    <div id="census-investment">‚è≥ Carregando...</div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="bg-white rounded-lg shadow-lg p-2">
            <div class="flex items-center justify-between gap-4">
                <div class="flex items-center gap-4">
                    <button id="prev-property" class="px-4 py-1.5 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors font-semibold text-sm">
                        ‚óÑ Anterior
                    </button>
                    <span class="text-gray-700 font-semibold text-sm" id="property-nav">Propriedade 1 de 1</span>
                    <button id="next-property" class="px-4 py-1.5 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors font-semibold text-sm">
                        Pr√≥xima ‚ñ∫
                    </button>
                </div>
                <button onclick="removerPropriedade()" class="px-4 py-1.5 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-semibold text-sm">
                    üóëÔ∏è Remover
                </button>
            </div>
        </div>
    </div>

    <!-- Load Google Maps API -->
    <script>
        // Load API key from server
        console.log('Loading Google Maps API key...');
        fetch('/api/google-maps-key')
            .then(r => r.json())
            .then(data => {
                console.log('API Key received:', data.key ? 'Yes' : 'No');
                window.googleMapsApiKey = data.key; // Save for later use
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${data.key}&libraries=places&callback=initMaps`;
                script.async = true;
                script.defer = true;
                script.onerror = () => console.error('Failed to load Google Maps API');
                script.onload = () => console.log('Google Maps API loaded successfully');
                document.head.appendChild(script);
            })
            .catch(err => console.error('Error fetching API key:', err));
    </script>

    <script src="fetch-timeout.js"></script>
    <script src="arcgis-hub-api.js"></script>
    <script src="overpass-osm-api.js"></script>
    <script src="census-tiger-api.js"></script>
    
    <script>
        // Global variables (window scope for cross-script access)
        window.properties = [];
        window.currentIndex = 0;
        window.satelliteMap = null;
        window.streetView = null;
        window.terrainMap = null;
        window.normalMap = null;
        window.placesService = null;
        window.zillowPhotos = [];
        window.realtorPhotos = [];
        window.zillowPhotoIndex = 0;
        window.realtorPhotoIndex = 0;
        window.googleMapsApiKey = '';
        
        // üì¶ SISTEMA DE CACHE DE IMAGENS POR PROPRIEDADE
        // Armazena estado das imagens carregadas para cada propriedade
        window.propertyCache = {};
        
        function getCacheKey(index) {
            return `property_${index}`;
        }
        
        function savePropertyCache(index) {
            const key = getCacheKey(index);
            
            // üíæ Verificar quais mapas foram carregados (n√£o t√™m bot√£o)
            const satelliteEl = document.getElementById('satellite-map');
            const satelliteMapLoaded = satelliteEl && !satelliteEl.querySelector('button');
            
            const streetViewEl = document.getElementById('street-view');
            const streetViewLoaded = streetViewEl && !streetViewEl.querySelector('button');
            
            const terrainEl = document.getElementById('terrain-map-view');
            const terrainMapLoaded = terrainEl && !terrainEl.querySelector('button');
            
            const normalEl = document.getElementById('normal-map-view');
            const normalMapLoaded = normalEl && !normalEl.querySelector('button');
            
            window.propertyCache[key] = {
                satelliteMapLoaded: satelliteMapLoaded, // üõ∞Ô∏è Estado booleano
                streetViewLoaded: streetViewLoaded,     // üåç Estado booleano
                terrainMapLoaded: terrainMapLoaded,     // üèûÔ∏è Estado booleano
                normalMapLoaded: normalMapLoaded,       // üó∫Ô∏è Estado booleano
                timestamp: Date.now()
            };
            console.log('üíæ Cache salvo para propriedade', index, window.propertyCache[key]);
        }
        
        function loadPropertyCache(index) {
            const key = getCacheKey(index);
            const cache = window.propertyCache[key];
            
            if (!cache) {
                console.log('‚ùå Sem cache para propriedade', index);
                return false;
            }
            
            console.log('‚úÖ Restaurando cache para propriedade', index);
            
            // Restaurar Satellite Map
            if (cache.satelliteMapLoaded) {
                console.log('üõ∞Ô∏è Satellite Map foi carregado anteriormente, recriando...');
                const satelliteEl = document.getElementById('satellite-map');
                if (satelliteEl && window.currentLocation) {
                    satelliteEl.innerHTML = ''; // Limpar
                    initSatelliteMap(window.currentLocation);
                }
            }
            
            // Restaurar Street View
            if (cache.streetViewLoaded) {
                console.log('üåç Street View foi carregado anteriormente, recriando...');
                const streetViewEl = document.getElementById('street-view');
                if (streetViewEl && window.currentLocation) {
                    streetViewEl.innerHTML = ''; // Limpar
                    initStreetView(window.currentLocation);
                }
            }
            
            // Restaurar Terrain Map
            if (cache.terrainMapLoaded) {
                console.log('üèûÔ∏è Terrain Map foi carregado anteriormente, recriando...');
                const terrainEl = document.getElementById('terrain-map-view');
                if (terrainEl && window.currentLocation) {
                    terrainEl.innerHTML = ''; // Limpar
                    initTerrainMap(window.currentLocation);
                }
            }
            
            // Restaurar Normal Map
            if (cache.normalMapLoaded) {
                console.log('üó∫Ô∏è Normal Map foi carregado anteriormente, recriando...');
                const normalEl = document.getElementById('normal-map-view');
                if (normalEl && window.currentLocation) {
                    normalEl.innerHTML = ''; // Limpar
                    initNormalMap(window.currentLocation);
                }
            }
            
            return true;
        }
        
        function reattachMapEventListeners(element, type) {
            // Se o elemento tem um bot√£o "Carregar Imagem", reattach o event listener
            const button = element.querySelector('button');
            
            if (!button) {
                console.log('‚ö†Ô∏è Nenhum bot√£o encontrado em', type);
                return;
            }
            
            const buttonText = button.textContent || button.innerHTML;
            console.log('üîç Bot√£o encontrado:', type, buttonText);
            
            // Detectar bot√µes "Carregar Imagem" (com ou sem emoji)
            if (buttonText.includes('Carregar Imagem') || buttonText.includes('Carregar')) {
                console.log('‚úÖ Reattaching event listener para', type);
                
                // Remover listeners antigos (se existirem)
                const newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);
                
                // Adicionar novo event listener
                newButton.addEventListener('click', function() {
                    console.log('üëÜ Bot√£o clicado:', type);
                    
                    if (!window.currentLocation) {
                        console.error('‚ùå window.currentLocation n√£o definido!');
                        return;
                    }
                    
                    this.innerHTML = '‚è≥ Carregando...';
                    this.disabled = true;
                    
                    console.log('üìç Carregando mapa:', type, window.currentLocation);
                    
                    if (type === 'satellite') {
                        initSatelliteMap(window.currentLocation);
                    } else if (type === 'streetview') {
                        initStreetView(window.currentLocation);
                    } else if (type === 'terrain') {
                        initTerrainMap(window.currentLocation);
                    } else if (type === 'normal') {
                        initNormalMap(window.currentLocation);
                    }
                    
                    setTimeout(() => {
                        this.remove();
                        // Salvar cache ap√≥s carregar
                        console.log('üíæ Salvando cache ap√≥s carregar', type);
                        savePropertyCache(window.currentIndex);
                    }, 1500);
                });
            } else {
                console.log('‚ö†Ô∏è Bot√£o n√£o √© "Carregar Imagem":', buttonText);
            }
        }
        
        // Aliases for easier access
        let properties = window.properties;
        let currentIndex = window.currentIndex;
        let satelliteMap = window.satelliteMap;
        let streetView = window.streetView;
        let terrainMap = window.terrainMap;
        let normalMap = window.normalMap;
        let placesService = window.placesService;
        let zillowPhotos = window.zillowPhotos;
        let realtorPhotos = window.realtorPhotos;
        let zillowPhotoIndex = window.zillowPhotoIndex;
        let realtorPhotoIndex = window.realtorPhotoIndex;
        let googleMapsApiKey = window.googleMapsApiKey;

        // Load properties from localStorage
        console.log('=== SCRIPT CARREGADO ===');
        
        console.log('üöÄ SCRIPT ANALYSIS.HTML CARREGADO!');
        console.log('document.readyState:', document.readyState);
        
        function initializeApp() {
            console.log('=== initializeApp CHAMADO ===');
            const stored = localStorage.getItem('selectedProperties');
            console.log('stored:', stored ? 'TEM DADOS' : 'VAZIO');
            if (!stored) {
                alert('Nenhuma propriedade selecionada. Redirecionando...');
                window.location.href = '/';
                return;
            }

            window.properties = JSON.parse(stored);
            properties = window.properties;
            console.log('Loaded properties:', properties);
            
            document.getElementById('propertyCount').textContent = `${properties.length} propriedade(s) selecionada(s)`;
            
            // Setup tab switching
            setupTabs();
            
            // Setup navigation
            setupNavigation();
            
            // CORRE√á√ÉO: Carregar propriedade IMEDIATAMENTE, n√£o esperar Google Maps
            console.log('Loading first property immediately...');
            loadProperty(0);
            
            // Google Maps ser√° inicializado quando o script carregar (callback=initMaps)
            // Se j√° estiver carregado, initMaps ser√° chamado automaticamente
            
            // Initialize Property Analysis Widget
            initializePropertyAnalysisWidget();
        }
        
        // Call immediately if DOM is ready, otherwise wait
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            // DOM already loaded
            initializeApp();
        }

        function setupTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Remove active class from all
                    tabButtons.forEach(b => b.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));

                    // Add active class to clicked
                    button.classList.add('active');
                    const tabId = button.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            // ATIVAR ABA GOOGLE MAPS AUTOMATICAMENTE ao carregar p√°gina
            // Isso faz com que os mapas apare√ßam logo ao abrir a an√°lise
            const googleMapsTab = document.querySelector('[data-tab="google-maps"]');
            const googleMapsContent = document.getElementById('google-maps');
            
            if (googleMapsTab && googleMapsContent) {
                // Remover active de todas as tabs primeiro
                tabButtons.forEach(b => b.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                
                // Ativar Google Maps
                googleMapsTab.classList.add('active');
                googleMapsContent.classList.add('active');
                
                console.log('‚úÖ Aba Google Maps ativada automaticamente!');
            }
        }

        function setupNavigation() {
            document.getElementById('prev-property').addEventListener('click', () => {
                if (currentIndex > 0) {
                    currentIndex--;
                    loadProperty(currentIndex);
                }
            });

            document.getElementById('next-property').addEventListener('click', () => {
                if (currentIndex < properties.length - 1) {
                    currentIndex++;
                    loadProperty(currentIndex);
                }
            });

            // Photo navigation
            document.getElementById('zillow-prev').addEventListener('click', () => {
                if (zillowPhotoIndex > 0) {
                    zillowPhotoIndex--;
                    showZillowPhoto(zillowPhotoIndex);
                }
            });

            document.getElementById('zillow-next').addEventListener('click', () => {
                if (zillowPhotoIndex < zillowPhotos.length - 1) {
                    zillowPhotoIndex++;
                    showZillowPhoto(zillowPhotoIndex);
                }
            });

            document.getElementById('realtor-prev').addEventListener('click', () => {
                if (realtorPhotoIndex > 0) {
                    realtorPhotoIndex--;
                    showRealtorPhoto(realtorPhotoIndex);
                }
            });

            document.getElementById('realtor-next').addEventListener('click', () => {
                if (realtorPhotoIndex < realtorPhotos.length - 1) {
                    realtorPhotoIndex++;
                    showRealtorPhoto(realtorPhotoIndex);
                }
            });
        }

        window.initMaps = function() {
            console.log('‚úÖ Google Maps API carregado com sucesso!');
            // Propriedade j√° foi carregada em initializeApp()
            // Os mapas ser√£o inicializados automaticamente quando necess√°rio
        }

        function loadProperty(index) {
            try {
                console.log('=== loadProperty CHAMADO ===');
                console.log('Index:', index);
                console.log('Total properties:', properties.length);
                
                if (!properties || properties.length === 0) {
                    throw new Error('Nenhuma propriedade dispon√≠vel!');
                }
                
                if (index < 0 || index >= properties.length) {
                    throw new Error(`√çndice inv√°lido: ${index}`);
                }
                
                const prop = properties[index];
                console.log('Loading property:', prop);
                
                if (!prop) {
                    throw new Error('Propriedade √© null ou undefined!');
                }

            // Update navigation
            document.getElementById('property-nav').textContent = `Propriedade ${index + 1} de ${properties.length}`;
            document.getElementById('prev-property').disabled = index === 0;
            document.getElementById('next-property').disabled = index === properties.length - 1;
            
            // Atualizar progresso
            atualizarProgresso();
            
            // üì¶ SALVAR CACHE DA PROPRIEDADE ANTERIOR
            // Usar window.currentIndex (global) em vez de currentIndex (local)
            if (window.currentIndex !== index && window.currentIndex >= 0) {
                console.log('üíæ Salvando cache da propriedade anterior:', window.currentIndex);
                savePropertyCache(window.currentIndex);
            }
            
            // Atualizar currentIndex
            currentIndex = index;
            window.currentIndex = index;
            
            // üîÑ RESETAR widget de an√°lise autom√°tica ao trocar de propriedade
            if (propertyAnalysisWidget) {
                propertyAnalysisWidget.reset();
                console.log('üîÑ Widget de an√°lise resetado para nova propriedade');
            }
            
            // ‚ö†Ô∏è Cache ser√° carregado DEPOIS de window.currentLocation ser definida

            // Format fields
            const acres = prop['Acres'] ? `${parseFloat(prop['Acres']).toFixed(2)} acres` : '-';
            const sqft = prop['Square Feet'] ? `${parseInt(prop['Square Feet']).toLocaleString('en-US')} sq ft` : '-';
            
            // Format coordinates (round to 4 decimals)
            let coordinates = '-';
            let lat = null, lng = null;
            if (prop['Coordinates']) {
                const coords = prop['Coordinates'].split(',').map(c => parseFloat(c.trim()));
                if (coords.length === 2) {
                    lat = coords[0];
                    lng = coords[1];
                    coordinates = coords.map(c => c.toFixed(4)).join(', ');
                    
                    // FEMA agora √© manual (bot√£o) para economizar cr√©ditos RapidAPI
                    console.log('üåä FEMA dispon√≠vel para carregamento manual:', lat, lng);
                }
            }
            
            // Format county with Appraisal link (async)
            const countyName = prop['County'] || '';
            
            // Set county name first (will be updated with link when API responds)
            document.getElementById('prop-county-1').textContent = countyName;
            
            // Get county link asynchronously and update
            getCountyAppraisalLink(countyName).then(countyLink => {
                if (countyLink) {
                    document.getElementById('prop-county-1').innerHTML = `${countyName} (<a href="${countyLink}" target="_blank" class="text-blue-600 hover:underline">Appraisal</a>)`;
                }
            }).catch(err => {
                console.error('Error loading county link:', err);
            });
            
            // Format Amount Due with $ (American format)
            let amountDue = '-';
            if (prop['Amount Due']) {
                const numericValue = parseFloat(prop['Amount Due'].replace(/[$,]/g, ''));
                if (!isNaN(numericValue)) {
                    amountDue = new Intl.NumberFormat('en-US', {
                        style: 'currency',
                        currency: 'USD',
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    }).format(numericValue);
                }
            }
            
            // Format Address with FL + Zip
            const fullAddress = `${prop['Address']}, ${prop['City']}, FL ${prop['Zip'] || ''}`;
            window.currentAddress = fullAddress; // Store for copy function
            const nextAuction = prop['Next Auction'] || '-';
            
            // Legal Description
            const legalFull = prop['Legal Description'] || '-';
            
            // SE√á√ÉO 1: Informa√ß√µes da Propriedade (IP)
            document.getElementById('prop-parcel-1').textContent = prop['Parcel Number'];
            document.getElementById('prop-acres-1').textContent = acres;
            // County is set above (async)
            document.getElementById('prop-sqft-1').textContent = sqft;
            document.getElementById('prop-coordinates-1').textContent = coordinates;
            window.currentCoordinates = coordinates; // Store for copy function
            document.getElementById('prop-zoning-1').textContent = prop['Zoning'] || '-';
            document.getElementById('prop-next-auction-1').textContent = nextAuction;
            document.getElementById('prop-owner-1').textContent = prop['Name'];
            document.getElementById('prop-amount-1').textContent = amountDue;
            document.getElementById('prop-address-full-1').textContent = fullAddress;
            window.currentAddress = fullAddress; // Store for copy function
            document.getElementById('prop-type-1').textContent = prop['Parcel Type'];
            // prop-zip-1 removido - Zip j√° est√° inclu√≠do no fullAddress
            document.getElementById('prop-legal-1').textContent = legalFull;
            window.currentLegalDescription = legalFull; // Store for copy function
            
            // SE√á√ÉO 2: Detalhes Adicionais
            document.getElementById('prop-parcel-2').textContent = prop['Parcel Number'];
            
            // Remove quotes from Case (CS)
            const caseCS = prop['CS'] ? prop['CS'].replace(/['‚Äú‚Äù]/g, '') : '-';
            document.getElementById('prop-cs-2').textContent = caseCS;
            
            document.getElementById('prop-pin-2').textContent = '-'; // Placeholder
            document.getElementById('prop-cert-2').textContent = '-'; // Placeholder
            document.getElementById('prop-account-2').textContent = '-'; // Placeholder
            document.getElementById('prop-land-value-2').textContent = prop['Land'] || '-';
            document.getElementById('prop-improvements-2').textContent = prop['Improvements'] || '-';
            
            // Total Value with icon
            const totalValue = prop['Total Value'] ? `üí∞ ${prop['Total Value']}` : '-';
            document.getElementById('prop-total-value-2').textContent = totalValue;
            
            // Opportunity Zone with checkmark
            const oppZone = prop['Opportunity Zone'] ? `‚úÖ ${prop['Opportunity Zone']}` : '-';
            document.getElementById('prop-opportunity-zone-2').textContent = oppZone;
            
            // Occupancy with icon
            let occupancy = prop['Occupancy'] || '-';
            if (occupancy.toLowerCase().includes('occupied')) {
                occupancy = `üè† ${occupancy}`;
            } else if (occupancy.toLowerCase().includes('vacant')) {
                occupancy = `‚ö™ ${occupancy}`;
            }
            document.getElementById('prop-occupancy-2').textContent = occupancy;
            
            // Status with icon
            const status = prop['Status'] ? `üìÑ ${prop['Status']}` : '-';
            document.getElementById('prop-status-2').textContent = status;
            
            // Tax Years grouped
            const taxSaleYear = prop['Tax Sale Year'] || '-';
            const delinquentYear = prop['Delinquent Year'] || '-';
            const taxYears = `Tax Sale: ${taxSaleYear} | Delinquent Since: ${delinquentYear}`;
            document.getElementById('prop-tax-years-2').textContent = taxYears;
            
            // SE√á√ÉO 3: Contact Information
            document.getElementById('owner-name-section').textContent = prop['Owner Name'] || prop['Name'] || '-';
            document.getElementById('owner-address-section').textContent = prop['Owner Address'] || '-';
            const ownerCityStateZipSection = `${prop['Owner City'] || ''}, ${prop['Owner State'] || ''} ${prop['Owner Zip'] || ''}`.trim();
            document.getElementById('owner-city-state-zip-section').textContent = ownerCityStateZipSection || '-';

            
            // Update Research Links
            // updateResearchLinks(prop); // COMENTADO - elementos n√£o existem mais (aba Research removida)

            // Geocode address and load maps
            // Verificar se Google Maps j√° est√° carregado antes de usar
            if (typeof google !== 'undefined' && google.maps) {
                geocodeAndLoadMaps(prop);
            } else {
                console.warn('‚ö†Ô∏è Google Maps ainda n√£o carregou. Aguardando...');
                // Tentar novamente ap√≥s 2 segundos
                setTimeout(() => {
                    if (typeof google !== 'undefined' && google.maps) {
                        geocodeAndLoadMaps(prop);
                    } else {
                        console.error('‚ùå Google Maps n√£o carregou ap√≥s timeout');
                    }
                }, 2000);
            }
            
            // Load NAIP aerial image
            loadNAIPImage(prop);
            
            // Atualizar contador de aprovadas
            atualizarContadorAprovadas();
            
            console.log('‚úÖ Propriedade carregada com sucesso!');
            
        } catch (error) {
            console.error('‚ùå ERRO em loadProperty:', error);
            
            // S√≥ redirecionar se realmente n√£o houver dados
            const stored = localStorage.getItem('selectedProperties');
            if (!stored || stored === '[]' || stored === 'null') {
                console.warn('‚ö†Ô∏è Sem dados v√°lidos no localStorage. Redirecionando...');
                window.location.href = 'index.html';
            } else {
                // Dados existem, mas houve erro ao renderizar
                // Log o erro mas deixa a p√°gina tentar continuar
                console.warn('‚ö†Ô∏è Erro ao renderizar, mas dados existem. Continuando...');
            }
        }
    }

        function geocodeAndLoadMaps(prop) {
            // üéØ VERIFICA√á√ÉO: Usar coordenadas do CSV se dispon√≠veis (evita geocoding)
            const lat = parseFloat(prop['Latitude'] || prop['Lat'] || prop['lat'] || prop['latitude']);
            const lng = parseFloat(prop['Longitude'] || prop['Lng'] || prop['lng'] || prop['longitude'] || prop['Lon'] || prop['lon']);
            
            // Se tem coordenadas v√°lidas, usar direto (sem geocoding)
            if (!isNaN(lat) && !isNaN(lng) && lat !== 0 && lng !== 0) {
                console.log('‚úÖ Usando coordenadas do CSV:', lat, lng);
                const location = new google.maps.LatLng(lat, lng);
                processLocation(location, prop);
                return;
            }
            
            // Se n√£o tem coordenadas, tentar geocoding do endere√ßo
            const address = `${prop['Address']}, ${prop['City']}, FL`;
            console.log('üìç Tentando geocoding do endere√ßo:', address);

            const geocoder = new google.maps.Geocoder();
            geocoder.geocode({ address: address }, (results, status) => {
                if (status === 'OK') {
                    const location = results[0].geometry.location;
                    console.log('‚úÖ Geocoded location:', location.toString());
                    processLocation(location, prop);
                } else {
                    console.error('‚ùå Geocoding failed:', status);
                    alert('N√£o foi poss√≠vel localizar o endere√ßo no mapa. Verifique se o CSV tem coordenadas (Latitude/Longitude).');
                }
            });
        }
        
        // üìç Fun√ß√£o auxiliar para processar localiza√ß√£o (usada por coordenadas diretas ou geocoding)
        function processLocation(location, prop) {
            // üíæ Salvar localiza√ß√£o para uso posterior (carregamento sob demanda)
            window.currentLocation = location;
            window.currentProp = prop;
            
            // üì¶ AGORA CARREGAR CACHE (depois de window.currentLocation estar definida)
            const cacheLoaded = loadPropertyCache(window.currentIndex);
            
            // Se n√£o tem cache, resetar para bot√µes "Carregar Imagem"
            if (!cacheLoaded) {
                console.log('üÜï Sem cache, resetando mapas...');
                resetAllMaps();
            }
            
            // ‚úÖ Carregar apenas dados que N√ÉO usam Google Maps API (gratuitos)
            // initSatelliteMap(location); // ‚ùå Desabilitado - carregar sob demanda
            // initStreetView(location); // ‚ùå Desabilitado - carregar sob demanda
            // initTerrainMap(location); // ‚ùå Desabilitado - carregar sob demanda
            // initNormalMap(location); // ‚ùå Desabilitado - carregar sob demanda
            loadNearbyPlaces(location);
            loadElevation(location);
            loadLandUse(location);
            loadFemaFlood(location);
            loadWaterProximity(location);
            loadUSGSElevation(location.lat(), location.lng());
            loadUSGSWaterBodies(location.lat(), location.lng());
            createGoogleEarthLink(location);
            
            // ArcGIS Hub removido (fun√ß√£o n√£o existe)
            
            // Load OSM building data
            const parcelSqft = parseFloat(prop['Square Feet']?.replace(/,/g, '')) || 0;
            loadOSMData(location.lat(), location.lng(), parcelSqft);
            
            // Load Census demographic data
            loadCensusData(location.lat(), location.lng());
            
            // ‚ùå Fotos desabilitadas - carregar sob demanda
            // loadZillowPhotos(prop);
            // loadRealtorPhotos(prop);
        }

        function initSatelliteMap(location) {
            console.log('üõ∞Ô∏è Inicializando Satellite Map para:', location);
            
            // üî• FOR√áAR RECRIA√á√ÉO (n√£o reutilizar objeto antigo)
            satelliteMap = null;
            window.satelliteMap = null;
            
            // Criar novo mapa
            satelliteMap = new google.maps.Map(document.getElementById('satellite-map'), {
                center: location,
                zoom: 18,
                mapTypeId: 'satellite'
            });
            
            window.satelliteMap = satelliteMap;

            // Add marker
            new google.maps.Marker({
                position: location,
                map: satelliteMap,
                title: 'Propriedade'
            });
            
            console.log('‚úÖ Satellite Map criado com sucesso');
            
            // üì¶ Salvar cache ap√≥s carregar
            setTimeout(() => savePropertyCache(window.currentIndex), 1500);
        }

        function initStreetView(location) {
            console.log('üåç Inicializando Street View para:', location);
            
            // üî• FOR√áAR RECRIA√á√ÉO
            streetView = null;
            window.streetView = null;
            
            streetView = new google.maps.StreetViewPanorama(
                document.getElementById('street-view'),
                {
                    position: location,
                    pov: { heading: 165, pitch: 0 },
                    zoom: 1
                }
            );
            
            window.streetView = streetView;
            
            console.log('‚úÖ Street View criado com sucesso');
            
            // üì¶ Salvar cache ap√≥s carregar
            setTimeout(() => savePropertyCache(window.currentIndex), 1500);
        }

        function initTerrainMap(location) {
            console.log('üèûÔ∏è Inicializando Terrain Map para:', location);
            
            // üî• FOR√áAR RECRIA√á√ÉO
            terrainMap = null;
            window.terrainMap = null;
            
            terrainMap = new google.maps.Map(document.getElementById('terrain-map-view'), {
                center: location,
                zoom: 15,
                mapTypeId: 'terrain',
                mapTypeControl: true
            });
            
            window.terrainMap = terrainMap;

            new google.maps.Marker({
                position: location,
                map: terrainMap
            });
            
            console.log('‚úÖ Terrain Map criado com sucesso');
            
            // üì¶ Salvar cache ap√≥s carregar
            setTimeout(() => savePropertyCache(window.currentIndex), 1500);
        }

        function initNormalMap(location) {
            console.log('üó∫Ô∏è Inicializando Normal Map para:', location);
            
            // üî• FOR√áAR RECRIA√á√ÉO
            normalMap = null;
            window.normalMap = null;
            
            normalMap = new google.maps.Map(document.getElementById('normal-map'), {
                center: location,
                zoom: 16,
                mapTypeId: 'roadmap'
            });
            
            window.normalMap = normalMap;

            new google.maps.Marker({
                position: location,
                map: normalMap
            });
            
            console.log('‚úÖ Normal Map criado com sucesso');
            
            // üì¶ Salvar cache ap√≥s carregar
            setTimeout(() => savePropertyCache(window.currentIndex), 1500);
        }

        function loadNearbyPlaces(location) {
            if (!placesService) {
                placesService = new google.maps.places.PlacesService(satelliteMap);
            }

            // Search for schools
            placesService.nearbySearch({
                location: location,
                radius: 3000,
                type: 'school'
            }, (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    document.getElementById('schools-count-section').textContent = results.length;
                }
            });

            // Search for hospitals
            placesService.nearbySearch({
                location: location,
                radius: 5000,
                type: 'hospital'
            }, (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    document.getElementById('hospitals-count-section').textContent = results.length;
                }
            });

            // Search for supermarkets
            placesService.nearbySearch({
                location: location,
                radius: 3000,
                type: 'supermarket'
            }, (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    document.getElementById('supermarkets-count-section').textContent = results.length;
                }
            });

            // Search for parks
            placesService.nearbySearch({
                location: location,
                radius: 3000,
                type: 'park'
            }, (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    document.getElementById('parks-count-section').textContent = results.length;
                }
            });
        }

        function loadElevation(location) {
            const elevator = new google.maps.ElevationService();
            
            elevator.getElevationForLocations({
                locations: [location]
            }, (results, status) => {
                if (status === 'OK' && results[0]) {
                    const elevationMeters = results[0].elevation;
                    const elevationFeet = (elevationMeters * 3.28084).toFixed(1);
                    
                    // Display elevation
                    document.getElementById('elevation-value-section').textContent = `${elevationMeters.toFixed(1)}m (${elevationFeet}ft)`;
                    
                    // Calculate flood risk
                    let riskLevel, riskColor, riskIcon;
                    if (elevationMeters < 3) {
                        riskLevel = '‚ö†Ô∏è ALTO RISCO';
                        riskColor = 'text-red-600';
                        riskIcon = 'üö®';
                    } else if (elevationMeters < 10) {
                        riskLevel = '‚ö†Ô∏è RISCO M√âDIO';
                        riskColor = 'text-orange-600';
                        riskIcon = '‚ö†Ô∏è';
                    } else if (elevationMeters < 30) {
                        riskLevel = '‚úÖ RISCO BAIXO';
                        riskColor = 'text-yellow-600';
                        riskIcon = '‚úÖ';
                    } else {
                        riskLevel = '‚úÖ MUITO SEGURO';
                        riskColor = 'text-green-600';
                        riskIcon = '‚úÖ';
                    }
                    
                    const floodRiskEl = document.getElementById('flood-risk-section');
                    floodRiskEl.textContent = `${riskIcon} ${riskLevel}`;
                    floodRiskEl.className = `font-semibold ml-1 ${riskColor}`;
                } else {
                    document.getElementById('elevation-value-section').textContent = 'N/A';
                    document.getElementById('flood-risk-section').textContent = 'N/A';
                    console.error('Elevation request failed:', status);
                }
            });
        }

        // ============================================
        // OPENSTREETMAP OVERPASS API
        // ============================================
        
        const OSM_SERVERS = [
            'https://overpass.kumi.systems/api/interpreter',
            'https://overpass-api.de/api/interpreter',
            'https://overpass.openstreetmap.ru/api/interpreter'
        ];
        
        async function loadOSMData(lat, lng, parcelSqft) {
            console.log(`üìç Carregando dados do OpenStreetMap para: ${lat}, ${lng}`);
            
            // Verificar cache (24h)
            const cacheKey = `osm_${lat}_${lng}`;
            const cached = localStorage.getItem(cacheKey);
            if (cached) {
                const data = JSON.parse(cached);
                if (Date.now() - data.timestamp < 24 * 60 * 60 * 1000) {
                    console.log('‚úÖ Dados do OSM carregados do cache');
                    displayOSMData(data.result, parcelSqft);
                    return;
                }
            }
            
            // Buscar dados com fallback
            for (let i = 0; i < OSM_SERVERS.length; i++) {
                const server = OSM_SERVERS[i];
                console.log(`üîÑ Tentando servidor ${i + 1}/${OSM_SERVERS.length}: ${server}`);
                
                try {
                    const data = await fetchOSMDataFromServer(server, lat, lng);
                    
                    // Salvar no cache
                    localStorage.setItem(cacheKey, JSON.stringify({
                        timestamp: Date.now(),
                        result: data
                    }));
                    
                    console.log('‚úÖ Dados do OSM carregados com sucesso!');
                    displayOSMData(data, parcelSqft);
                    return;
                } catch (error) {
                    console.error(`‚ùå Erro no servidor ${i + 1}:`, error.message);
                    if (i === OSM_SERVERS.length - 1) {
                        // √öltimo servidor falhou
                        displayOSMError();
                    }
                }
            }
        }
        
        async function fetchOSMDataFromServer(server, lat, lng) {
            // Raio de busca: 50m para constru√ß√µes no terreno, 100m para vizinhos
            const query = `
                [out:json][timeout:10];
                (
                  way["building"](around:50,${lat},${lng});
                  relation["building"](around:50,${lat},${lng});
                );
                out body;
                >;
                out skel qt;
            `;
            
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s timeout
            
            try {
                const response = await fetch(server, {
                    method: 'POST',
                    body: query,
                    signal: controller.signal,
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                return data;
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    throw new Error('Timeout (10s)');
                }
                throw error;
            }
        }
        
        function displayOSMData(data, parcelSqft) {
            const buildings = data.elements.filter(el => el.type === 'way' && el.tags && el.tags.building);
            
            if (buildings.length === 0) {
                // Terreno vazio
                document.getElementById('osm-status').textContent = 'üå≥ Terreno Vazio';
                document.getElementById('osm-type').textContent = 'N/A';
                document.getElementById('osm-area').textContent = '0 m¬≤';
                document.getElementById('osm-floors').textContent = 'N/A';
                document.getElementById('osm-coverage').textContent = '0%';
                document.getElementById('osm-free-area').textContent = '100%';
                document.getElementById('osm-value').textContent = 'N/A';
                document.getElementById('osm-updated').textContent = 'N/A';
                
                // Potencial de expans√£o
                const parcelAcres = (parcelSqft / 43560).toFixed(2);
                document.getElementById('osm-expansion-potential').innerHTML = `
                    <li>‚úÖ Terreno vazio de ${parcelAcres} acres (${parcelSqft.toLocaleString()} sqft)</li>
                    <li>‚úÖ 100% dispon√≠vel para constru√ß√£o</li>
                    <li>‚úÖ Sem restri√ß√µes de constru√ß√µes existentes</li>
                `;
                
                document.getElementById('osm-neighbor-comparison').textContent = 'üå≥ Terreno vazio - sem constru√ß√µes para comparar';
                return;
            }
            
            // Analisar constru√ß√£o principal (maior √°rea)
            const mainBuilding = buildings.reduce((max, b) => {
                const area = calculateArea(b);
                const maxArea = calculateArea(max);
                return area > maxArea ? b : max;
            });
            
            const buildingArea = calculateArea(mainBuilding);
            const buildingType = mainBuilding.tags.building || 'unknown';
            const buildingLevels = mainBuilding.tags['building:levels'] || mainBuilding.tags.levels || '1';
            
            // Status
            document.getElementById('osm-status').textContent = '‚úÖ Constru√≠do';
            
            // Tipo
            const typeMap = {
                'residential': 'üè† Residencial',
                'house': 'üè† Casa',
                'apartments': 'üè¨ Apartamentos',
                'commercial': 'üè¨ Comercial',
                'retail': 'üè¨ Varejo',
                'industrial': 'üè≠ Industrial',
                'warehouse': 'üè≠ Armaz√©m',
                'yes': 'üèóÔ∏è Constru√ß√£o'
            };
            document.getElementById('osm-type').textContent = typeMap[buildingType] || `üèóÔ∏è ${buildingType}`;
            
            // √Årea
            const areaSqft = (buildingArea * 10.764).toFixed(0);
            document.getElementById('osm-area').textContent = `${buildingArea.toFixed(0)} m¬≤ (${areaSqft} sqft)`;
            
            // Andares
            document.getElementById('osm-floors').textContent = buildingLevels;
            
            // Taxa de ocupa√ß√£o
            const coverage = parcelSqft > 0 ? ((parseFloat(areaSqft) / parcelSqft) * 100).toFixed(1) : 0;
            document.getElementById('osm-coverage').textContent = `${coverage}%`;
            
            // √Årea livre
            const freeArea = (100 - parseFloat(coverage)).toFixed(1);
            document.getElementById('osm-free-area').textContent = `${freeArea}%`;
            
            // Valor estimado (simplificado)
            document.getElementById('osm-value').textContent = 'N/A (requer avalia√ß√£o)';
            
            // Data de atualiza√ß√£o
            const timestamp = mainBuilding.timestamp || 'N/A';
            document.getElementById('osm-updated').textContent = timestamp.split('T')[0] || 'N/A';
            
            // Potencial de expans√£o
            const expansionHtml = [];
            if (parseFloat(coverage) < 50) {
                expansionHtml.push(`<li>‚úÖ Taxa de ocupa√ß√£o baixa (${coverage}%) - grande potencial de expans√£o</li>`);
            } else if (parseFloat(coverage) < 80) {
                expansionHtml.push(`<li>‚ö†Ô∏è Taxa de ocupa√ß√£o m√©dia (${coverage}%) - potencial moderado</li>`);
            } else {
                expansionHtml.push(`<li>‚ùå Taxa de ocupa√ß√£o alta (${coverage}%) - pouco espa√ßo dispon√≠vel</li>`);
            }
            
            if (parseInt(buildingLevels) < 2) {
                expansionHtml.push(`<li>‚úÖ Constru√ß√£o t√©rrea - poss√≠vel adicionar andares</li>`);
            }
            
            const freeAreaSqft = (parcelSqft * (parseFloat(freeArea) / 100)).toFixed(0);
            expansionHtml.push(`<li>üå≥ √Årea livre: ${freeAreaSqft} sqft (${(freeAreaSqft / 43560).toFixed(2)} acres)</li>`);
            
            document.getElementById('osm-expansion-potential').innerHTML = expansionHtml.join('');
            
            // Compara√ß√£o com vizinhos
            if (buildings.length > 1) {
                const avgArea = buildings.reduce((sum, b) => sum + calculateArea(b), 0) / buildings.length;
                const avgAreaSqft = (avgArea * 10.764).toFixed(0);
                const comparison = buildingArea > avgArea ? 'maior' : 'menor';
                const diff = Math.abs(((buildingArea - avgArea) / avgArea) * 100).toFixed(0);
                
                document.getElementById('osm-neighbor-comparison').innerHTML = `
                    <p class="text-sm text-gray-700">
                        üèõÔ∏è <strong>${buildings.length} constru√ß√µes</strong> encontradas na √°rea<br>
                        üìä √Årea m√©dia: ${avgArea.toFixed(0)} m¬≤ (${avgAreaSqft} sqft)<br>
                        üìà Sua propriedade √© <strong>${diff}% ${comparison}</strong> que a m√©dia
                    </p>
                `;
            } else {
                document.getElementById('osm-neighbor-comparison').textContent = 'üå≥ Nenhuma constru√ß√£o vizinha encontrada (raio 50m)';
            }
        }
        
        function displayOSMError() {
            const errorMsg = '‚ùå Dados tempor√°riamente indispon√≠veis';
            document.getElementById('osm-status').textContent = errorMsg;
            document.getElementById('osm-type').textContent = 'N/A';
            document.getElementById('osm-area').textContent = 'N/A';
            document.getElementById('osm-floors').textContent = 'N/A';
            document.getElementById('osm-coverage').textContent = 'N/A';
            document.getElementById('osm-free-area').textContent = 'N/A';
            document.getElementById('osm-value').textContent = 'N/A';
            document.getElementById('osm-updated').textContent = 'N/A';
            document.getElementById('osm-expansion-potential').innerHTML = '<li>‚ùå Erro ao carregar dados do OpenStreetMap</li>';
            document.getElementById('osm-neighbor-comparison').textContent = '‚ùå Erro ao carregar dados';
        }
        
        function calculateArea(building) {
            if (!building.tags || !building.tags['way_area']) {
                // Estimar √°rea se n√£o fornecida
                return 100; // Default 100m¬≤
            }
            return parseFloat(building.tags['way_area']);
        }

        async function loadLandUse(location) {
            document.getElementById('land-use-content-section').innerHTML = '<p class="text-sm text-gray-600">‚è≥ Carregando an√°lise de uso do solo...</p>';
            
            try {
                const response = await fetchWithTimeout('/api/land-use', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        lat: location.lat(), 
                        lng: location.lng() 
                    })
                }, 10000);

                const data = await response.json();
                
                if (data.success) {
                    const { analysis } = data;
                    const { percentages, dominant, dominantIcon, details } = analysis;
                    
                    // Create visual representation
                    let html = `
                        <div class="mb-2">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-2xl">${dominantIcon}</span>
                                <span class="font-semibold text-sm">Tipo Dominante: ${dominant}</span>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2 text-xs">
                    `;
                    
                    // Forest
                    if (percentages.forest > 0) {
                        html += `
                            <div class="flex items-center gap-2">
                                <span class="text-lg">üå≥</span>
                                <div class="flex-1">
                                    <div class="flex justify-between mb-0.5">
                                        <span>Floresta/Vegeta√ß√£o</span>
                                        <span class="font-semibold">${percentages.forest}%</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-1.5">
                                        <div class="bg-green-600 h-1.5 rounded-full" style="width: ${percentages.forest}%"></div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    // Urban
                    if (percentages.urban > 0) {
                        html += `
                            <div class="flex items-center gap-2">
                                <span class="text-lg">üèòÔ∏è</span>
                                <div class="flex-1">
                                    <div class="flex justify-between mb-0.5">
                                        <span>√Årea Urbana</span>
                                        <span class="font-semibold">${percentages.urban}%</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-1.5">
                                        <div class="bg-gray-600 h-1.5 rounded-full" style="width: ${percentages.urban}%"></div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    // Water
                    if (percentages.water > 0) {
                        html += `
                            <div class="flex items-center gap-2">
                                <span class="text-lg">üíß</span>
                                <div class="flex-1">
                                    <div class="flex justify-between mb-0.5">
                                        <span>Agua/√Årea Alagada</span>
                                        <span class="font-semibold">${percentages.water}%</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-1.5">
                                        <div class="bg-blue-600 h-1.5 rounded-full" style="width: ${percentages.water}%"></div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    // Agricultural
                    if (percentages.agricultural > 0) {
                        html += `
                            <div class="flex items-center gap-2">
                                <span class="text-lg">üåæ</span>
                                <div class="flex-1">
                                    <div class="flex justify-between mb-0.5">
                                        <span>Agricultura/Campo</span>
                                        <span class="font-semibold">${percentages.agricultural}%</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-1.5">
                                        <div class="bg-yellow-600 h-1.5 rounded-full" style="width: ${percentages.agricultural}%"></div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    html += '</div>';
                    
                    // Additional details
                    if (details.buildings > 0) {
                        html += `<div class="mt-2 text-xs text-gray-600">üè† ${details.buildings} constru√ß√µes pr√≥ximas</div>`;
                    }
                    
                    if (analysis.roads > 0) {
                        html += `<div class="text-xs text-gray-600">üõ£Ô∏è ${analysis.roads} estradas pr√≥ximas</div>`;
                    }
                    
                    document.getElementById('land-use-content-section').innerHTML = html;
                    
                    // Calculate NDVI estimate based on land use
                    calculateNDVI(percentages);
                } else {
                    document.getElementById('land-use-content-section').innerHTML = '<p class="text-sm text-gray-600">N√£o foi poss√≠vel analisar o uso do solo</p>';
                    document.getElementById('ndvi-content-section').innerHTML = '<p class="text-sm text-gray-600">N√£o foi poss√≠vel calcular NDVI</p>';
                }
            } catch (error) {
                console.error('Land use error:', error);
                const errorMsg = error.message.includes('timeout') 
                    ? '‚è±Ô∏è Timeout - A requisi√ß√£o demorou muito. <button onclick="loadLandUse(new google.maps.LatLng(' + location.lat() + ',' + location.lng() + '))" class="text-blue-600 hover:underline ml-2">üîÑ Tentar novamente</button>'
                    : '‚ùå Erro ao carregar an√°lise de uso do solo';
                document.getElementById('land-use-content-section').innerHTML = '<p class="text-sm text-red-600">' + errorMsg + '</p>';
            }
        }

        // Fun√ß√£o auxiliar que aceita lat/lng diretos
        async function loadFemaFloodDirect(lat, lng) {
            document.getElementById('fema-flood-content-section').innerHTML = '<p class="text-sm text-gray-600">‚è≥ Carregando dados FEMA...</p>';
            
            // ‚úÖ SISTEMA DE CACHE
            const cacheKey = `fema_${lat.toFixed(4)}_${lng.toFixed(4)}`;
            const cachedData = localStorage.getItem(cacheKey);
            
            if (cachedData) {
                try {
                    const data = JSON.parse(cachedData);
                    const cacheAge = Date.now() - data.timestamp;
                    const maxAge = 30 * 24 * 60 * 60 * 1000; // 30 dias
                    
                    if (cacheAge < maxAge) {
                        console.log('üíæ Cache hit! Usando dados salvos (idade:', Math.floor(cacheAge / (24 * 60 * 60 * 1000)), 'dias)');
                        
                        // Processar dados do cache (mesmo c√≥digo que abaixo)
                        if (data.success && data.floodZone) {
                            const zone = data.floodZone;
                            const subtype = data.zoneSubtype || '';
                            const riskLevel = data.riskLevel;
                            const riskColor = data.riskColor;
                            
                            let riskIcon, riskText, description, insuranceRequired;
                            
                            if (riskLevel === 'high') {
                                riskIcon = 'üö®';
                                riskText = 'ALTO';
                                description = 'Alto risco de inunda√ß√£o (SFHA - Special Flood Hazard Area)';
                                insuranceRequired = true;
                            } else if (riskLevel === 'low') {
                                riskIcon = '‚úÖ';
                                riskText = 'BAIXO';
                                description = 'Baixo risco de inunda√ß√£o';
                                insuranceRequired = false;
                            } else if (riskLevel === 'moderate') {
                                riskIcon = '‚ö†Ô∏è';
                                riskText = 'M√âDIO';
                                description = 'Risco moderado de inunda√ß√£o';
                                insuranceRequired = false;
                            } else {
                                riskIcon = '‚ÑπÔ∏è';
                                riskText = 'DESCONHECIDO';
                                description = data.message || 'Dados n√£o dispon√≠veis para esta localiza√ß√£o';
                                insuranceRequired = false;
                            }
                            
                            let extraInfo = '';
                            if (data.baseFloodElevation) {
                                extraInfo += `<div class="text-xs text-gray-600 mt-1">BFE (Base Flood Elevation): ${data.baseFloodElevation} ${data.datum || 'ft'}</div>`;
                            }
                            if (data.depth) {
                                extraInfo += `<div class="text-xs text-gray-600">Profundidade: ${data.depth} ft</div>`;
                            }
                            
                            let html = `
                                <div class="flex items-center gap-3 mb-2">
                                    <span class="text-3xl">${riskIcon}</span>
                                    <div>
                                        <div class="font-semibold text-sm" style="color: ${riskColor}">Risco: ${riskText}</div>
                                        <div class="text-xs text-gray-600">Zona: ${zone}${subtype ? ' (' + subtype + ')' : ''}</div>
                                    </div>
                                </div>
                                <p class="text-xs text-gray-700 mb-2">${description}</p>
                                ${extraInfo}
                                <div class="${insuranceRequired ? 'bg-red-50 border-red-200' : 'bg-green-50 border-green-200'} border rounded p-2 text-xs mt-2">
                                    <strong style="color: ${insuranceRequired ? '#dc3545' : '#28a745'}">${insuranceRequired ? '‚ö†Ô∏è Seguro contra inunda√ß√£o obrigat√≥rio' : '‚úÖ Seguro contra inunda√ß√£o opcional'}</strong>
                                </div>
                                <div class="text-xs text-gray-400 mt-2">üíæ Dados do cache (${Math.floor(cacheAge / (24 * 60 * 60 * 1000))} dias atr√°s)</div>
                            `;
                            
                            document.getElementById('fema-flood-content-section').innerHTML = html;
                            displayFloodZoneExplanation(zone);
                            return; // Sair da fun√ß√£o
                        }
                    } else {
                        console.log('üóëÔ∏è Cache expirado, removendo...');
                        localStorage.removeItem(cacheKey);
                    }
                } catch (e) {
                    console.error('‚ùå Erro ao ler cache:', e);
                    localStorage.removeItem(cacheKey);
                }
            }
            
            try {
                // Chamar FEMA API via proxy do servidor (evita CORS e timeout)
                const response = await fetch('http://localhost:3000/api/fema-flood', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ lat, lng })
                });
                
                const data = await response.json();
                
                console.log('üåä FEMA Response:', data);
                
                if (data.success && data.floodZone) {
                    const zone = data.floodZone;
                    const subtype = data.zoneSubtype || '';
                    const riskLevel = data.riskLevel;
                    const riskColor = data.riskColor;
                    
                    // Determinar √≠cone e descri√ß√£o baseado no riskLevel
                    let riskIcon, riskText, description, insuranceRequired;
                    
                    if (riskLevel === 'high') {
                        riskIcon = 'üö®';
                        riskText = 'ALTO';
                        description = 'Alto risco de inunda√ß√£o (SFHA - Special Flood Hazard Area)';
                        insuranceRequired = true;
                    } else if (riskLevel === 'low') {
                        riskIcon = '‚úÖ';
                        riskText = 'BAIXO';
                        description = 'Baixo risco de inunda√ß√£o';
                        insuranceRequired = false;
                    } else if (riskLevel === 'moderate') {
                        riskIcon = '‚ö†Ô∏è';
                        riskText = 'M√âDIO';
                        description = 'Risco moderado de inunda√ß√£o';
                        insuranceRequired = false;
                    } else {
                        riskIcon = '‚ÑπÔ∏è';
                        riskText = 'DESCONHECIDO';
                        description = data.message || 'Dados n√£o dispon√≠veis para esta localiza√ß√£o';
                        insuranceRequired = false;
                    }
                    
                    // Adicionar informa√ß√µes extras se dispon√≠veis
                    let extraInfo = '';
                    if (data.baseFloodElevation) {
                        extraInfo += `<div class="text-xs text-gray-600 mt-1">BFE (Base Flood Elevation): ${data.baseFloodElevation} ${data.datum || 'ft'}</div>`;
                    }
                    if (data.depth) {
                        extraInfo += `<div class="text-xs text-gray-600">Profundidade: ${data.depth} ft</div>`;
                    }
                    
                    let html = `
                        <div class="flex items-center gap-3 mb-2">
                            <span class="text-3xl">${riskIcon}</span>
                            <div>
                                <div class="font-semibold text-sm" style="color: ${riskColor}">Risco: ${riskText}</div>
                                <div class="text-xs text-gray-600">Zona: ${zone}${subtype ? ' (' + subtype + ')' : ''}</div>
                            </div>
                        </div>
                        <p class="text-xs text-gray-700 mb-2">${description}</p>
                        ${extraInfo}
                        <div class="${insuranceRequired ? 'bg-red-50 border-red-200' : 'bg-green-50 border-green-200'} border rounded p-2 text-xs mt-2">
                            <strong style="color: ${insuranceRequired ? '#dc3545' : '#28a745'}">${insuranceRequired ? '‚ö†Ô∏è Seguro contra inunda√ß√£o obrigat√≥rio' : '‚úÖ Seguro contra inunda√ß√£o opcional'}</strong>
                        </div>
                    `;
                    
                    document.getElementById('fema-flood-content-section').innerHTML = html;
                    
                    // ‚úÖ Salvar no cache
                    try {
                        const cacheData = {
                            ...data,
                            timestamp: Date.now()
                        };
                        localStorage.setItem(cacheKey, JSON.stringify(cacheData));
                        console.log('üíæ Dados salvos no cache');
                    } catch (e) {
                        console.warn('‚ö†Ô∏è N√£o foi poss√≠vel salvar no cache:', e);
                    }
                    
                    // ‚úÖ Mostrar explica√ß√£o inteligente de flood zone
                    displayFloodZoneExplanation(zone);
                } else if (data.timeout) {
                    document.getElementById('fema-flood-content-section').innerHTML = `
                        <div class="text-sm text-orange-600">
                            <p class="font-semibold">‚è±Ô∏è Servidor FEMA n√£o respondeu</p>
                            <p class="text-xs mt-1">O servidor oficial da FEMA est√° muito lento ou indispon√≠vel no momento.</p>
                            <button onclick="window.open('https://msc.fema.gov/portal/search', '_blank')" class="mt-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors text-sm">üåä Carregar Flood Risk</button>
                        </div>
                    `;
                } else if (data.success === false) {
                    // API returned error but with informative message
                    document.getElementById('fema-flood-content-section').innerHTML = `
                        <div class="text-sm">
                            <p class="font-semibold text-gray-700">‚ÑπÔ∏è ${data.message}</p>
                            ${data.suggestion ? `<button onclick="window.open('${data.suggestion}', '_blank')" class="mt-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors text-sm">üåä Carregar Flood Risk</button>` : ''}
                            <p class="text-xs mt-2 text-gray-500">Coordenadas: ${data.coordinates.lat}, ${data.coordinates.lng}</p>
                        </div>
                    `;
                } else {
                    document.getElementById('fema-flood-content-section').innerHTML = '<p class="text-sm text-gray-600">‚ÑπÔ∏è Sem dados de flood zone dispon√≠veis</p>';
                }
            } catch (error) {
                console.error('üåä FEMA error:', error);
                document.getElementById('fema-flood-content-section').innerHTML = `
                    <div class="text-sm text-gray-600">
                        <p class="font-semibold">‚ÑπÔ∏è Dados FEMA n√£o dispon√≠veis</p>
                        <button onclick="window.open('https://msc.fema.gov/portal/search', '_blank')" class="mt-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors text-sm">üåä Carregar Flood Risk</button>
                    </div>
                `;
            }
        }
        
        // Fun√ß√£o original para compatibilidade com Google Maps
        async function loadFemaFlood(location) {
            await loadFemaFloodDirect(location.lat(), location.lng());
        }

        async function loadWaterProximity(location) {
            try {
                if (!placesService) {
                    placesService = new google.maps.places.PlacesService(satelliteMap);
                }
                
                const waterTypes = [
                    { type: 'natural_feature', name: 'Corpo d\'Agua', icon: 'üåä' },
                    { type: 'park', name: 'Parque/Lago', icon: 'üå≥' }
                ];
                
                let waterBodies = [];
                let searchesCompleted = 0;
                
                waterTypes.forEach(waterType => {
                    placesService.nearbySearch({
                        location: location,
                        radius: 2000, // 2km
                        keyword: 'river lake water pond creek'
                    }, (results, status) => {
                        searchesCompleted++;
                        
                        if (status === google.maps.places.PlacesServiceStatus.OK && results) {
                            results.forEach(place => {
                                const distance = google.maps.geometry.spherical.computeDistanceBetween(
                                    location,
                                    place.geometry.location
                                );
                                
                                // Filter water-related places
                                const name = place.name.toLowerCase();
                                if (name.includes('river') || name.includes('lake') || 
                                    name.includes('creek') || name.includes('pond') ||
                                    name.includes('water') || name.includes('rio') ||
                                    name.includes('lago')) {
                                    waterBodies.push({
                                        name: place.name,
                                        distance: Math.round(distance),
                                        icon: waterType.icon
                                    });
                                }
                            });
                        }
                        
                        // When all searches complete
                        if (searchesCompleted === waterTypes.length) {
                            displayWaterProximity(waterBodies, location);
                        }
                    });
                });
            } catch (error) {
                console.error('Water proximity error:', error);
                document.getElementById('water-proximity-content-section').innerHTML = 
                    '<p class="text-sm text-red-600">Erro ao carregar dados de proximidade de agua</p>';
            }
        }
        
        function displayWaterProximity(waterBodies, location) {
            // Remove duplicates and sort by distance
            const unique = [];
            const seen = new Set();
            
            waterBodies.forEach(wb => {
                if (!seen.has(wb.name)) {
                    seen.add(wb.name);
                    unique.push(wb);
                }
            });
            
            unique.sort((a, b) => a.distance - b.distance);
            const closest = unique.slice(0, 3); // Top 3
            
            if (closest.length === 0) {
                document.getElementById('water-proximity-content-section').innerHTML = `
                    <div class="flex items-center gap-2 text-sm">
                        <span class="text-2xl">‚úÖ</span>
                        <span class="text-green-600 font-semibold">Nenhum corpo d'agua pr√≥ximo (raio 2km)</span>
                    </div>
                    <p class="text-xs text-gray-600 mt-1">Baixo risco de inunda√ß√£o por proximidade de agua</p>
                `;
                return;
            }
            
            let html = '<div class="space-y-2">';
            
            closest.forEach(wb => {
                const distanceKm = (wb.distance / 1000).toFixed(2);
                const distanceM = wb.distance;
                
                let riskIcon, riskText, riskColor;
                if (distanceM < 100) {
                    riskIcon = 'üö®';
                    riskText = 'MUITO PR√ìXIMO';
                    riskColor = 'red';
                } else if (distanceM < 500) {
                    riskIcon = '‚ö†Ô∏è';
                    riskText = 'PR√ìXIMO';
                    riskColor = 'orange';
                } else {
                    riskIcon = '‚úÖ';
                    riskText = 'DIST√ÇNCIA SEGURA';
                    riskColor = 'green';
                }
                
                html += `
                    <div class="flex items-center justify-between text-xs border-b border-gray-100 pb-1">
                        <div class="flex items-center gap-2">
                            <span class="text-lg">${wb.icon}</span>
                            <span class="font-semibold">${wb.name}</span>
                        </div>
                        <div class="text-right">
                            <div class="font-semibold">${distanceM < 1000 ? distanceM + 'm' : distanceKm + 'km'}</div>
                            <div class="text-${riskColor}-600 text-xs">${riskIcon} ${riskText}</div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            // Overall risk assessment
            const closestDistance = closest[0].distance;
            if (closestDistance < 100) {
                html += `
                    <div class="bg-red-50 border border-red-200 rounded p-2 text-xs mt-2">
                        <strong class="text-red-700">üö® Alerta:</strong>
                        <span class="text-red-600">Propriedade muito pr√≥xima de agua - alto risco de inunda√ß√£o</span>
                    </div>
                `;
            } else if (closestDistance < 500) {
                html += `
                    <div class="bg-orange-50 border border-orange-200 rounded p-2 text-xs mt-2">
                        <strong class="text-orange-700">‚ö†Ô∏è Aten√ß√£o:</strong>
                        <span class="text-orange-600">Proximidade moderada de agua - verificar hist√≥rico de inunda√ß√µes</span>
                    </div>
                `;
            }
            
            document.getElementById('water-proximity-content-section').innerHTML = html;
        }

        function calculateNDVI(landUsePercentages) {
            // Estimate NDVI based on land use percentages
            // NDVI scale: -1 to 1
            // Forest: 0.6-0.9
            // Agriculture: 0.4-0.6
            // Urban: 0.1-0.3
            // Water: -0.1-0.1
            
            let ndvi = 0;
            ndvi += (landUsePercentages.forest / 100) * 0.75;      // Forest contributes high NDVI
            ndvi += (landUsePercentages.agricultural / 100) * 0.50; // Agriculture moderate
            ndvi += (landUsePercentages.urban / 100) * 0.20;        // Urban low
            ndvi += (landUsePercentages.water / 100) * 0.05;        // Water very low
            
            // Determine vegetation density
            let density, densityColor, densityIcon;
            if (ndvi >= 0.7) {
                density = 'Muito Densa';
                densityColor = 'green';
                densityIcon = 'üå≥üå≥üå≥';
            } else if (ndvi >= 0.5) {
                density = 'Densa';
                densityColor = 'green';
                densityIcon = 'üå≥üå≥';
            } else if (ndvi >= 0.3) {
                density = 'Moderada';
                densityColor = 'yellow';
                densityIcon = 'üå≥';
            } else if (ndvi >= 0.15) {
                density = 'Esparsa';
                densityColor = 'orange';
                densityIcon = 'üåæ';
            } else {
                density = 'M√≠nima/Ausente';
                densityColor = 'gray';
                densityIcon = 'üè≠';
            }
            
            // Estimate clearing cost
            let clearingCost, clearingTime;
            if (ndvi >= 0.7) {
                clearingCost = '$30.000 - $50.000';
                clearingTime = '4-6 meses';
            } else if (ndvi >= 0.5) {
                clearingCost = '$15.000 - $30.000';
                clearingTime = '2-4 meses';
            } else if (ndvi >= 0.3) {
                clearingCost = '$5.000 - $15.000';
                clearingTime = '1-2 meses';
            } else if (ndvi >= 0.15) {
                clearingCost = '$2.000 - $5.000';
                clearingTime = '2-4 semanas';
            } else {
                clearingCost = '$500 - $2.000';
                clearingTime = '1-2 semanas';
            }
            
            let html = `
                <div class="flex items-center gap-3 mb-2">
                    <span class="text-2xl">${densityIcon}</span>
                    <div>
                        <div class="font-semibold text-sm text-${densityColor}-600">
                            √çndice NDVI: ${ndvi.toFixed(2)}
                        </div>
                        <div class="text-xs text-gray-600">Densidade de Vegeta√ß√£o: ${density}</div>
                    </div>
                </div>
                
                <div class="mb-2">
                    <div class="text-xs text-gray-600 mb-1">Barra de Vegeta√ß√£o:</div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-${densityColor}-600 h-2 rounded-full" style="width: ${(ndvi * 100).toFixed(0)}%"></div>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-2 text-xs">
                    <div class="bg-blue-50 border border-blue-200 rounded p-2">
                        <div class="text-blue-700 font-semibold">üí∞ Custo de Limpeza:</div>
                        <div class="text-blue-600">${clearingCost}</div>
                    </div>
                    <div class="bg-purple-50 border border-purple-200 rounded p-2">
                        <div class="text-purple-700 font-semibold">‚è±Ô∏è Tempo Estimado:</div>
                        <div class="text-purple-600">${clearingTime}</div>
                    </div>
                </div>
            `;
            
            if (ndvi >= 0.6) {
                html += `
                    <div class="bg-orange-50 border border-orange-200 rounded p-2 text-xs mt-2">
                        <strong class="text-orange-700">‚ö†Ô∏è Aten√ß√£o:</strong>
                        <span class="text-orange-600">Vegeta√ß√£o densa - custo alto de limpeza. Considere negociar desconto no pre√ßo.</span>
                    </div>
                `;
            } else if (ndvi < 0.2) {
                html += `
                    <div class="bg-green-50 border border-green-200 rounded p-2 text-xs mt-2">
                        <strong class="text-green-700">‚úÖ Vantagem:</strong>
                        <span class="text-green-600">Terreno limpo - pronto para constru√ß√£o com custo m√≠nimo de prepara√ß√£o.</span>
                    </div>
                `;
            }
            
            document.getElementById('ndvi-content-section').innerHTML = html;
        }

        function createGoogleEarthLink(location) {
            const lat = location.lat();
            const lng = location.lng();
            
            // Google Earth Web URL with coordinates
            const earthUrl = `https://earth.google.com/web/@${lat},${lng},500a,1000d,35y,0h,0t,0r`;
            
            let html = `
                <div class="flex items-center gap-3 mb-2">
                    <span class="text-3xl">üåç</span>
                    <div class="flex-1">
                        <p class="text-xs text-gray-700 mb-2">
                            Veja como esta propriedade mudou ao longo do tempo usando o Google Earth.
                        </p>
                    </div>
                </div>
                
                <a href="${earthUrl}" target="_blank" 
                   class="block w-full bg-blue-600 hover:bg-blue-700 text-white text-center py-2 px-4 rounded-lg text-sm font-semibold transition-colors">
                    üöÄ Abrir no Google Earth
                </a>
                
                <div class="mt-2 text-xs text-gray-600">
                    <strong>üîç O que voc√™ pode ver:</strong>
                    <ul class="list-disc list-inside mt-1 space-y-0.5">
                        <li>Imagens hist√≥ricas desde 1984</li>
                        <li>Compara√ß√£o lado a lado (2010 vs 2024)</li>
                        <li>Mudan√ßas na vegeta√ß√£o e constru√ß√µes</li>
                        <li>Evolu√ß√£o da √°rea ao longo dos anos</li>
                    </ul>
                </div>
            `;
            
            document.getElementById('google-earth-content-section').innerHTML = html;
        }

        async function loadZillowPhotos(prop) {
            document.getElementById('zillow-loading').textContent = 'Carregando fotos...';
            zillowPhotos = [];
            zillowPhotoIndex = 0;

            try {
                // Use lat/lng directly from prop if available
                if (prop.lat && prop.lng) {
                    // Step 2: Search Zillow property by coordinates
                    const searchResponse = await fetch('/api/zillow/search', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ lat: prop.lat, lng: prop.lng })
                    });
                    
                    if (!searchResponse.ok) {
                        throw new Error('Propriedade n√£o encontrada no Zillow');
                    }
                    
                    const searchData = await searchResponse.json();
                    const zpid = searchData.zpid || searchData.results?.[0]?.zpid;
                    
                    if (!zpid) {
                        throw new Error('ZPID n√£o encontrado');
                    }
                    
                    // Step 3: Get property images
                    const imagesResponse = await fetch('/api/zillow/images', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ zpid })
                    });
                    
                    if (!imagesResponse.ok) {
                        throw new Error('Erro ao buscar fotos');
                    }
                    
                    const imagesData = await imagesResponse.json();
                    zillowPhotos = imagesData.images || imagesData.photos || [];
                    
                    if (zillowPhotos.length === 0) {
                        document.getElementById('zillow-loading').textContent = 'Nenhuma foto dispon√≠vel no Zillow';
                    } else {
                        document.getElementById('zillow-loading').style.display = 'none';
                        updateZillowPhoto();
                    }
                    return;
                }
                
                // Step 1: Get coordinates from address (using Geocoding API)
                const geocodeResponse = await fetch(
                    `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(prop['Address'] + ', ' + prop['City'] + ', FL')}&key=${window.googleMapsApiKey}`
                );
                const geocodeData = await geocodeResponse.json();

                if (!geocodeData.results || geocodeData.results.length === 0) {
                    throw new Error('Endere√ßo n√£o encontrado');
                }

                const location = geocodeData.results[0].geometry.location;

                // Step 2: Search Zillow property by coordinates
                const searchResponse = await fetch('/api/zillow/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lat: location.lat, lng: location.lng })
                });

                if (!searchResponse.ok) {
                    throw new Error('Propriedade n√£o encontrada no Zillow');
                }

                const searchData = await searchResponse.json();
                const zpid = searchData.zpid || searchData.results?.[0]?.zpid;

                if (!zpid) {
                    throw new Error('ZPID n√£o encontrado');
                }

                // Step 3: Get property images
                const imagesResponse = await fetch('/api/zillow/images', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ zpid })
                });

                if (!imagesResponse.ok) {
                    throw new Error('Erro ao buscar fotos');
                }

                const imagesData = await imagesResponse.json();
                zillowPhotos = imagesData.images || imagesData.photos || [];

                if (zillowPhotos.length === 0) {
                    document.getElementById('zillow-loading').textContent = 'Nenhuma foto dispon√≠vel no Zillow';
                } else {
                    document.getElementById('zillow-loading').style.display = 'none';
                    updateZillowPhoto();
                }
            } catch (error) {
                console.error('Zillow error:', error);
                document.getElementById('zillow-loading').textContent = `Erro: ${error.message}`;
            }
        }

        async function loadRealtorPhotos(prop) {
            document.getElementById('realtor-loading').textContent = 'Carregando fotos...';
            realtorPhotos = [];
            realtorPhotoIndex = 0;

            try {
                // Use Realty Mole API (accepts address directly)
                const response = await fetch('/api/realtymole/property', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        address: prop['Address'],
                        city: prop['City'],
                        state: 'FL',
                        zip: prop.zip || ''
                    })
                });

                if (!response.ok) {
                    throw new Error('Propriedade n√£o encontrada');
                }

                const data = await response.json();
                realtorPhotos = data.photos || data.images || [];

                if (realtorPhotos.length === 0) {
                    document.getElementById('realtor-loading').textContent = 'Nenhuma foto dispon√≠vel no Realty Mole';
                } else {
                    document.getElementById('realtor-loading').style.display = 'none';
                    updateRealtorPhoto();
                }
            } catch (error) {
                console.error('Realty Mole error:', error);
                document.getElementById('realtor-loading').textContent = `Erro: ${error.message}`;
            }
        }

        function showZillowPhoto(index) {
            if (zillowPhotos.length > 0) {
                document.getElementById('zillow-photo').src = zillowPhotos[index];
                document.getElementById('zillow-photo').classList.remove('hidden');
                document.getElementById('zillow-loading').classList.add('hidden');
                document.getElementById('zillow-counter').textContent = `${index + 1} / ${zillowPhotos.length}`;
            }
        }

        function showRealtorPhoto(index) {
            if (realtorPhotos.length > 0) {
                document.getElementById('realtor-photo').src = realtorPhotos[index];
                document.getElementById('realtor-photo').classList.remove('hidden');
                document.getElementById('realtor-loading').classList.add('hidden');
                document.getElementById('realtor-counter').textContent = `${index + 1} / ${realtorPhotos.length}`;
            }
        }

        // === COPY HELPERS ===
        function showCopyFeedback(msg) {
            // Create a floating toast notification
            let toast = document.getElementById('copy-toast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'copy-toast';
                toast.style.cssText = 'position:fixed;bottom:20px;right:20px;background:#10b981;color:white;padding:10px 20px;border-radius:8px;font-size:14px;font-weight:600;z-index:9999;box-shadow:0 4px 12px rgba(0,0,0,0.15);transition:opacity 0.3s;';
                document.body.appendChild(toast);
            }
            toast.textContent = '‚úÖ ' + msg;
            toast.style.opacity = '1';
            toast.style.display = 'block';
            clearTimeout(window._copyToastTimer);
            window._copyToastTimer = setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => { toast.style.display = 'none'; }, 300);
            }, 2000);
        }
        
        function fallbackCopy(text, msg) {
            // Fallback for non-HTTPS or older browsers
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.cssText = 'position:fixed;left:-9999px;';
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                showCopyFeedback(msg);
            } catch (e) {
                alert('Erro ao copiar. Copie manualmente: ' + text);
            }
            document.body.removeChild(textarea);
        }

        function copyParcelNumber() {
            const parcelNumber = document.getElementById('prop-parcel-1')?.textContent;
            if (parcelNumber && parcelNumber !== '-') {
                navigator.clipboard.writeText(parcelNumber.trim())
                    .then(() => {
                        showCopyFeedback('Parcel # copiado!');
                    })
                    .catch(err => {
                        console.error('Failed to copy:', err);
                        fallbackCopy(parcelNumber.trim(), 'Parcel # copiado!');
                    });
            }
        }
        
        function copyAddress() {
            const address = document.getElementById('prop-address-full-1')?.textContent;
            if (address && address !== '-') {
                navigator.clipboard.writeText(address.trim())
                    .then(() => {
                        showCopyFeedback('Endere√ßo copiado!');
                    })
                    .catch(err => {
                        console.error('Failed to copy:', err);
                        fallbackCopy(address.trim(), 'Endere√ßo copiado!');
                    });
            }
        }
        
        function voltarAoDashboard() {
            // N√ÉO apaga as propriedades selecionadas - apenas volta para o dashboard
            // O localStorage 'selectedProperties' permanece intacto
            window.location.href = 'index.html';
        }
        
        function copyCoordinates() {
            const coordinates = window.currentCoordinates || document.getElementById('prop-coordinates-1')?.textContent;
            if (coordinates && coordinates !== '-') {
                navigator.clipboard.writeText(coordinates.trim())
                    .then(() => {
                        showCopyFeedback('Coordenadas copiadas!');
                    })
                    .catch(err => {
                        console.error('Failed to copy:', err);
                        fallbackCopy(coordinates.trim(), 'Coordenadas copiadas!');
                    });
            }
        }
        
        function copyLegalDescription() {
            const legalDesc = window.currentLegalDescription || document.getElementById('prop-legal-1')?.textContent;
            if (legalDesc && legalDesc !== '-') {
                navigator.clipboard.writeText(legalDesc.trim())
                    .then(() => {
                        showCopyFeedback('Legal Description copiada!');
                    })
                    .catch(err => {
                        console.error('Failed to copy:', err);
                        fallbackCopy(legalDesc.trim(), 'Legal Description copiada!');
                    });
            }
        }
        
        function openGoogleMaps() {
            const coordinates = window.currentCoordinates || document.getElementById('prop-coordinates-1').textContent;
            if (coordinates && coordinates !== '-') {
                const [lat, lng] = coordinates.split(',').map(c => c.trim());
                const url = `https://www.google.com/maps?q=${lat},${lng}`;
                window.open(url, '_blank');
            } else {
                alert('‚ö†Ô∏è Coordenadas n√£o dispon√≠veis.');
            }
        }
        
        function removerPropriedade() {
            if (confirm('‚ö†Ô∏è Tem certeza que deseja remover esta propriedade da lista?')) {
                // Remove a propriedade atual
                properties.splice(currentIndex, 1);
                
                // Atualiza o localStorage
                localStorage.setItem('selectedProperties', JSON.stringify(properties));
                
                // Se n√£o sobrou nenhuma propriedade, volta ao dashboard
                if (properties.length === 0) {
                    alert('‚úÖ Todas as propriedades foram removidas. Voltando ao dashboard...');
                    window.location.href = '/';
                    return;
                }
                
                // Se removeu a √∫ltima, volta para a anterior
                if (currentIndex >= properties.length) {
                    currentIndex = properties.length - 1;
                }
                
                // Recarrega a propriedade atual
                loadProperty(currentIndex);
                
                alert('‚úÖ Propriedade removida!');
            }
        }
        
        // ===== FUN√á√ïES DE CATEGORIZA√á√ÉO =====
        
        function deletarPropriedade() {
            if (confirm('‚ö†Ô∏è Tem certeza que deseja DELETAR esta propriedade?\n\nEla ser√° removida permanentemente da lista.')) {
                properties.splice(currentIndex, 1);
                localStorage.setItem('selectedProperties', JSON.stringify(properties));
                
                if (properties.length === 0) {
                    mostrarNotificacao('‚úÖ Todas as propriedades foram analisadas! Voltando ao dashboard...', 'success');
                    setTimeout(() => { window.location.href = '/'; }, 1500);
                    return;
                }
                
                if (currentIndex >= properties.length) {
                    currentIndex = properties.length - 1;
                }
                
                loadProperty(currentIndex);
                mostrarNotificacao('‚ùå Propriedade deletada!', 'error');
            }
        }
        
        function aprovarPropriedade() {
            console.log('üü¢ APROVAR CLICADO - Index:', currentIndex, 'Parcel:', properties[currentIndex]?.['Parcel #']);
            
            properties[currentIndex].status = 'Approved';
            properties[currentIndex].approvedAt = new Date().toISOString();
            localStorage.setItem('selectedProperties', JSON.stringify(properties));
            
            // Save to approvedProperties (Tela 3)
            let approvedProperties = JSON.parse(localStorage.getItem('approvedProperties') || '[]');
            console.log('üì¶ approvedProperties ANTES:', approvedProperties.length, approvedProperties.map(p => p['Parcel #']));
            
            // Check if already approved (avoid duplicates)
            const parcelId = properties[currentIndex]['Parcel #'];
            const alreadyApproved = approvedProperties.some(p => p['Parcel #'] === parcelId);
            
            if (!alreadyApproved) {
                approvedProperties.push(properties[currentIndex]);
                localStorage.setItem('approvedProperties', JSON.stringify(approvedProperties));
                console.log('‚úÖ ADICIONADA ao approvedProperties. Total agora:', approvedProperties.length);
            } else {
                console.log('‚ö†Ô∏è J√° estava aprovada, n√£o duplicou. Total:', approvedProperties.length);
            }
            
            // Atualizar contador de aprovadas
            atualizarContadorAprovadas();
            
            mostrarNotificacao(`‚úÖ Aprovada! (${approvedProperties.length} total) - Avan√ßando...`, 'success');
            
            // Auto-advance to next property
            setTimeout(() => {
                if (currentIndex < properties.length - 1) {
                    currentIndex++;
                    loadProperty(currentIndex);
                    console.log('‚û°Ô∏è Avan√ßou para propriedade:', currentIndex);
                } else {
                    mostrarNotificacao('üéØ √öltima propriedade aprovada! Clique em "Ver Aprovadas" para calcular Max Bid.', 'success');
                    console.log('‚úÖ √öltima propriedade alcan√ßada. Total aprovadas:', approvedProperties.length);
                }
            }, 600);
        }
        
        function atualizarContadorAprovadas() {
            const approvedProperties = JSON.parse(localStorage.getItem('approvedProperties') || '[]');
            const aprovadas = approvedProperties.length;
            
            // Update old counter (if exists)
            const counterElement = document.getElementById('approved-count');
            if (counterElement) {
                counterElement.textContent = aprovadas;
                // Animar contador
                counterElement.classList.add('scale-125');
                setTimeout(() => counterElement.classList.remove('scale-125'), 300);
            }
            
            // Update new button counter
            const approvedCount = document.getElementById('approvedCount');
            if (approvedCount) {
                approvedCount.textContent = aprovadas;
            }
        }
        
        function resetAllMaps() {
            console.log('üîÑ Resetando todos os mapas...');
            
            // Reset Satellite Map
            const satelliteMap = document.getElementById('satellite-map');
            if (satelliteMap) {
                satelliteMap.innerHTML = '<button id="load-satellite-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors">üîç Carregar Imagem</button>';
                // Re-attach event listener
                const btn = document.getElementById('load-satellite-btn');
                if (btn) {
                    btn.addEventListener('click', function() {
                        if (window.currentLocation) {
                            this.innerHTML = '‚è≥ Carregando...';
                            this.disabled = true;
                            initSatelliteMap(window.currentLocation);
                            setTimeout(() => this.remove(), 500);
                        }
                    });
                }
            }
            
            // Reset Street View
            const streetView = document.getElementById('street-view');
            if (streetView) {
                streetView.innerHTML = '<button id="load-streetview-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors">üîç Carregar Imagem</button>';
                const btn = document.getElementById('load-streetview-btn');
                if (btn) {
                    btn.addEventListener('click', function() {
                        if (window.currentLocation) {
                            this.innerHTML = '‚è≥ Carregando...';
                            this.disabled = true;
                            initStreetView(window.currentLocation);
                            setTimeout(() => this.remove(), 500);
                        }
                    });
                }
            }
            
            // Reset Terrain Map
            const terrainMap = document.getElementById('terrain-map-view');
            if (terrainMap) {
                terrainMap.innerHTML = '<button id="load-terrain-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors">üîç Carregar Imagem</button>';
                const btn = document.getElementById('load-terrain-btn');
                if (btn) {
                    btn.addEventListener('click', function() {
                        if (window.currentLocation) {
                            this.innerHTML = '‚è≥ Carregando...';
                            this.disabled = true;
                            initTerrainMap(window.currentLocation);
                            setTimeout(() => this.remove(), 500);
                        }
                    });
                }
            }
            
            // Reset Normal Map
            const normalMap = document.getElementById('normal-map');
            if (normalMap) {
                normalMap.innerHTML = '<button id="load-normalmap-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors">üîç Carregar Imagem</button>';
                const btn = document.getElementById('load-normalmap-btn');
                if (btn) {
                    btn.addEventListener('click', function() {
                        if (window.currentLocation) {
                            this.innerHTML = '‚è≥ Carregando...';
                            this.disabled = true;
                            initNormalMap(window.currentLocation);
                            setTimeout(() => this.remove(), 500);
                        }
                    });
                }
            }
            
            console.log('‚úÖ Mapas resetados com sucesso!');
        }
        
        function proximaPropriedade() {
            if (currentIndex < properties.length - 1) {
                currentIndex++;
                loadProperty(currentIndex);
                mostrarNotificacao('‚û°Ô∏è Pr√≥xima propriedade!', 'info');
            } else {
                // üéØ Final da lista - apenas mostrar notifica√ß√£o
                mostrarNotificacao('üéØ Voc√™ chegou ao final da lista!', 'info');
            }
        }
        
        function anteriorPropriedade() {
            if (currentIndex > 0) {
                currentIndex--;
                loadProperty(currentIndex);
                mostrarNotificacao('‚¨ÖÔ∏è Propriedade anterior!', 'info');
            } else {
                mostrarNotificacao('‚ö†Ô∏è Voc√™ j√° est√° na primeira propriedade!', 'info');
            }
        }
        
        function mostrarNotificacao(mensagem, tipo) {
            const notif = document.createElement('div');
            notif.className = 'fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white font-semibold z-50 transition-all';
            
            if (tipo === 'success') notif.className += ' bg-green-600';
            else if (tipo === 'error') notif.className += ' bg-red-600';
            else if (tipo === 'info') notif.className += ' bg-gray-600';
            
            notif.textContent = mensagem;
            document.body.appendChild(notif);
            
            setTimeout(() => {
                notif.style.opacity = '0';
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        }
        
        function atualizarProgresso() {
            const total = properties.length;
            const atual = currentIndex + 1;
            const porcentagem = (atual / total) * 100;
            
            document.getElementById('progress-text').textContent = `${atual} de ${total}`;
            document.getElementById('progress-bar').style.width = `${porcentagem}%`;
        }
        
        document.addEventListener('keydown', function(event) {
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') return;
            
            if (event.key === 'Delete' || event.key.toLowerCase() === 'd') {
                event.preventDefault();
                deletarPropriedade();
            }
            if (event.key === 'Enter' || event.key.toLowerCase() === 'a') {
                event.preventDefault();
                aprovarPropriedade();
            }
            if (event.key === ' ' || event.key.toLowerCase() === 'p') {
                event.preventDefault();
                pularPropriedade();
            }
            if (event.key === 'ArrowLeft') {
                event.preventDefault();
                if (currentIndex > 0) {
                    currentIndex--;
                    loadProperty(currentIndex);
                }
            }
            if (event.key === 'ArrowRight') {
                event.preventDefault();
                if (currentIndex < properties.length - 1) {
                    currentIndex++;
                    loadProperty(currentIndex);
                }
            }
        });
        
        // ===== FIM FUN√á√ïES DE CATEGORIZA√á√ÉO =====
        
        // ===== FUN√á√ïES NAIP (IMAGEM A√âREA) =====
        
        function loadNAIPImage(prop) {
            // Get coordinates
            const coordsStr = prop['Coordinates'];
            if (!coordsStr) {
                document.getElementById('naip-loading').classList.add('hidden');
                document.getElementById('naip-error').classList.remove('hidden');
                document.getElementById('naip-error').textContent = '‚ùå Coordenadas n√£o dispon√≠veis';
                return;
            }
            
            const coords = coordsStr.split(',').map(c => parseFloat(c.trim()));
            const lat = coords[0];
            const lng = coords[1];
            
            // Get acres for zoom calculation
            const acresStr = prop['Acres'] || '0.25';
            const acres = parseFloat(acresStr);
            
            // Calculate bounding box based on acres
            // 1 acre = 4046.86 m¬≤, sqrt to get side length
            // Convert to degrees (approximately 111,320 meters per degree at equator)
            const metersPerDegree = 111320;
            const sideLength = Math.sqrt(acres * 4046.86); // meters
            const offset = (sideLength / metersPerDegree) * 1.5; // 1.5x for context
            
            const minLat = lat - offset;
            const maxLat = lat + offset;
            const minLng = lng - offset;
            const maxLng = lng + offset;
            
            // Build NAIP URL
            const naipUrl = 'https://gis.apfo.usda.gov/arcgis/services/NAIP/USDA_CONUS_PRIME/ImageServer/WMSServer';
            const params = new URLSearchParams({
                service: 'WMS',
                version: '1.3.0',
                request: 'GetMap',
                layers: '0',
                bbox: `${minLat},${minLng},${maxLat},${maxLng}`,
                width: 800,
                height: 600,
                format: 'image/png',
                crs: 'EPSG:4326',
                styles: ''
            });
            
            const imageUrl = `${naipUrl}?${params.toString()}`;
            
            // Update info
            document.getElementById('naip-location').textContent = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
            document.getElementById('naip-area').textContent = `${acres.toFixed(2)} acres`;
            
            // Load image
            const img = document.getElementById('naip-image');
            const loading = document.getElementById('naip-loading');
            const error = document.getElementById('naip-error');
            
            loading.classList.remove('hidden');
            error.classList.add('hidden');
            img.classList.add('hidden');
            
            img.onload = function() {
                loading.classList.add('hidden');
                img.classList.remove('hidden');
                window.currentNAIPUrl = imageUrl; // Store for download
            };
            
            img.onerror = function() {
                loading.classList.add('hidden');
                error.classList.remove('hidden');
                error.textContent = '‚ùå Erro ao carregar imagem a√©rea. Tente novamente.';
            };
            
            img.src = imageUrl;
        }
        
        function downloadNAIPImage() {
            const imageUrl = window.currentNAIPUrl;
            if (!imageUrl) {
                alert('‚ùå Nenhuma imagem carregada para baixar');
                return;
            }
            
            // Create download link
            const prop = properties[currentIndex];
            const parcel = prop['Parcel Number'] || 'unknown';
            const filename = `naip_${parcel.replace(/[^a-zA-Z0-9]/g, '_')}.png`;
            
            // Download using fetch to avoid CORS issues
            fetch(imageUrl)
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    mostrarNotificacao('‚úÖ Imagem baixada com sucesso!', 'success');
                })
                .catch(error => {
                    console.error('Download error:', error);
                    alert('‚ùå Erro ao baixar imagem. Tente com bot√£o direito > Salvar imagem como...');
                });
        }
        
        function refreshNAIPImage() {
            const prop = properties[currentIndex];
            loadNAIPImage(prop);
            mostrarNotificacao('üîÑ Atualizando imagem a√©rea...', 'info');
        }
        
        // ===== FIM FUN√á√ïES NAIP =====
        
        // ===== FUN√á√ïES USGS ELEVATION =====
        
        async function loadUSGSElevation(lat, lng) {
            try {
                const url = `https://epqs.nationalmap.gov/v1/json?x=${lng}&y=${lat}&units=Feet`;
                const response = await fetchWithTimeout(url, {}, 10000);
                const data = await response.json();
                
                if (data && data.value !== undefined) {
                    const elevationFeet = parseFloat(data.value);
                    const elevationMeters = elevationFeet * 0.3048;
                    
                    // Update info da propriedade (resumo)
                    // prop-elevation-1 n√£o existe no HTML - comentado para evitar erro
                    // document.getElementById('prop-elevation-1').textContent = 
                    //     `${elevationFeet.toFixed(1)} ft (${elevationMeters.toFixed(1)} m)`;
                    
                    // Update an√°lise geogr√°fica (detalhado)
                    document.getElementById('elevation-value-section').textContent = 
                        `${elevationFeet.toFixed(1)} p√©s (${elevationMeters.toFixed(1)} metros)`;
                    
                    // Calculate flood risk based on elevation
                    let floodRisk = '';
                    let floodDescription = '';
                    
                    if (elevationMeters < 10) {
                        floodRisk = '‚ùå ALTO RISCO';
                        floodDescription = 'Propriedade em altitude muito baixa. Alto risco de inunda√ß√£o em eventos de chuva intensa.';
                    } else if (elevationMeters < 30) {
                        floodRisk = '‚ö†Ô∏è RISCO M√âDIO';
                        floodDescription = 'Altitude moderada. Risco de inunda√ß√£o em eventos extremos. Recomenda-se verifica√ß√£o de drenagem.';
                    } else {
                        floodRisk = '‚úÖ BAIXO RISCO';
                        floodDescription = 'Propriedade em altitude segura. Baixo risco de inunda√ß√£o. Ideal para constru√ß√£o.';
                    }
                    
                    document.getElementById('flood-risk-section').innerHTML = floodRisk;
                    document.getElementById('elevation-description').textContent = floodDescription;
                    
                } else {
                    throw new Error('Dados de eleva√ß√£o n√£o dispon√≠veis');
                }
            } catch (error) {
                console.error('USGS Elevation error:', error);
                // prop-elevation-1 n√£o existe no HTML - comentado para evitar erro
                // document.getElementById('prop-elevation-1').textContent = '‚ùå Erro';
                document.getElementById('elevation-value-section').textContent = '‚ùå Erro ao carregar';
                document.getElementById('elevation-description').textContent = 
                    error.message.includes('timeout') 
                        ? '‚è±Ô∏è Timeout - A requisi√ß√£o demorou muito.' 
                        : '‚ùå Erro ao carregar dados de eleva√ß√£o.';
            }
        }
        
        // ===== FIM FUN√á√ïES USGS ELEVATION =====
        
        // ===== FUN√á√ïES USGS WATER SERVICES =====
        
        async function loadUSGSWaterBodies(lat, lng) {
            try {
                // Search for water sites within 2km (~0.018 degrees)
                const offset = 0.018;
                const minLat = lat - offset;
                const maxLat = lat + offset;
                const minLng = lng - offset;
                const maxLng = lng + offset;
                
                const url = `https://waterservices.usgs.gov/nwis/site/?format=json&bBox=${minLng},${minLat},${maxLng},${maxLat}&siteType=ST,LK,ES`;
                const response = await fetchWithTimeout(url, {}, 15000);
                const data = await response.json();
                
                if (data && data.value && data.value.timeSeries && data.value.timeSeries.length > 0) {
                    const waterBodies = [];
                    
                    // Process each site
                    data.value.timeSeries.forEach(series => {
                        const site = series.sourceInfo;
                        if (site && site.geoLocation && site.geoLocation.geogLocation) {
                            const siteLat = parseFloat(site.geoLocation.geogLocation.latitude);
                            const siteLng = parseFloat(site.geoLocation.geogLocation.longitude);
                            
                            // Calculate distance
                            const distance = calculateDistance(lat, lng, siteLat, siteLng);
                            
                            waterBodies.push({
                                 name: site.siteName || 'Corpo d\'agua',
                                type: site.siteTypeCd === 'ST' ? 'Rio/C√≥rrego' : site.siteTypeCd === 'LK' ? 'Lago' : 'Estu√°rio',
                                distance: distance,
                                distanceMiles: (distance * 0.621371).toFixed(2)
                            });
                        }
                    });
                    
                    // Sort by distance and take top 5
                    waterBodies.sort((a, b) => a.distance - b.distance);
                    const topWaterBodies = waterBodies.slice(0, 5);
                    
                    // Display results
                    displayWaterBodies(topWaterBodies);
                    
                } else {
                    document.getElementById('water-bodies-section').innerHTML = 
                         '<p class="text-xs text-gray-600">‚ÑπÔ∏è Nenhum corpo d\'agua encontrado em um raio de 2km.</p>';
                }
            } catch (error) {
                console.error('USGS Water error:', error);
                const errorMsg = error.message.includes('timeout') 
                    ? '‚è±Ô∏è Timeout - A requisi√ß√£o demorou muito.'
                     : '‚ùå Erro ao carregar dados de corpos d\'agua.';
                document.getElementById('water-bodies-section').innerHTML = 
                    `<p class="text-xs text-red-600">${errorMsg}</p>`;
            }
        }
        
        function displayWaterBodies(waterBodies) {
            if (waterBodies.length === 0) {
                document.getElementById('water-bodies-section').innerHTML = 
                    '<p class="text-xs text-gray-600">‚ÑπÔ∏è Nenhum corpo d\'agua encontrado em um raio de 2km.</p>';;
                return;
            }
            
            let html = '<div class="space-y-2">';
            
            waterBodies.forEach((water, index) => {
                const icon = water.type === 'Rio/C√≥rrego' ? 'üåä' : water.type === 'Lago' ? 'üèûÔ∏è' : 'üåä';
                html += `
                    <div class="flex items-start gap-2 text-xs">
                        <span class="text-lg">${icon}</span>
                        <div class="flex-1">
                            <div class="font-semibold text-gray-800">${index + 1}. ${water.name}</div>
                            <div class="text-gray-600">
                                üìç Dist√¢ncia: ${water.distance.toFixed(2)} km (${water.distanceMiles} mi) | 
                                üìä Tipo: ${water.type}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // Add warning if very close
            const closestDistance = waterBodies[0].distance;
            if (closestDistance < 0.5) {
                html += `
                    <div class="mt-3 bg-yellow-50 border border-yellow-200 rounded p-2 text-xs text-yellow-800">
                        ‚ö†Ô∏è <strong>Aten√ß√£o:</strong> Corpo d'agua muito pr√≥ximo (< 500m). 
                        Pode aumentar risco de inunda√ß√£o em eventos extremos.
                    </div>
                `;
            }
            
            html += '</div>';
            html += '<div class="text-xs text-gray-400 mt-2">üìå Fonte: USGS Water Services</div>';
            
            document.getElementById('water-bodies-section').innerHTML = html;
        }
        
        function calculateDistance(lat1, lng1, lat2, lng2) {
            // Haversine formula to calculate distance in km
            const R = 6371; // Earth radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        // ===== FIM FUN√á√ïES USGS WATER SERVICES =====
        
        // updateResearchLinks() REMOVIDA - Aba Research Links n√£o existe mais
        
        // ===== üåä EXPLICA√á√ÉO INTELIGENTE DE FLOOD ZONE =====
        
        function displayFloodZoneExplanation(floodZone) {
            const explanation = getFloodZoneExplanation(floodZone);
            
            const html = `
                <div class="${explanation.bgColor} ${explanation.borderColor} border-2 rounded-lg p-4 mt-4">
                    <div class="flex items-center gap-3 mb-3">
                        <span class="text-4xl">${explanation.icon}</span>
                        <div>
                            <h3 class="text-lg font-bold ${explanation.textColor}">Zona ${floodZone} - ${explanation.risk}</h3>
                            <p class="text-xs ${explanation.textColor} opacity-75">${explanation.description}</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 mb-3 text-sm">
                        <div>
                            <span class="font-semibold ${explanation.textColor}">N√≠vel de Risco:</span>
                            <span class="ml-2 ${explanation.badgeColor} px-2 py-1 rounded text-xs font-bold">${explanation.risk}</span>
                        </div>
                        <div>
                            <span class="font-semibold ${explanation.textColor}">Seguro:</span>
                            <span class="ml-2 font-bold ${explanation.textColor}">${explanation.insurance}</span>
                        </div>
                    </div>
                    
                    <div class="bg-white bg-opacity-50 rounded p-3 mb-3 text-sm">
                        <p class="${explanation.textColor}">
                            <strong>üí∞ Custo do Seguro:</strong> ${explanation.insuranceCost}
                        </p>
                        <p class="${explanation.textColor} mt-2">
                            <strong>üìâ Impacto no Valor:</strong> ${explanation.impact} (${explanation.impactPercent})
                        </p>
                    </div>
                    
                    <div class="bg-white bg-opacity-70 rounded p-3 mb-3 text-sm ${explanation.textColor}">
                        <p>${explanation.details}</p>
                    </div>
                    
                    <div class="${explanation.recommendationType === 'buy' ? 'bg-green-100 border-green-300' : explanation.recommendationType === 'avoid' ? 'bg-red-100 border-red-300' : 'bg-yellow-100 border-yellow-300'} border-l-4 p-3 rounded">
                        <p class="font-bold text-sm ${explanation.recommendationType === 'buy' ? 'text-green-800' : explanation.recommendationType === 'avoid' ? 'text-red-800' : 'text-yellow-800'}">
                            üéØ RECOMENDA√á√ÉO: ${explanation.recommendation}
                        </p>
                    </div>
                </div>
            `;
            
            const section = document.getElementById('flood-zone-explanation-section');
            section.innerHTML = html;
            section.style.display = 'block';
            
            console.log('üåä Explica√ß√£o de Flood Zone exibida:', floodZone, explanation);
        }
        
        // ===== FIM EXPLICA√á√ÉO INTELIGENTE DE FLOOD ZONE =====
        
        // ===== üîç CARREGAMENTO SOB DEMANDA DE IMAGENS =====
        
        // Event Listeners para bot√µes de carregar imagens
        document.addEventListener('DOMContentLoaded', function() {
            // Bot√£o Vista Sat√©lite
            const loadSatelliteBtn = document.getElementById('load-satellite-btn');
            if (loadSatelliteBtn) {
                loadSatelliteBtn.addEventListener('click', function() {
                    if (window.currentLocation) {
                        this.innerHTML = '‚è≥ Carregando...';
                        this.disabled = true;
                        initSatelliteMap(window.currentLocation);
                        setTimeout(() => {
                            this.style.display = 'none';
                        }, 1000);
                    }
                });
            }
            
            // Bot√£o Street View
            const loadStreetViewBtn = document.getElementById('load-streetview-btn');
            if (loadStreetViewBtn) {
                loadStreetViewBtn.addEventListener('click', function() {
                    if (window.currentLocation) {
                        this.innerHTML = '‚è≥ Carregando...';
                        this.disabled = true;
                        initStreetView(window.currentLocation);
                        setTimeout(() => {
                            this.style.display = 'none';
                        }, 1000);
                    }
                });
            }
            
            // Bot√£o Terrain Map
            const loadTerrainBtn = document.getElementById('load-terrain-btn');
            if (loadTerrainBtn) {
                loadTerrainBtn.addEventListener('click', function() {
                    if (window.currentLocation) {
                        this.innerHTML = '‚è≥ Carregando...';
                        this.disabled = true;
                        initTerrainMap(window.currentLocation);
                        setTimeout(() => {
                            this.style.display = 'none';
                        }, 1000);
                    }
                });
            }
            
            // Bot√£o Normal Map
            const loadNormalMapBtn = document.getElementById('load-normalmap-btn');
            if (loadNormalMapBtn) {
                loadNormalMapBtn.addEventListener('click', function() {
                    if (window.currentLocation) {
                        this.innerHTML = '‚è≥ Carregando...';
                        this.disabled = true;
                        initNormalMap(window.currentLocation);
                        setTimeout(() => {
                            this.style.display = 'none';
                        }, 1000);
                    }
                });
            }
            
            // Bot√£o Zillow Photos
            const loadZillowBtn = document.getElementById('load-zillow-btn');
            if (loadZillowBtn) {
                loadZillowBtn.addEventListener('click', function() {
                    if (window.currentProp) {
                        this.innerHTML = '‚è≥ Carregando...';
                        this.disabled = true;
                        loadZillowPhotos(window.currentProp);
                        setTimeout(() => {
                            this.style.display = 'none';
                        }, 1000);
                    }
                });
            }
            
            // Bot√£o Realtor Photos
            const loadRealtorBtn = document.getElementById('load-realtor-btn');
            if (loadRealtorBtn) {
                loadRealtorBtn.addEventListener('click', function() {
                    if (window.currentProp) {
                        this.innerHTML = '‚è≥ Carregando...';
                        this.disabled = true;
                        loadRealtorPhotos(window.currentProp);
                        setTimeout(() => {
                            this.style.display = 'none';
                        }, 1000);
                    }
                });
            }
            
            // Bot√£o NAIP Aerial Image
            const loadNAIPBtn = document.getElementById('load-naip-btn');
            if (loadNAIPBtn) {
                loadNAIPBtn.addEventListener('click', function() {
                    if (window.currentLocation) {
                        this.innerHTML = '‚è≥ Carregando...';
                        this.disabled = true;
                        this.style.display = 'none';
                        document.getElementById('naip-loading').classList.remove('hidden');
                        loadNAIPImage(window.currentLocation.lat(), window.currentLocation.lng());
                    }
                });
            }
            
            console.log('‚úÖ Event listeners dos bot√µes de carregar imagens adicionados');
        });
        
        // ===== FIM CARREGAMENTO SOB DEMANDA DE IMAGENS =====
        
        // ========================================
        // US CENSUS BUREAU API
        // ========================================
        
        async function loadCensusData(lat, lng) {
            console.log('üèôÔ∏è Carregando dados do US Census Bureau:', lat, lng);
            
            // Limpar conte√∫do anterior
            document.getElementById('census-population').innerHTML = '‚è≥ Carregando...';
            document.getElementById('census-income').innerHTML = '‚è≥ Carregando...';
            document.getElementById('census-growth').innerHTML = '‚è≥ Carregando...';
            document.getElementById('census-housing').innerHTML = '‚è≥ Carregando...';
            document.getElementById('census-investment').innerHTML = '‚è≥ Carregando...';
            
            try {
                // Obter API Key do localStorage
                const censusApiKey = localStorage.getItem('censusApiKey');
                if (!censusApiKey) {
                    throw new Error('US Census API Key n√£o configurada. Configure em Configura√ß√µes.');
                }
                
                // Descriptografar API Key
                const decryptedKey = decryptApiKey(censusApiKey);
                
                // 1. Obter Block Group (geocoding reverso)
                const geoResponse = await fetch(
                    `https://geocoding.geo.census.gov/geocoder/geographies/coordinates?x=${lng}&y=${lat}&benchmark=Public_AR_Current&vintage=Current_Current&format=json`
                );
                const geoData = await geoResponse.json();
                
                if (!geoData.result || !geoData.result.geographies) {
                    throw new Error('N√£o foi poss√≠vel obter dados geogr√°ficos do Census');
                }
                
                const blockGroups = geoData.result.geographies['Census Block Groups'];
                const tracts = geoData.result.geographies['Census Tracts'];
                const counties = geoData.result.geographies['Counties'];
                
                if (!blockGroups || blockGroups.length === 0) {
                    throw new Error('Nenhum Block Group encontrado para esta localiza√ß√£o');
                }
                
                const blockGroup = blockGroups[0];
                const tract = tracts ? tracts[0] : null;
                const county = counties ? counties[0] : null;
                
                const state = blockGroup.STATE;
                const countyCode = blockGroup.COUNTY;
                const tractCode = blockGroup.TRACT;
                const bgCode = blockGroup.BLKGRP;
                
                console.log('üìç Census Geography:', { state, countyCode, tractCode, bgCode });
                
                // 2. Buscar dados demogr√°ficos (ACS 5-Year)
                const acsUrl = `https://api.census.gov/data/2021/acs/acs5?get=NAME,B01003_001E,B19013_001E,B25077_001E,B25003_002E,B25003_003E,B01002_001E,B15003_022E,B15003_001E&for=block%20group:${bgCode}&in=state:${state}%20county:${countyCode}%20tract:${tractCode}&key=${decryptedKey}`;
                
                const acsResponse = await fetch(acsUrl);
                const acsData = await acsResponse.json();
                
                if (!acsData || acsData.length < 2) {
                    throw new Error('Dados ACS n√£o dispon√≠veis para esta √°rea');
                }
                
                const [headers, values] = acsData;
                
                // Parse dados
                const population = parseInt(values[1]) || 0;
                const medianIncome = parseInt(values[2]) || 0;
                const medianHomeValue = parseInt(values[3]) || 0;
                const ownerOccupied = parseInt(values[4]) || 0;
                const renterOccupied = parseInt(values[5]) || 0;
                const medianAge = parseFloat(values[6]) || 0;
                const bachelorsOrHigher = parseInt(values[7]) || 0;
                const totalEducation = parseInt(values[8]) || 1;
                
                const totalHousing = ownerOccupied + renterOccupied;
                const ownershipRate = totalHousing > 0 ? ((ownerOccupied / totalHousing) * 100).toFixed(1) : 0;
                const educationRate = ((bachelorsOrHigher / totalEducation) * 100).toFixed(1);
                
                // 3. Popula√ß√£o
                document.getElementById('census-population').innerHTML = `
                    <div class="text-sm space-y-1">
                        <div><span class="text-gray-600">üë• Popula√ß√£o Total:</span> <span class="font-semibold">${population.toLocaleString()}</span></div>
                        <div><span class="text-gray-600">üéÇ Idade M√©dia:</span> <span class="font-semibold">${medianAge.toFixed(1)} anos</span></div>
                        <div><span class="text-gray-600">üéì Educa√ß√£o Superior:</span> <span class="font-semibold">${educationRate}%</span></div>
                    </div>
                `;
                
                // 4. Economia
                document.getElementById('census-income').innerHTML = `
                    <div class="text-sm space-y-1">
                        <div><span class="text-gray-600">üíµ Renda M√©dia:</span> <span class="font-semibold">$${medianIncome.toLocaleString()}/ano</span></div>
                        <div><span class="text-gray-600">üè† Valor M√©dio Im√≥vel:</span> <span class="font-semibold">$${medianHomeValue.toLocaleString()}</span></div>
                        <div><span class="text-gray-600">üìä Poder Aquisitivo:</span> <span class="font-semibold">${medianIncome >= 75000 ? 'Alto' : medianIncome >= 50000 ? 'M√©dio' : 'Baixo'}</span></div>
                    </div>
                `;
                
                // 5. Crescimento (simula√ß√£o - idealmente buscar dados hist√≥ricos)
                const growthRate = 2.5; // Placeholder - idealmente comparar com anos anteriores
                document.getElementById('census-growth').innerHTML = `
                    <div class="text-sm space-y-1">
                        <div><span class="text-gray-600">üìà Crescimento Estimado:</span> <span class="font-semibold">+${growthRate}% ao ano</span></div>
                        <div><span class="text-gray-600">üìÖ Proje√ß√£o 5 anos:</span> <span class="font-semibold">${(population * Math.pow(1 + growthRate/100, 5)).toLocaleString()} habitantes</span></div>
                        <div><span class="text-gray-600">üî• Tend√™ncia:</span> <span class="font-semibold text-green-600">Crescimento</span></div>
                    </div>
                `;
                
                // 6. Habita√ß√£o
                document.getElementById('census-housing').innerHTML = `
                    <div class="text-sm space-y-1">
                        <div><span class="text-gray-600">üè† Total de Resid√™ncias:</span> <span class="font-semibold">${totalHousing.toLocaleString()}</span></div>
                        <div><span class="text-gray-600">üîë Propriet√°rios:</span> <span class="font-semibold">${ownerOccupied.toLocaleString()} (${ownershipRate}%)</span></div>
                        <div><span class="text-gray-600">üìã Inquilinos:</span> <span class="font-semibold">${renterOccupied.toLocaleString()} (${(100 - ownershipRate).toFixed(1)}%)</span></div>
                    </div>
                `;
                
                // 7. An√°lise de Investimento
                let investmentScore = 0;
                let investmentFactors = [];
                
                if (medianIncome >= 75000) {
                    investmentScore += 30;
                    investmentFactors.push('‚úÖ Renda alta na regi√£o');
                } else if (medianIncome >= 50000) {
                    investmentScore += 20;
                    investmentFactors.push('‚ö†Ô∏è Renda m√©dia na regi√£o');
                } else {
                    investmentScore += 10;
                    investmentFactors.push('‚ùå Renda baixa na regi√£o');
                }
                
                if (ownershipRate >= 60) {
                    investmentScore += 20;
                    investmentFactors.push('‚úÖ Alta taxa de propriet√°rios');
                } else {
                    investmentScore += 10;
                    investmentFactors.push('‚ö†Ô∏è Baixa taxa de propriet√°rios');
                }
                
                if (educationRate >= 30) {
                    investmentScore += 20;
                    investmentFactors.push('‚úÖ Alta escolaridade');
                } else {
                    investmentScore += 10;
                    investmentFactors.push('‚ö†Ô∏è Baixa escolaridade');
                }
                
                if (population >= 1000) {
                    investmentScore += 15;
                    investmentFactors.push('‚úÖ √Årea populosa');
                } else {
                    investmentScore += 5;
                    investmentFactors.push('‚ö†Ô∏è √Årea pouco populosa');
                }
                
                if (medianAge >= 30 && medianAge <= 45) {
                    investmentScore += 15;
                    investmentFactors.push('‚úÖ Popula√ß√£o economicamente ativa');
                } else {
                    investmentScore += 5;
                    investmentFactors.push('‚ö†Ô∏è Popula√ß√£o fora da faixa ideal');
                }
                
                let investmentLevel, investmentColor;
                if (investmentScore >= 80) {
                    investmentLevel = 'EXCELENTE';
                    investmentColor = 'green';
                } else if (investmentScore >= 60) {
                    investmentLevel = 'BOM';
                    investmentColor = 'blue';
                } else if (investmentScore >= 40) {
                    investmentLevel = 'M√âDIO';
                    investmentColor = 'yellow';
                } else {
                    investmentLevel = 'BAIXO';
                    investmentColor = 'red';
                }
                
                document.getElementById('census-investment').innerHTML = `
                    <div class="text-sm space-y-2">
                        <div class="flex items-center gap-2">
                            <span class="text-gray-600">Score de Investimento:</span>
                            <span class="font-bold text-${investmentColor}-600 text-lg">${investmentScore}/100 - ${investmentLevel}</span>
                        </div>
                        <div class="text-xs text-gray-600 space-y-1">
                            ${investmentFactors.map(f => `<div>${f}</div>`).join('')}
                        </div>
                    </div>
                `;
                
                console.log('‚úÖ Dados do Census carregados com sucesso');
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar Census data:', error);
                const errorMsg = error.message || 'Erro desconhecido';
                
                document.getElementById('census-population').innerHTML = `<p class="text-sm text-red-600">${errorMsg}</p>`;
                document.getElementById('census-income').innerHTML = `<p class="text-sm text-gray-500">N/A</p>`;
                document.getElementById('census-growth').innerHTML = `<p class="text-sm text-gray-500">N/A</p>`;
                document.getElementById('census-housing').innerHTML = `<p class="text-sm text-gray-500">N/A</p>`;
                document.getElementById('census-investment').innerHTML = `<p class="text-sm text-gray-500">N/A</p>`;
            }
        }
        
        // ===== FIM US CENSUS BUREAU API =====
        
        // ===== PROPERTY ANALYSIS WIDGET =====
        
        let propertyAnalysisWidget = null;
        
        /**
         * Initialize Property Analysis Widget
         */
        function initializePropertyAnalysisWidget() {
            console.log('üîç Initializing Property Analysis Widget...');
            
            if (typeof PropertyAnalysisWidget === 'undefined') {
                console.error('‚ùå PropertyAnalysisWidget not loaded!');
                return;
            }
            
            propertyAnalysisWidget = new PropertyAnalysisWidget('property-analysis-widget');
            console.log('‚úÖ Property Analysis Widget initialized');
        }
        
        /**
         * Analyze current property
         */
        async function analyzeCurrentProperty() {
            console.log('üîç Analyzing current property...');
            
            if (!propertyAnalysisWidget) {
                console.error('‚ùå Widget not initialized!');
                alert('Widget n√£o inicializado. Recarregue a p√°gina.');
                return;
            }
            
            const property = properties[currentIndex];
            
            if (!property) {
                alert('Nenhuma propriedade carregada!');
                return;
            }
            
            // Extract coordinates
            let lat, lng;
            
            if (property.Latitude && property.Longitude) {
                lat = parseFloat(property.Latitude);
                lng = parseFloat(property.Longitude);
            } else if (property['Lat/Lng']) {
                const coords = property['Lat/Lng'].split(',').map(c => c.trim());
                lat = parseFloat(coords[0]);
                lng = parseFloat(coords[1]);
            } else if (property.Coordinates) {
                const coords = property.Coordinates.split(',').map(c => c.trim());
                lat = parseFloat(coords[0]);
                lng = parseFloat(coords[1]);
            } else {
                alert('Coordenadas n√£o encontradas para esta propriedade!');
                return;
            }
            
            // Extract county
            let county = property.County || property.county || '';
            
            // Normalize county name - capitalize first letter of each word
            county = county.trim().split(/\s+/).map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ');
            // Handle special cases (St. Johns, Miami-Dade, etc.)
            if (county.toLowerCase().startsWith('st ') || county.toLowerCase().startsWith('saint ')) {
                county = 'St. ' + county.replace(/^(st\.?|saint)\s+/i, '');
            }
            if (!county) {
                alert('Condado n√£o identificado para esta propriedade.');
                return;
            }
            
            // Extract parcel ID (optional)
            const parcelId = property['Parcel #'] || property.ParcelNumber || property.parcel_id || null;
            
            console.log('Analyzing property:', { lat, lng, county, parcelId });
            
            try {
                const result = await propertyAnalysisWidget.analyzeProperty(lat, lng, county, parcelId);
                console.log('‚úÖ Analysis complete:', result);
                
                // Save to analysis history
                saveAnalysisHistory({
                    parcelId: parcelId || 'N/A',
                    county: county,
                    lat: lat,
                    lng: lng,
                    address: property['Address'] || property.address || 'N/A',
                    overallStatus: result?.overallStatus || 'N/A',
                    riskScore: result ? propertyAnalysisWidget.calculateRiskAssessment(result)?.score : null,
                    riskLevel: result ? propertyAnalysisWidget.calculateRiskAssessment(result)?.level : null,
                    timestamp: new Date().toISOString(),
                    data: result
                });
                renderHistoryPanel();
            } catch (error) {
                console.error('‚ùå Analysis error:', error);
                alert(`Erro na an√°lise: ${error.message}`);
            }
        }
        
        // Make function globally available
        window.analyzeCurrentProperty = analyzeCurrentProperty;
        
        // ===== BATCH ANALYSIS =====
        // Fix #11: Global abort flag for batch cancel
        let batchAborted = false;
        
        async function batchAnalyzeAll() {
            if (!propertyAnalysisWidget) {
                alert('Widget n√£o inicializado. Recarregue a p√°gina.');
                return;
            }
            
            if (!properties || properties.length === 0) {
                alert('Nenhuma propriedade carregada!');
                return;
            }
            
            const total = properties.length;
            // Fix #12: Realistic timing estimate (5s per property avg)
            const estMinutes = Math.ceil(total * 5 / 60);
            if (!confirm(`Analisar ${total} propriedade(s)? Estimativa: ~${estMinutes} minuto(s). Voc√™ pode cancelar a qualquer momento.`)) {
                return;
            }
            
            batchAborted = false;
            const btn = document.getElementById('batch-analyze-btn');
            const singleBtn = document.getElementById('analyze-property-btn');
            btn.disabled = true;
            singleBtn.disabled = true;
            
            // Show progress bar with cancel button (Fix #11)
            const widgetContainer = document.getElementById('property-analysis-widget');
            widgetContainer.innerHTML = `
                <div class="p-6">
                    <div class="flex items-center justify-between mb-2">
                        <span class="font-bold text-gray-700">Batch Analysis em andamento...</span>
                        <div class="flex items-center gap-3">
                            <span id="batch-counter" class="text-sm text-gray-500">0 / ${total}</span>
                            <button id="batch-cancel-btn" onclick="cancelBatch()" class="px-3 py-1 bg-red-500 text-white rounded-lg hover:bg-red-600 text-xs font-semibold">Cancelar</button>
                        </div>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3 mb-3">
                        <div id="batch-progress" class="bg-purple-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <div id="batch-current" class="text-xs text-gray-500">Preparando...</div>
                    <div id="batch-elapsed" class="text-xs text-gray-400 mt-1"></div>
                    <div id="batch-results-summary" class="mt-4 space-y-1"></div>
                </div>`;
            
            const results = [];
            let completed = 0;
            let failed = 0;
            // Fix #13: Collect summary lines in array, render once per iteration
            const summaryLines = [];
            const startTime = Date.now();
            
            for (let i = 0; i < total; i++) {
                // Fix #11: Check abort flag
                if (batchAborted) {
                    break;
                }
                
                const property = properties[i];
                const parcelId = property['Parcel #'] || property.ParcelNumber || property.parcel_id || 'N/A';
                
                // Update progress
                document.getElementById('batch-counter').textContent = `${i + 1} / ${total}`;
                document.getElementById('batch-progress').style.width = `${((i + 1) / total) * 100}%`;
                document.getElementById('batch-current').textContent = `Analisando: ${parcelId} (${property.County || 'N/A'} County)`;
                
                // Fix #12: Show elapsed time and ETA
                const elapsed = Math.round((Date.now() - startTime) / 1000);
                const avgPerItem = i > 0 ? elapsed / i : 5;
                const remaining = Math.round(avgPerItem * (total - i));
                const elapsedEl = document.getElementById('batch-elapsed');
                if (elapsedEl) {
                    elapsedEl.textContent = `Tempo: ${Math.floor(elapsed/60)}m${elapsed%60}s | Restante: ~${Math.floor(remaining/60)}m${remaining%60}s`;
                }
                
                // Extract coordinates
                let lat, lng;
                if (property.Latitude && property.Longitude) {
                    lat = parseFloat(property.Latitude);
                    lng = parseFloat(property.Longitude);
                } else if (property['Lat/Lng']) {
                    const coords = property['Lat/Lng'].split(',').map(c => c.trim());
                    lat = parseFloat(coords[0]);
                    lng = parseFloat(coords[1]);
                } else if (property.Coordinates) {
                    const coords = property.Coordinates.split(',').map(c => c.trim());
                    lat = parseFloat(coords[0]);
                    lng = parseFloat(coords[1]);
                }
                
                let county = property.County || property.county || '';
                county = county.trim().split(/\s+/).map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ');
                if (county.toLowerCase().startsWith('st ') || county.toLowerCase().startsWith('saint ')) {
                    county = 'St. ' + county.replace(/^(st\.?|saint)\s+/i, '');
                }
                
                if (!lat || !lng || !county) {
                    results.push({ index: i, parcelId, county, status: 'ERRO', error: 'Dados incompletos' });
                    failed++;
                    summaryLines.push(`<div class="text-xs">‚ùå ${parcelId} (${county}) - Dados incompletos</div>`);
                    const summaryEl = document.getElementById('batch-results-summary');
                    if (summaryEl) summaryEl.innerHTML = summaryLines.join('');
                    continue;
                }
                
                try {
                    const result = await propertyAnalysisWidget.analyzePropertySilent(lat, lng, county, parcelId);
                    const risk = propertyAnalysisWidget.calculateRiskAssessment(result);
                    
                    results.push({ index: i, parcelId, county, status: result?.overallStatus || 'N/A', riskLevel: risk?.level, riskScore: risk?.score });
                    completed++;
                    
                    // Save to history
                    saveAnalysisHistory({
                        parcelId: parcelId,
                        county: county,
                        lat: lat,
                        lng: lng,
                        address: property['Address'] || property.address || 'N/A',
                        overallStatus: result?.overallStatus || 'N/A',
                        riskScore: risk?.score,
                        riskLevel: risk?.level,
                        timestamp: new Date().toISOString(),
                        data: result
                    });
                    
                    const riskLabel = risk?.level === 'green' ? 'Baixo' : risk?.level === 'red' ? 'Alto' : risk?.level === 'critical' ? 'Cr√≠tico' : risk?.level === 'yellow' ? 'M√©dio' : 'N/A';
                    const statusIcon = risk?.level === 'green' ? '‚úÖ' : risk?.level === 'red' || risk?.level === 'critical' ? 'üî¥' : '‚ö†Ô∏è';
                    summaryLines.push(`<div class="text-xs">${statusIcon} ${parcelId} (${county}) - ${riskLabel}</div>`);
                } catch (err) {
                    results.push({ index: i, parcelId, county, status: 'ERRO', error: err.message });
                    failed++;
                    summaryLines.push(`<div class="text-xs">‚ùå ${parcelId} (${county}) - Erro</div>`);
                }
                
                // Fix #13: Replace innerHTML once per iteration instead of appending
                const summaryEl = document.getElementById('batch-results-summary');
                if (summaryEl) summaryEl.innerHTML = summaryLines.join('');
                
                // Small delay between requests
                if (i < total - 1) {
                    await new Promise(r => setTimeout(r, 1000));
                }
            }
            
            // Final summary
            const wasCancelled = batchAborted;
            const riskBadge = (level) => {
                const map = { green: 'bg-green-100 text-green-700', yellow: 'bg-yellow-100 text-yellow-700', red: 'bg-red-100 text-red-700', critical: 'bg-red-200 text-red-900' };
                return map[level] || 'bg-gray-100 text-gray-700';
            };
            
            widgetContainer.innerHTML = `
                <div class="p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-bold text-lg text-gray-800">üì¶ Batch Analysis ${wasCancelled ? 'Cancelado' : 'Completo'}</h3>
                        <button onclick="exportBatchCSV()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm font-semibold">üìÑ Exportar CSV</button>
                    </div>
                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <div class="bg-green-50 rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-green-700">${completed}</div>
                            <div class="text-xs text-green-600">Analisadas</div>
                        </div>
                        <div class="bg-red-50 rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-red-700">${failed}</div>
                            <div class="text-xs text-red-600">Falhas</div>
                        </div>
                        <div class="bg-blue-50 rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-blue-700">${total}</div>
                            <div class="text-xs text-blue-600">Total</div>
                        </div>
                    </div>
                    <div class="space-y-2 max-h-80 overflow-y-auto">
                        ${results.map(r => `
                            <div class="flex items-center gap-3 p-2 bg-gray-50 rounded-lg">
                                <span class="font-mono text-sm font-semibold">${r.parcelId}</span>
                                <span class="text-xs text-gray-500">${r.county}</span>
                                <span class="ml-auto px-2 py-0.5 rounded-full text-xs font-bold ${r.riskLevel ? riskBadge(r.riskLevel) : 'bg-gray-100 text-gray-700'}">
                                    ${r.riskLevel === 'green' ? 'BAIXO' : r.riskLevel === 'critical' ? 'CR√çTICO' : r.riskLevel === 'red' ? 'ALTO' : r.riskLevel === 'yellow' ? 'M√âDIO' : r.error || 'N/A'}
                                </span>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            
            // Store batch results for export
            window._lastBatchResults = results;
            
            btn.disabled = false;
            singleBtn.disabled = false;
            btn.textContent = 'üì¶ Analisar Todas';
            
            renderHistoryPanel();
        }
        
        function exportBatchCSV() {
            const results = window._lastBatchResults;
            if (!results || results.length === 0) { alert('Nenhum resultado para exportar.'); return; }
            
            const headers = ['Index', 'Parcel #', 'County', 'Status', 'Risk Level', 'Risk Score', 'Error'];
            const rows = results.map(r => [
                r.index,
                r.parcelId,
                r.county,
                r.status?.replace(/[^\w\s]/g, '').trim() || 'N/A',
                r.riskLevel || 'N/A',
                r.riskScore ?? 'N/A',
                r.error || ''
            ]);
            
            const csv = [headers, ...rows].map(r => r.map(c => `"${c}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `gt_batch_analysis_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        }
        
        // Fix #11: Cancel batch function
        function cancelBatch() {
            if (confirm('Cancelar batch analysis? Os resultados j√° processados ser√£o mantidos.')) {
                batchAborted = true;
                const cancelBtn = document.getElementById('batch-cancel-btn');
                if (cancelBtn) {
                    cancelBtn.disabled = true;
                    cancelBtn.textContent = 'Cancelando...';
                }
            }
        }
        
        window.batchAnalyzeAll = batchAnalyzeAll;
        window.exportBatchCSV = exportBatchCSV;
        window.cancelBatch = cancelBatch;
        
        // ===== ANALYSIS HISTORY =====
        const HISTORY_KEY = 'gt_analysis_history';
        const MAX_HISTORY = 100;
        
        function getAnalysisHistory() {
            try {
                return JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
            } catch { return []; }
        }
        
        // Fix #7: Trim entry data before saving to prevent localStorage overflow
        function trimEntryForStorage(entry) {
            const trimmed = { ...entry };
            if (trimmed.data) {
                // Keep only essential fields from the full API response
                const d = trimmed.data;
                trimmed.data = {
                    fema: d.fema ? { found: d.fema.found, zone: d.fema.zone, error: d.fema.error } : null,
                    wetlands: d.wetlands ? { found: d.wetlands.found, proximity: d.wetlands.proximity, highestRisk: d.wetlands.highestRisk, count: d.wetlands.count, error: d.wetlands.error } : null,
                    zoning: d.zoning ? { found: d.zoning.found, code: d.zoning.code, description: d.zoning.description, error: d.zoning.error } : null,
                    landUse: d.landUse ? { found: d.landUse.found, code: d.landUse.code, description: d.landUse.description, buildable: d.landUse.buildable, legalDescription: d.landUse.legalDescription, error: d.landUse.error } : null,
                    overallStatus: d.overallStatus
                };
            }
            return trimmed;
        }
        
        function saveAnalysisHistory(entry) {
            const history = getAnalysisHistory();
            // Avoid duplicates (same parcel + county within 1 minute)
            const isDuplicate = history.some(h => 
                h.parcelId === entry.parcelId && 
                h.county === entry.county && 
                Math.abs(new Date(h.timestamp) - new Date(entry.timestamp)) < 60000
            );
            if (!isDuplicate) {
                const trimmedEntry = trimEntryForStorage(entry);
                history.unshift(trimmedEntry); // newest first
                if (history.length > MAX_HISTORY) history.pop();
                try {
                    localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
                } catch (e) {
                    // Fix #7: If localStorage is full, remove oldest entries and retry
                    console.warn('localStorage full, removing oldest entries...');
                    while (history.length > 10) {
                        history.pop();
                        try {
                            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
                            return; // success
                        } catch (e2) { /* keep trimming */ }
                    }
                }
            }
        }
        
        function clearAnalysisHistory() {
            if (confirm('Tem certeza que deseja limpar todo o hist√≥rico de an√°lises?')) {
                localStorage.removeItem(HISTORY_KEY);
                renderHistoryPanel();
            }
        }
        
        function exportHistoryCSV() {
            const history = getAnalysisHistory();
            if (history.length === 0) { alert('Hist√≥rico vazio.'); return; }
            
            const headers = ['Data', 'Parcel #', 'County', 'Address', 'Status', 'Risk Score', 'Risk Level', 'Lat', 'Lng'];
            const rows = history.map(h => [
                new Date(h.timestamp).toLocaleString('pt-BR'),
                h.parcelId,
                h.county,
                h.address,
                h.overallStatus?.replace(/[^\w\s]/g, '').trim() || 'N/A',
                h.riskScore ?? 'N/A',
                h.riskLevel || 'N/A',
                h.lat,
                h.lng
            ]);
            
            const csv = [headers, ...rows].map(r => r.map(c => `"${c}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `gt_analysis_history_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        }
        
        function renderHistoryPanel() {
            const container = document.getElementById('history-panel');
            if (!container) return;
            
            const history = getAnalysisHistory();
            
            if (history.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-400">
                        <p class="text-lg">Nenhuma an√°lise realizada ainda</p>
                        <p class="text-sm mt-1">As an√°lises aparecer√£o aqui automaticamente</p>
                    </div>`;
                return;
            }
            
            const riskBadge = (level) => {
                const map = {
                    green: '<span class="px-2 py-0.5 rounded-full text-xs font-bold bg-green-100 text-green-700">BAIXO</span>',
                    yellow: '<span class="px-2 py-0.5 rounded-full text-xs font-bold bg-yellow-100 text-yellow-700">M√âDIO</span>',
                    red: '<span class="px-2 py-0.5 rounded-full text-xs font-bold bg-red-100 text-red-700">ALTO</span>'
                };
                return map[level] || '<span class="px-2 py-0.5 rounded-full text-xs font-bold bg-gray-100 text-gray-700">N/A</span>';
            };
            
            container.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <span class="text-sm text-gray-500">${history.length} an√°lise(s)</span>
                    <div class="flex gap-2">
                        <button onclick="exportHistoryCSV()" class="px-3 py-1 text-xs bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 font-semibold">Exportar CSV</button>
                        <button onclick="clearAnalysisHistory()" class="px-3 py-1 text-xs bg-red-100 text-red-700 rounded-lg hover:bg-red-200 font-semibold">Limpar</button>
                    </div>
                </div>
                <div class="space-y-2 max-h-96 overflow-y-auto">
                    ${history.map((h, i) => `
                        <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors cursor-pointer" onclick="loadHistoryEntry(${i})">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2">
                                    <span class="font-semibold text-sm truncate">${h.parcelId}</span>
                                    ${riskBadge(h.riskLevel)}
                                </div>
                                <p class="text-xs text-gray-500 truncate">${h.county} County ‚Ä¢ ${h.address}</p>
                            </div>
                            <div class="text-right flex-shrink-0">
                                <p class="text-xs text-gray-400">${new Date(h.timestamp).toLocaleDateString('pt-BR')}</p>
                                <p class="text-xs text-gray-400">${new Date(h.timestamp).toLocaleTimeString('pt-BR', {hour:'2-digit',minute:'2-digit'})}</p>
                            </div>
                        </div>
                    `).join('')}
                </div>`;
        }
        
        function loadHistoryEntry(index) {
            const history = getAnalysisHistory();
            const entry = history[index];
            if (!entry || !entry.data) { alert('Dados da an√°lise n√£o dispon√≠veis.'); return; }
            
            // Fix #8: Guard against missing widget
            if (typeof propertyAnalysisWidget === 'undefined' || !propertyAnalysisWidget) {
                alert('Widget de an√°lise n√£o inicializado. Recarregue a p√°gina.');
                return;
            }
            
            // Re-render the analysis widget with saved data
            const container = document.getElementById(propertyAnalysisWidget.containerId);
            if (!container) {
                alert('Container de an√°lise n√£o encontrado.');
                return;
            }
            container.innerHTML = propertyAnalysisWidget.renderData(entry.data);
            
            // Scroll to the analysis result
            container.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        // Initialize history panel on page load
        document.addEventListener('DOMContentLoaded', () => {
            renderHistoryPanel();
        });
        
        // Make functions globally available
        window.clearAnalysisHistory = clearAnalysisHistory;
        window.exportHistoryCSV = exportHistoryCSV;
        window.loadHistoryEntry = loadHistoryEntry;
        
        // ===== FIM PROPERTY ANALYSIS WIDGET =====
    </script>
</body>
</html>

