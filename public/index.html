<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>GTSearch - Property Manager v23.0 - Basic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        /* Dark Mode Styles */
        body.dark-mode {
            background: linear-gradient(to bottom right, #1a202c, #2d3748) !important;
        }
        body.dark-mode .bg-white {
            background-color: #2d3748 !important;
        }
        body.dark-mode .text-gray-800 {
            color: #e2e8f0 !important;
        }
        body.dark-mode .text-gray-600 {
            color: #cbd5e0 !important;
        }
        body.dark-mode .text-gray-700 {
            color: #cbd5e0 !important;
        }
        body.dark-mode .text-gray-500 {
            color: #a0aec0 !important;
        }
        body.dark-mode .bg-gray-50 {
            background-color: #374151 !important;
        }
        body.dark-mode .divide-gray-200 > * {
            border-color: #4a5568 !important;
        }
        body.dark-mode .border-gray-300 {
            border-color: #4a5568 !important;
        }
        body.dark-mode .hover\:bg-blue-50:hover {
            background-color: #2c5282 !important;
        }
        body.dark-mode input {
            background-color: #374151 !important;
            color: #e2e8f0 !important;
        }
        .row-highlight {
            background-color: #fef3c7 !important;
            transition: background-color 0.3s ease;
        }
        
        /* Anima√ß√µes */
        @keyframes slide-in {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slide-out {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        .animate-slide-in { animation: slide-in 0.3s ease-out; }
        .animate-slide-out { animation: slide-out 0.3s ease-in; }
        
        /* Mobile First Optimizations */
        @media (max-width: 768px) {
            .mobile-compact { font-size: 0.75rem !important; padding: 0.25rem !important; }
            .mobile-hidden { display: none !important; }
            .mobile-full { width: 100% !important; }
            table { font-size: 0.7rem; }
            button { font-size: 0.65rem; padding: 0.25rem 0.5rem; }
        }
        
        /* Tooltips */
        [data-tooltip] { position: relative; }
        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1f2937;
            color: white;
            padding: 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            white-space: nowrap;
            z-index: 1000;
            margin-bottom: 0.25rem;
        }
        }
        body.dark-mode .row-highlight {
            background-color: #78350f !important;
        }
        
        /* UNDIVIDED Alert Styles */
        .undivided-alert {
            background-color: #fee2e2 !important;
            border: 3px solid #dc2626 !important;
        }
        body.dark-mode .undivided-alert {
            background-color: #7f1d1d !important;
            border: 3px solid #dc2626 !important;
        }
        
        /* Bounce animation for map markers */
        @keyframes marker-bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        .marker-bounce {
            animation: marker-bounce 0.6s ease-in-out 3;
        }
        
        /* Table Density Styles */
        .table-compact td { padding: 0.125rem 0.25rem !important; font-size: 0.7rem !important; }
        .table-comfortable td { padding: 0.25rem 0.5rem !important; font-size: 0.75rem !important; }
        .table-spacious td { padding: 0.5rem 0.75rem !important; font-size: 0.875rem !important; }
        
        /* Acres Color Coding */
        .acres-small { background-color: #d1fae5 !important; } /* Green - < 0.25 */
        .acres-medium { background-color: #fef3c7 !important; } /* Yellow - 0.25-0.5 */
        .acres-large { background-color: #fed7aa !important; } /* Orange - > 0.5 */
        
        body.dark-mode .acres-small { background-color: #065f46 !important; }
        body.dark-mode .acres-medium { background-color: #78350f !important; }
        body.dark-mode .acres-large { background-color: #9a3412 !important; }
        
        /* Enhanced UNDIVIDED Badge */
        .undivided-badge {
            display: inline-block;
            background: linear-gradient(135deg, #dc2626, #991b1b);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-weight: bold;
            font-size: 0.7rem;
            animation: pulse-warning 2s infinite;
            box-shadow: 0 0 10px rgba(220, 38, 38, 0.5);
        }
        
        /* Alert Badges */
        .alert-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-weight: bold;
            font-size: 0.7rem;
            margin-right: 0.25rem;
            animation: pulse-warning 2s infinite;
        }
        
        .alert-badge.alert-risk {
            background: linear-gradient(135deg, #dc2626, #991b1b);
            color: white;
            box-shadow: 0 0 10px rgba(220, 38, 38, 0.5);
        }
        
        .alert-badge.alert-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
        }
        
        .alert-badge.alert-info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }
        
        /* Alert Row Backgrounds */
        .alert-row-risk {
            background-color: #fee2e2 !important;
            transition: all 0.3s;
        }
        
        .alert-row-risk:hover {
            background-color: #fecaca !important;
        }
        
        .alert-row-warning {
            background-color: #fef3c7 !important;
            transition: all 0.3s;
        }
        
        .alert-row-warning:hover {
            background-color: #fde68a !important;
        }
        
        .alert-row-info {
            background-color: #dbeafe !important;
            transition: all 0.3s;
        }
        
        .alert-row-info:hover {
            background-color: #bfdbfe !important;
        }
        
        /* Dark mode alert styles */
        body.dark-mode .alert-row-risk {
            background-color: #450a0a !important;
        }
        
        body.dark-mode .alert-row-risk:hover {
            background-color: #7f1d1d !important;
        }
        
        body.dark-mode .alert-row-warning {
            background-color: #451a03 !important;
        }
        
        body.dark-mode .alert-row-warning:hover {
            background-color: #78350f !important;
        }
        
        body.dark-mode .alert-row-info {
            background-color: #172554 !important;
        }
        
        body.dark-mode .alert-row-info:hover {
            background-color: #1e3a8a !important;
        }
        
        @keyframes pulse-warning {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <img src="logo.png" alt="GTSearch Logo" class="h-16 md:h-20">
                    <div>
                        <h1 class="text-3xl md:text-4xl font-bold text-gray-800">
                            GTSearch - Property Manager <span class="text-xl md:text-2xl text-gray-500">v23.0 - Basic</span>
                        </h1>
                        <p class="text-xs text-gray-400 -mt-1">Vers√£o: 11/19/2025 √†s 14:45 (Miami)</p>
                        <p class="text-gray-600 mt-2">Visualize propriedades antigas e compare com novas</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <a href="settings.html" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors flex items-center gap-2 no-underline">
                        <span>‚öôÔ∏è</span>
                        <span>Configura√ß√µes</span>
                    </a>
                    <button id="darkModeToggle" class="px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition-colors flex items-center gap-2">
                        <span id="darkModeIcon">üåô</span>
                        <span id="darkModeText">Modo Escuro</span>
                    </button>

                </div>
            </div>
        </div>

        <!-- Map Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">üìç Mapa de Propriedades</h2>
                <div class="flex gap-3">
                    <button id="importKMLBtn" class="bg-purple-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-purple-700 transition-colors">
                        üì¶ Importar KML ou CSV (Base)
                    </button>
                    <div class="relative">
                        <button id="deleteOldDropdown" class="bg-orange-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-orange-700 transition-colors flex items-center gap-2">
                            üóëÔ∏è Deletar KML ou CSV (base) ‚ñº
                        </button>
                        <div id="deleteOldMenu" class="hidden absolute right-0 mt-2 w-64 bg-white rounded-lg shadow-xl border border-gray-200" style="z-index: 9999;">
                            <button class="delete-category-btn w-full text-left px-4 py-3 hover:bg-green-50 transition-colors border-b border-gray-100 flex items-center gap-2" data-category="available">
                                <span class="w-4 h-4 bg-green-600 rounded-full"></span>
                                <span class="text-gray-700">Deletar Available Lands</span>
                            </button>
                            <button class="delete-category-btn w-full text-left px-4 py-3 hover:bg-gray-50 transition-colors border-b border-gray-100 flex items-center gap-2" data-category="partners">
                                <span class="w-4 h-4 bg-gray-600 rounded-full"></span>
                                <span class="text-gray-700">Deletar Partners Available</span>
                            </button>
                            <button class="delete-category-btn w-full text-left px-4 py-3 hover:bg-gray-50 transition-colors border-b border-gray-100 flex items-center gap-2" data-category="sold">
                                <span class="w-4 h-4 rounded-full" style="background-color: #99E9F2;"></span>
                                <span class="text-gray-700">Deletar Sold Lands</span>
                            </button>
                            <button class="delete-category-btn w-full text-left px-4 py-3 hover:bg-red-50 transition-colors border-b border-gray-100 flex items-center gap-2" data-category="blocked">
                                <span class="w-4 h-4 rounded-full" style="background-color: #FCA5A5;"></span>
                                <span class="text-gray-700">Deletar Blocked/Paused</span>
                            </button>
                            <button class="delete-category-btn w-full text-left px-4 py-3 hover:bg-gray-50 transition-colors border-b border-gray-100 flex items-center gap-2" data-category="outros">
                                <span class="w-4 h-4 rounded-full" style="background-color: #9CA3AF;"></span>
                                <span class="text-gray-700">Deletar Outros</span>
                            </button>
                            <button id="deleteAllOldBtn" class="w-full text-left px-4 py-3 hover:bg-orange-50 transition-colors font-semibold text-orange-600">
                                üóëÔ∏è Deletar TODAS as Antigas
                            </button>
                        </div>
                    </div>
                    <button id="deleteNewBtn" class="hidden bg-red-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700 transition-colors">
                        üóëÔ∏è Deletar Propriedades Pesquisadas
                    </button>
                </div>
            </div>
            <div id="map" class="w-full h-96 rounded-lg shadow-lg"></div>
            <div class="mt-4 flex flex-wrap items-center gap-4 text-sm">
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 bg-green-600 rounded-full"></div>
                    <span class="text-gray-700">Available Lands (<span id="availableCount">0</span>)</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 bg-gray-600 rounded-full"></div>
                    <span class="text-gray-700">Partners Available (<span id="partnersCount">0</span>)</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded-full" style="background-color: #99E9F2;"></div>
                    <span class="text-gray-700">Sold Lands (<span id="soldCount">0</span>)</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded-full border-2 border-white" style="background-color: #FCA5A5;"></div>
                    <span class="text-gray-700">Blocked/Paused (<span id="blockedCount">0</span>)</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 bg-yellow-400 rounded-full"></div>
                    <span class="text-gray-700">Novas Propriedades (<span id="newCount">0</span>)</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded-full" style="background-color: #9CA3AF;"></div>
                    <span class="text-gray-700">Outros (<span id="outrosCount">0</span>)</span>
                </div>
            </div>
        </div>

        <!-- Upload Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">üì• (IPP) Importar Propriedades Para Pesquisa</h2>
            <div id="dropZone" class="border-4 border-dashed border-gray-300 rounded-lg p-12 text-center hover:border-blue-500 transition-colors cursor-pointer">
                <input type="file" id="fileInput" accept=".csv" multiple class="hidden">
                <p class="text-gray-600 text-lg mb-2">Arraste e solte ou clique para selecionar</p>
                <p class="text-gray-400 text-sm">Arquivo CSV exportado do Parcel Fair</p>
            </div>
            <div id="fileList" class="mt-4"></div>
        </div>

        <!-- Downloads Section -->
        <div id="downloadsSection" class="hidden bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">‚¨áÔ∏è Downloads por Condado</h2>
            <div id="downloadButtons" class="flex flex-wrap gap-3"></div>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
            <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg shadow-lg p-4 text-white">
                <h3 class="text-xs font-semibold opacity-90 mb-1">Total de Propriedades</h3>
                <p id="totalProperties" class="text-3xl font-bold">0</p>
            </div>
            <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg shadow-lg p-4 text-white">
                <h3 class="text-xs font-semibold opacity-90 mb-1">Condados</h3>
                <p id="totalCounties" class="text-3xl font-bold">0</p>
            </div>
            <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg shadow-lg p-4 text-white">
                <h3 class="text-xs font-semibold opacity-90 mb-1">Arquivos Carregados</h3>
                <p id="totalFiles" class="text-3xl font-bold">0</p>
            </div>
            <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-lg shadow-lg p-4 text-white">
                <h3 class="text-xs font-semibold opacity-90 mb-1">Novas no Mapa</h3>
                <p id="newOnMap" class="text-3xl font-bold">0</p>
            </div>
        </div>
        
        <!-- Additional Statistics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-gradient-to-br from-cyan-500 to-cyan-600 rounded-lg shadow-lg p-4 text-white">
                <h3 class="text-xs font-semibold opacity-90 mb-1">üìè Total de Acres</h3>
                <p id="totalAcres" class="text-3xl font-bold">0</p>
            </div>
            <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-lg shadow-lg p-4 text-white">
                <h3 class="text-xs font-semibold opacity-90 mb-1">üíµ Valor Total</h3>
                <p id="totalValue" class="text-2xl font-bold">$0</p>
            </div>
            <div class="bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-lg shadow-lg p-4 text-white">
                <h3 class="text-xs font-semibold opacity-90 mb-1">üìä M√©dia de Acres</h3>
                <p id="avgAcres" class="text-3xl font-bold">0</p>
            </div>
            <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-lg shadow-lg p-4 text-white">
                <h3 class="text-xs font-semibold opacity-90 mb-1">‚ö†Ô∏è UNDIVIDED</h3>
                <p id="undividedCount" class="text-3xl font-bold">0</p>
            </div>
        </div>

        <!-- Data Table -->
        <div id="tableSection" class="hidden bg-white rounded-lg shadow-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <div class="flex-1">
                    <h2 class="text-2xl font-bold text-gray-800">üìã Dados Completos (Novas Propriedades)</h2>
                    <div class="flex gap-2 mt-2">
                        <span class="text-sm text-gray-600">Densidade:</span>
                        <button class="density-btn text-xs px-2 py-1 rounded bg-blue-600 text-white" data-density="compact">üìÑ Compacta</button>
                        <button class="density-btn text-xs px-2 py-1 rounded bg-gray-200 hover:bg-gray-300" data-density="comfortable">üìä Confort√°vel</button>
                        <button class="density-btn text-xs px-2 py-1 rounded bg-gray-200 hover:bg-gray-300" data-density="spacious">üìù Espa√ßosa</button>
                    </div>
                </div>
                <div class="flex gap-3 flex-wrap">
                    <button id="filterTerrenoBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                        üèûÔ∏è Terreno 0.20
                    </button>
                    <button id="filterFavoritesBtn" class="bg-yellow-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-yellow-700 transition-colors">
                        ‚≠ê Favoritos (<span id="favoritesCount">0</span>)
                    </button>

                    <button id="analyzeSelectedBtn" class="hidden bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700 transition-colors">
                        üìä Analisar Selecionadas
                    </button>
                    <button id="saveForAnalysisBtn" class="hidden bg-purple-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-purple-700 transition-colors">
                        üíæ Salvar para An√°lise
                    </button>
                    <button id="deleteSelectedBtn" class="hidden bg-red-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700 transition-colors">
                        üóëÔ∏è Deletar Selecionadas
                    </button>
                    <button id="exportSelectedBtn" class="hidden bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition-colors">
                        üìÖ Exportar Propriedades Selecionadas
                    </button>
                    <button id="viewSelectedBtn" class="hidden bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                        üëÅÔ∏è Visualizar Selecionadas
                    </button>
                </div>
            </div>
            
            <!-- Global Search -->
            <div class="mb-4">
                <div class="relative">
                    <input type="text" id="globalSearch" placeholder="üîç Busca r√°pida global (Parcel #, Nome, Endere√ßo, Legal Description...)" class="w-full px-4 py-3 pl-12 text-lg border-2 border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                    <span class="absolute left-4 top-3.5 text-2xl">üîç</span>
                    <button id="clearGlobalSearch" class="hidden absolute right-3 top-3 px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm font-semibold transition-colors">‚úï Limpar</button>
                </div>
            </div>
            
            <!-- Filtros -->
            <div class="bg-gray-50 rounded-lg p-4 mb-4">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">üë§ Nome</label>
                        <input type="text" id="filterName" placeholder="Buscar por nome..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">üìç Condado</label>
                        <select id="filterCounty" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Todos os Condados</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">üèõÔ∏è Cidade</label>
                        <select id="filterCity" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Todas as Cidades</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">üè† Tipo de Propriedade</label>
                        <select id="filterType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Todos</option>
                            <option value="Land Only">Apenas Terrenos (Land Only)</option>
                            <option value="Land & Structures">Apenas Casa (Land & Structures)</option>
                            <option value="Structures Only">Apenas Estrutura (Structures Only)</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">üìè Acres</label>
                        <div class="flex gap-2">
                            <input type="number" id="filterAcresMin" placeholder="M√≠nimo" class="w-1/2 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" step="0.01">
                            <input type="number" id="filterAcresMax" placeholder="M√°ximo" class="w-1/2 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" step="0.01">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">üíµ Valor (Amount Due)</label>
                        <div class="flex gap-2">
                            <input type="number" id="filterAmountMin" placeholder="M√≠nimo" class="w-1/2 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" step="0.01">
                            <input type="number" id="filterAmountMax" placeholder="M√°ximo" class="w-1/2 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" step="0.01">
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex justify-between items-center mb-4">
                <p class="text-sm text-gray-600">
                    Mostrando <span id="filteredCount" class="font-bold text-blue-600">0</span> de <span id="totalCount" class="font-bold">0</span> propriedades
                </p>
                <div class="flex gap-3">
                    <button id="deleteFilteredBtn" class="hidden px-4 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition-colors">
                        üóëÔ∏è Deletar Propriedades Filtradas
                    </button>
                    <button id="clearFiltersBtn" class="px-4 py-2 bg-gray-500 text-white rounded-lg font-semibold hover:bg-gray-600 transition-colors">
                        ‚ùå Limpar Filtros
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table id="dataTable" class="min-w-full divide-y divide-gray-200 text-xs">
                    <thead class="bg-gray-50 text-xs font-bold uppercase">
                        <tr>
                            <th class="px-3 py-3 text-left">
                                <input type="checkbox" id="selectAllCheckbox" class="w-4 h-4 cursor-pointer">
                            </th>
                            <th class="px-2 py-2 text-center text-gray-600">
                                ‚≠ê
                            </th>
                            <th class="px-2 py-2 text-center text-gray-600">
                                #
                            </th>
                            <th class="px-2 py-2 text-left cursor-pointer hover:bg-gray-100" onclick="sortTable(0)">
                                Parcel # <span id="sort-icon-0">‚áÖ</span>
                            </th>
                            <th class="px-2 py-2 text-left cursor-pointer hover:bg-gray-100" onclick="sortTable(1)">
                                Acres <span id="sort-icon-1">‚áÖ</span>
                            </th>
                            <th class="px-2 py-2 text-left cursor-pointer hover:bg-gray-100" onclick="sortTable(2)">
                                Type <span id="sort-icon-2">‚áÖ</span>
                            </th>
                            <th class="px-2 py-2 text-left cursor-pointer hover:bg-gray-100" onclick="sortTable(3)">
                                Name <span id="sort-icon-3">‚áÖ</span>
                            </th>
                            <th class="px-2 py-2 text-left cursor-pointer hover:bg-gray-100" onclick="sortTable(4)">
                                Address <span id="sort-icon-4">‚áÖ</span>
                            </th>
                            <th class="px-2 py-2 text-left cursor-pointer hover:bg-gray-100" onclick="sortTable(5)">
                                City <span id="sort-icon-5">‚áÖ</span>
                            </th>
                            <th class="px-2 py-2 text-left cursor-pointer hover:bg-gray-100" onclick="sortTable(6)">
                                County <span id="sort-icon-6">‚áÖ</span>
                            </th>
                            <th class="px-2 py-2 text-left cursor-pointer hover:bg-gray-100" onclick="sortTable(7)">
                                Amount <span id="sort-icon-7">‚áÖ</span>
                            </th>
                            <th class="px-2 py-2 text-left cursor-pointer hover:bg-gray-100" onclick="sortTable(8)">
                                Legal Desc <span id="sort-icon-8">‚áÖ</span>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>

        <!-- Hidden file input for KML import -->
        <input type="file" id="kmlFileInput" accept=".kml,.csv" multiple class="hidden">
    </div>

    <!-- M√≥dulo de An√°lise (Ideias 11, 12, 13) - arquivo removido -->

    <script>
        // Initialize map
        const map = L.map('map').setView([27.32, -81.37], 10);
        
        // Define multiple base map styles
        const baseMaps = {
            'üó∫Ô∏è OpenStreetMap': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }),
            'üõ∞Ô∏è Satellite': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '¬© Esri, Maxar, Earthstar Geographics'
            }),
            'üåô Dark Mode': L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '¬© OpenStreetMap, ¬© CartoDB'
            }),
            'üèîÔ∏è Terrain': L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap, ¬© OpenTopoMap'
            })
        };
        
        // Add default layer
        baseMaps['üó∫Ô∏è OpenStreetMap'].addTo(map);
        
        // Add layer control (top-right corner)
        L.control.layers(baseMaps, null, { position: 'topright' }).addTo(map);

        // Layer groups
        const existingPropertiesLayer = L.layerGroup().addTo(map);
        const newPropertiesLayer = L.layerGroup().addTo(map);
        
        // Category-specific layers
        const categoryLayers = {
            available: L.layerGroup().addTo(map),
            partners: L.layerGroup().addTo(map),
            sold: L.layerGroup().addTo(map),
            blocked: L.layerGroup().addTo(map),
            outros: L.layerGroup().addTo(map)
        };

        // Data storage
        let allNewProperties = [];
        let loadedFiles = [];
        let countyData = {};

        // Counters
        let propertyCounts = {
            available: 0,
            partners: 0,
            sold: 0,
            blocked: 0,
            new: 0,
            outros: 0
        };

        // Custom marker icons with house SVG
        const createHouseIcon = (color) => L.divIcon({
            html: `<svg width="30" height="45" viewBox="0 0 30 45">
                <path d="M15 2C9 2 4 7 4 13c0 9 11 20 11 20s11-11 11-20c0-6-5-11-11-11z" fill="${color}" stroke="${color === '#1a1a1a' ? '#000' : color}" stroke-width="1.5"/>
                <g transform="translate(15, 13)">
                    <path d="M-4,-4 L0,-7 L4,-4 Z" fill="#FFF"/>
                    <rect x="-4" y="-4" width="8" height="6" fill="#FFF"/>
                    <rect x="-1.5" y="-1" width="3" height="4" fill="${color}"/>
                    <rect x="-3.5" y="-3" width="2" height="2" fill="#87CEEB"/>
                    <rect x="1.5" y="-3" width="2" height="2" fill="#87CEEB"/>
                </g>
            </svg>`,
            className: 'custom-marker',
            iconSize: [30, 45],
            iconAnchor: [15, 45],
            popupAnchor: [0, -45]
        });

        const createSoldIcon = () => L.divIcon({
            html: `<svg width="30" height="45" viewBox="0 0 30 45">
                <path d="M15 2C9 2 4 7 4 13c0 9 11 20 11 20s11-11 11-20c0-6-5-11-11-11z" fill="#99E9F2" stroke="#67C3D4" stroke-width="1.5"/>
                <g transform="translate(15, 13)">
                    <path d="M-4,-4 L0,-7 L4,-4 Z" fill="#FFF"/>
                    <rect x="-4" y="-4" width="8" height="6" fill="#FFF"/>
                    <rect x="-1.5" y="-1" width="3" height="4" fill="#99E9F2"/>
                    <rect x="-3.5" y="-3" width="2" height="2" fill="#87CEEB"/>
                    <rect x="1.5" y="-3" width="2" height="2" fill="#87CEEB"/>
                </g>
                <rect x="7.5" y="4" width="15" height="6" fill="#dc2626" rx="1"/>
                <text x="15" y="8.5" font-family="Arial" font-size="4" font-weight="bold" fill="#FFF" text-anchor="middle">SOLD</text>
            </svg>`,
            className: 'custom-marker',
            iconSize: [30, 45],
            iconAnchor: [15, 45],
            popupAnchor: [0, -45]
        });

        const createBlockedIcon = () => L.divIcon({
            html: `<svg width="30" height="45" viewBox="0 0 30 45">
                <path d="M15 2C9 2 4 7 4 13c0 9 11 20 11 20s11-11 11-20c0-6-5-11-11-11z" fill="#FCA5A5" stroke="#F87171" stroke-width="1.5"/>
                <circle cx="15" cy="13" r="5" fill="none" stroke="#FFF" stroke-width="1.5"/>
                <line x1="11.5" y1="9.5" x2="18.5" y2="16.5" stroke="#FFF" stroke-width="1.5"/>
            </svg>`,
            className: 'custom-marker',
            iconSize: [30, 45],
            iconAnchor: [15, 45],
            popupAnchor: [0, -45]
        });

        const icons = {
            available: createHouseIcon('#16a34a'),
            partners: createHouseIcon('#6b7280'),
            sold: createSoldIcon(),
            blocked: createBlockedIcon(),
            new: createHouseIcon('#facc15'),
            outros: createHouseIcon('#9CA3AF')
        };

        // Load KML files automatically
        // ORDEM IMPORTANTE: Sold/Blocked primeiro para evitar que duplicatas sejam marcadas como Available
        const kmlFiles = [
            { file: 'SoldLands.kml', type: 'sold', name: 'Sold Lands' },
            { file: 'BlockedPaused.kml', type: 'blocked', name: 'Blocked/Paused' },
            { file: 'AvailableLands.kml', type: 'available', name: 'Available Lands' },
            { file: 'PartnersAvailableLands.kml', type: 'partners', name: 'Partners Available' },
            { file: 'Outros.kml', type: 'outros', name: 'Outros' }
        ];

        let kmlLoadedCount = 0;

        // ===== SISTEMA DE DEDUPLICA√á√ÉO =====
        const seenProperties = new Map(); // Armazena propriedades j√° processadas por n√∫mero
        
        // Fun√ß√£o para extrair n√∫mero da propriedade do nome
        function extractPropertyNumber(name) {
            // Padr√µes: "P19", "P-19", "Property 19", "Property 19 - ...", etc.
            const match = name.match(/P-?(\d+)|Property\s+(\d+)/i);
            return match ? (match[1] || match[2]) : null;
        }
        
        // Fun√ß√£o para detectar se √© Point ou Polygon
        function isPoint(placemark) {
            const point = placemark.getElementsByTagName('Point')[0];
            return point !== undefined && point !== null;
        }
        
        function parseKML(kmlText, type, name) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(kmlText, 'text/xml');
            const placemarks = xmlDoc.getElementsByTagName('Placemark');
            
            for (let placemark of placemarks) {
                const nameEl = placemark.getElementsByTagName('name')[0];
                
                // Try to get Point coordinates first
                let coordsEl = placemark.getElementsByTagName('coordinates')[0];
                
                if (nameEl && coordsEl) {
                    // Get all coordinates text and split by whitespace and commas
                    const coordsText = coordsEl.textContent.trim();
                    const coordLines = coordsText.split(/\s+/);
                    
                    // Get first coordinate (for polygons, use centroid of first point)
                    const firstCoord = coordLines[0].split(',');
                    const lng = parseFloat(firstCoord[0]);
                    const lat = parseFloat(firstCoord[1]);
                    
                    if (!isNaN(lat) && !isNaN(lng)) {
                        // ===== DEDUPLICA√á√ÉO BASEADA EM N√öMERO DA PROPRIEDADE =====
                        const propertyNumber = extractPropertyNumber(nameEl.textContent);
                        const isPointGeometry = isPoint(placemark);
                        
                        let isDuplicate = false;
                        let duplicateOf = null;
                        
                        if (propertyNumber) {
                            // Verificar se j√° existe propriedade com o mesmo n√∫mero
                            if (seenProperties.has(propertyNumber)) {
                                const existingProp = seenProperties.get(propertyNumber);
                                
                                // Se a existente √© Point e a atual √© Polygon, remover a atual
                                if (existingProp.isPoint && !isPointGeometry) {
                                    isDuplicate = true;
                                    duplicateOf = existingProp.name;
                                }
                                // Se a existente √© Polygon e a atual √© Point, substituir
                                else if (!existingProp.isPoint && isPointGeometry) {
                                    console.log(`üîÑ Substituindo "${existingProp.name}" (Polygon) por "${nameEl.textContent}" (Point)`);
                                    // N√£o marcar como duplicata, vai substituir
                                }
                                // Se ambos s√£o do mesmo tipo, manter o primeiro
                                else {
                                    isDuplicate = true;
                                    duplicateOf = existingProp.name;
                                }
                            }
                        }
                        
                        if (isDuplicate) {
                            console.log(`‚ö†Ô∏è Duplicata detectada e removida: "${nameEl.textContent}" (duplicata de "${duplicateOf}")`);
                            continue; // Pular esta propriedade duplicada
                        }
                        
                        // Registrar propriedade como vista (por n√∫mero)
                        if (propertyNumber) {
                            seenProperties.set(propertyNumber, {
                                name: nameEl.textContent,
                                type: type,
                                lat: lat,
                                lng: lng,
                                isPoint: isPointGeometry
                            });
                        }
                        
                        // Criar marcador (apenas se n√£o for duplicata)
                        const marker = L.marker([lat, lng], { icon: icons[type] })
                            .bindPopup(`
                                <strong>${nameEl.textContent}</strong><br>
                                ${name}<br><br>
                                <a href="https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${lat},${lng}" target="_blank" class="inline-block bg-blue-600 px-3 py-1 rounded text-sm hover:bg-blue-700" style="color: white !important;">
                                    üìç Ver Street View
                                </a>
                            `)
                            .addTo(existingPropertiesLayer)
                            .addTo(categoryLayers[type]);
                        
                        propertyCounts[type]++;
                        // Atualizar contador em tempo real
                        const currentCount = propertyCounts[type];
                        document.getElementById(`${type}Count`).textContent = currentCount;
                        console.log(`üìç Adicionada: "${nameEl.textContent}" ‚Üí ${type} count: ${currentCount}`);
                    }
                }
            }
        }

        // Load all KML files
        if (kmlFiles.length > 0) {
            kmlFiles.forEach(({ file, type, name }) => {
                fetch(file)
                    .then(response => response.text())
                    .then(kmlText => {
                        parseKML(kmlText, type, name);
                        kmlLoadedCount++;
                        console.log(`‚úÖ ${name} carregado com sucesso!`);
                        
                        if (kmlLoadedCount === kmlFiles.length) {
                            // Mostrar contadores finais
                            console.log('\n' + '='.repeat(80));
                            console.log('üìä CONTADORES FINAIS:');
                            console.log('='.repeat(80));
                            console.log(`Available Lands: ${propertyCounts.available}`);
                            console.log(`Sold Lands: ${propertyCounts.sold}`);
                            console.log(`Blocked/Paused: ${propertyCounts.blocked}`);
                            console.log(`Partners Available: ${propertyCounts.partners}`);
                            console.log(`Outros: ${propertyCounts.outros}`);
                            console.log(`TOTAL: ${Object.values(propertyCounts).reduce((a,b) => a+b, 0)}`);
                            console.log('='.repeat(80) + '\n');
                            const layers = existingPropertiesLayer.getLayers();
                            if (layers.length > 0) {
                                const bounds = L.latLngBounds([]);
                                layers.forEach(layer => bounds.extend(layer.getLatLng()));
                                map.fitBounds(bounds, { padding: [50, 50] });
                            }
                        }
                    })
                    .catch(err => {
                        console.error(`Error loading ${file}:`, err);
                        kmlLoadedCount++;
                        
                        if (kmlLoadedCount === kmlFiles.length) {
                            const layers = existingPropertiesLayer.getLayers();
                            if (layers.length > 0) {
                                const bounds = L.latLngBounds([]);
                                layers.forEach(layer => bounds.extend(layer.getLatLng()));
                                map.fitBounds(bounds, { padding: [50, 50] });
                            }
                        }
                    });
            });
        }

        // File upload handlers
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        dropZone.addEventListener('click', () => fileInput.click());
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-blue-500', 'bg-blue-50');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('border-blue-500', 'bg-blue-50');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-blue-500', 'bg-blue-50');
            handleFiles(e.dataTransfer.files);
        });
        
        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        function handleFiles(files) {
            for (let file of files) {
                if (file.name.endsWith('.csv')) {
                    loadedFiles.push(file);
                    processCSV(file);
                }
            }
            updateFileList();
        }

        function updateFileList() {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = loadedFiles.map((file, index) => `
                <div class="flex items-center justify-between bg-green-50 border border-green-200 rounded-lg p-3 mb-2">
                    <span class="text-green-700">‚úì ${file.name}</span>
                    <button onclick="removeFile(${index})" class="text-red-600 hover:text-red-800">‚úï</button>
                </div>
            `).join('');
        }

        function removeFile(index) {
            loadedFiles.splice(index, 1);
            updateFileList();
            reprocessAllFiles();
        }

        function reprocessAllFiles() {
            allNewProperties = [];
            countyData = {};
            newPropertiesLayer.clearLayers();
            
            loadedFiles.forEach(file => processCSV(file));
        }

        function processCSV(file) {
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: (results) => {
                    // ‚úÖ VALIDA√á√ïES B√ÅSICAS
                    const validationErrors = [];
                    let validCount = 0;
                    let invalidCount = 0;
                    
                    const data = results.data.filter(row => {
                        // Validar se tem coordenadas
                        if (!row.Coordinates || !row.Coordinates.trim()) {
                            invalidCount++;
                            return false;
                        }
                        
                        // Validar coordenadas
                        const coordsStr = row.Coordinates.replace(/"/g, '').trim();
                        const coords = coordsStr.split(',');
                        const lat = parseFloat(coords[0]);
                        const lng = parseFloat(coords[1]);
                        
                        // Validar se coordenadas s√£o n√∫meros v√°lidos
                        if (isNaN(lat) || isNaN(lng)) {
                            invalidCount++;
                            validationErrors.push(`Coordenadas inv√°lidas: ${row['Parcel Number'] || 'Desconhecido'}`);
                            return false;
                        }
                        
                        // Validar se coordenadas est√£o na Fl√≥rida (lat: 24-31, lng: -87 a -80)
                        if (lat < 24 || lat > 31 || lng < -87 || lng > -80) {
                            invalidCount++;
                            validationErrors.push(`Coordenadas fora da Fl√≥rida: ${row['Parcel Number'] || 'Desconhecido'} (${lat}, ${lng})`);
                            return false;
                        }
                        
                        // Validar Parcel Number
                        if (!row['Parcel Number'] || row['Parcel Number'].trim() === '') {
                            invalidCount++;
                            validationErrors.push(`Parcel Number vazio`);
                            return false;
                        }
                        
                        // Validar Acres (deve ser > 0)
                        const acres = parseFloat(row.Acres);
                        if (isNaN(acres) || acres <= 0) {
                            invalidCount++;
                            validationErrors.push(`Acres inv√°lido: ${row['Parcel Number']} (${row.Acres})`);
                            return false;
                        }
                        
                        validCount++;
                        return true;
                    });
                    
                    // Mostrar resultado das valida√ß√µes
                    if (invalidCount > 0) {
                        console.warn(`‚ö†Ô∏è ${invalidCount} propriedades inv√°lidas foram removidas`);
                        console.warn('Erros:', validationErrors.slice(0, 10)); // Mostrar apenas primeiros 10
                        
                        showNotification(
                            `‚ö†Ô∏è ${validCount} propriedades v√°lidas importadas. ${invalidCount} inv√°lidas foram removidas.`,
                            'warning'
                        );
                    } else {
                        showNotification(
                            `‚úÖ ${validCount} propriedades importadas com sucesso!`,
                            'success'
                        );
                    }
                    
                    data.forEach(row => {
                        // Remove quotes and split coordinates
                        const coordsStr = row.Coordinates.replace(/"/g, '').trim();
                        const coords = coordsStr.split(',');
                        const lat = parseFloat(coords[0]);
                        const lng = parseFloat(coords[1]);
                        
                        if (!isNaN(lat) && !isNaN(lng)) {
                            const marker = L.marker([lat, lng], { icon: icons.new })
                                .bindPopup(`
                                    <strong>${row.Name}</strong><br>
                                    ${row.Address}<br>
                                    ${row.City}, ${row.State} ${row.Zip}<br>
                                    <strong>Parcel ID:</strong> ${row['Parcel Number']}<br>
                                    <strong>Tipo:</strong> ${row['Parcel Type'] || 'N/A'}<br>
                                    <strong>Acres:</strong> ${row.Acres}<br>
                                    <strong>Amount Due:</strong> $${row['Amount Due']}<br><br>
                                    <a href="https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${lat},${lng}" target="_blank" class="inline-block bg-blue-600 px-3 py-1 rounded text-sm hover:bg-blue-700" style="color: white !important;">
                                        üìç Ver Street View
                                    </a>
                                `)
                                .addTo(newPropertiesLayer);
                            
                            // Add click event to marker to highlight table row
                            marker.on('click', function() {
                                const tableSection = document.getElementById('tableSection');
                                const tableBody = document.getElementById('tableBody');
                                const rows = tableBody.getElementsByTagName('tr');
                                
                                // Remove previous highlights
                                for (let r of rows) {
                                    r.classList.remove('row-highlight');
                                }
                                
                                // Find row by Parcel Number (more reliable than index)
                                const parcelNumber = row['Parcel Number'];
                                for (let i = 0; i < rows.length; i++) {
                                    const rowText = rows[i].textContent;
                                    if (rowText.includes(parcelNumber)) {
                                        rows[i].classList.add('row-highlight');
                                        
                                        // Scroll to row
                                        rows[i].scrollIntoView({ behavior: 'smooth', block: 'center' });
                                        
                                        // Remove highlight after 5 seconds
                                        setTimeout(() => {
                                            rows[i].classList.remove('row-highlight');
                                        }, 5000);
                                        
                                        console.log(`‚úÖ Propriedade destacada: ${parcelNumber}`);
                                        break;
                                    }
                                }
                            });
                            
                            row.marker = marker;
                            allNewProperties.push(row);
                            
                            const county = row.County;
                            if (!countyData[county]) {
                                countyData[county] = [];
                            }
                            countyData[county].push(row);
                        }
                    });
                    
                    propertyCounts.new = allNewProperties.length;
                    updateUI();
                }
            });
        }

        function updateUI() {
            document.getElementById('newCount').textContent = propertyCounts.new;
            document.getElementById('totalProperties').textContent = propertyCounts.new;
            document.getElementById('totalCounties').textContent = Object.keys(countyData).length;
            document.getElementById('totalFiles').textContent = loadedFiles.length;
            document.getElementById('newOnMap').textContent = propertyCounts.new;
            
            // Calculate new statistics
            const totalAcres = allNewProperties.reduce((sum, p) => sum + (parseFloat(p.Acres) || 0), 0);
            const totalValue = allNewProperties.reduce((sum, p) => {
                const value = parseFloat(p['Amount Due'].replace(/[^0-9.-]+/g, '')) || 0;
                return sum + value;
            }, 0);
            const avgAcres = allNewProperties.length > 0 ? totalAcres / allNewProperties.length : 0;
            const undividedCount = allNewProperties.filter(p => 
                (p['Legal Description'] || '').toUpperCase().includes('UNDIVIDED')
            ).length;
            
            document.getElementById('totalAcres').textContent = totalAcres.toFixed(2);
            document.getElementById('totalValue').textContent = '$' + totalValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('avgAcres').textContent = avgAcres.toFixed(2);
            document.getElementById('undividedCount').textContent = undividedCount;
            
            // Alert if too many UNDIVIDED properties
            const undividedThreshold = parseInt(localStorage.getItem('undividedThreshold') || '5');
            if (undividedCount > undividedThreshold) {
                showNotification(
                    `‚ö†Ô∏è ALERTA: ${undividedCount} propriedades UNDIVIDED detectadas! (Limite: ${undividedThreshold})`,
                    'warning'
                );
            }
            
            // Check for total alert keywords
            const alertKeywords = JSON.parse(localStorage.getItem('alertKeywords') || '{"risk": ["UNDIVIDED"], "warning": [], "info": []}');
            const totalAlertsThreshold = parseInt(localStorage.getItem('totalAlertsThreshold') || '10');
            let totalAlerts = 0;
            
            allNewProperties.forEach(prop => {
                const legalDesc = (prop['Legal Description'] || '').toUpperCase();
                const allKeywords = [...(alertKeywords.risk || []), ...(alertKeywords.warning || []), ...(alertKeywords.info || [])];
                
                allKeywords.forEach(keyword => {
                    if (legalDesc.includes(keyword.toUpperCase())) {
                        totalAlerts++;
                    }
                });
            });
            
            if (totalAlerts > totalAlertsThreshold) {
                showNotification(
                    `‚ö†Ô∏è ALERTA: ${totalAlerts} propriedades com palavras-chave detectadas! (Limite: ${totalAlertsThreshold})`,
                    'warning'
                );
            }
            
            if (allNewProperties.length > 0) {
                document.getElementById('deleteNewBtn').classList.remove('hidden');
                document.getElementById('downloadsSection').classList.remove('hidden');
                document.getElementById('tableSection').classList.remove('hidden');
                
                // Restore saved filters when data is loaded
                restoreFilters();
                
                generateDownloadButtons();
                populateTable();
                
                const allLayers = [...existingPropertiesLayer.getLayers(), ...newPropertiesLayer.getLayers()];
                if (allLayers.length > 0) {
                    const bounds = L.latLngBounds([]);
                    allLayers.forEach(layer => bounds.extend(layer.getLatLng()));
                    map.fitBounds(bounds, { padding: [50, 50] });
                }
            }
        }

        function generateDownloadButtons() {
            const container = document.getElementById('downloadButtons');
            container.innerHTML = '';
            
            Object.keys(countyData).forEach(county => {
                const properties = countyData[county];
                const firstProp = properties[0];
                const date = new Date(firstProp['Next Auction']);
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const dateStr = `${day}${month}`;
                
                const button = document.createElement('button');
                button.className = 'bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors';
                button.innerHTML = `‚¨áÔ∏è ${county} - ${properties.length} propriedades`;
                button.onclick = () => downloadCountyCSV(county, dateStr, properties);
                container.appendChild(button);
            });
        }

        function downloadCountyCSV(county, dateStr, properties) {
            const csv = Papa.unparse(properties);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${county}_${dateStr}_coordinates.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function populateTable() {
            // Apply filters
            const globalSearch = document.getElementById('globalSearch').value.toLowerCase();
            const filterName = document.getElementById('filterName').value.toLowerCase();
            const filterCounty = document.getElementById('filterCounty').value;
            const filterCity = document.getElementById('filterCity').value;
            const filterType = document.getElementById('filterType').value;
            const filterAcresMin = parseFloat(document.getElementById('filterAcresMin').value) || 0;
            const filterAcresMax = parseFloat(document.getElementById('filterAcresMax').value) || Infinity;
            const filterAmountMin = parseFloat(document.getElementById('filterAmountMin').value) || 0;
            const filterAmountMax = parseFloat(document.getElementById('filterAmountMax').value) || Infinity;
            
            // Get favorites list
            const favorites = JSON.parse(localStorage.getItem('gtSearchFavorites') || '[]');
            
            const filteredProperties = allNewProperties.filter(row => {
                const acres = parseFloat(row.Acres) || 0;
                const amount = parseFloat(row['Amount Due']) || 0;
                const name = (row.Name || '').toLowerCase();
                const type = row['Parcel Type'] || '';
                
                // Favorites filter
                const favoriteMatch = !showingFavoritesOnly || favorites.includes(row['Parcel Number']);
                
                // Global search - searches across multiple fields
                const globalMatch = !globalSearch || [
                    row['Parcel Number'],
                    row.Name,
                    row.Address,
                    row.City,
                    row.County,
                    row['Legal Description']
                ].some(field => (field || '').toLowerCase().includes(globalSearch));
                
                return (
                    favoriteMatch &&
                    globalMatch &&
                    (!filterName || name.includes(filterName)) &&
                    (!filterCounty || row.County === filterCounty) &&
                    (!filterCity || row.City === filterCity) &&
                    (!filterType || type === filterType) &&
                    (acres >= filterAcresMin && acres <= filterAcresMax) &&
                    (amount >= filterAmountMin && amount <= filterAmountMax)
                );
            });
            
            // Update favorites count
            const favCount = allNewProperties.filter(p => favorites.includes(p['Parcel Number'])).length;
            const favCountElements = document.querySelectorAll('#favoritesCount');
            favCountElements.forEach(el => el.textContent = favCount);
            
            // Store filtered properties globally for delete function
            window.currentFilteredProperties = filteredProperties;
            
            // Update counters
            document.getElementById('totalCount').textContent = allNewProperties.length;
            document.getElementById('filteredCount').textContent = filteredProperties.length;
            
            // Show/hide delete filtered button
            const deleteFilteredBtn = document.getElementById('deleteFilteredBtn');
            const hasActiveFilters = filterName || filterCounty || filterCity || filterType || 
                                     filterAcresMin > 0 || filterAcresMax < Infinity || 
                                     filterAmountMin > 0 || filterAmountMax < Infinity;
            
            if (hasActiveFilters && filteredProperties.length > 0 && filteredProperties.length < allNewProperties.length) {
                deleteFilteredBtn.classList.remove('hidden');
            } else {
                deleteFilteredBtn.classList.add('hidden');
            }
            
            // Populate county dropdown
            const countySelect = document.getElementById('filterCounty');
            const currentCounty = countySelect.value;
            const counties = [...new Set(allNewProperties.map(p => p.County))].sort();
            countySelect.innerHTML = '<option value="">Todos os Condados</option>' + 
                counties.map(c => `<option value="${c}" ${c === currentCounty ? 'selected' : ''}>${c}</option>`).join('');
            
            // Populate city dropdown
            const citySelect = document.getElementById('filterCity');
            const currentCity = citySelect.value;
            const cities = [...new Set(allNewProperties.map(p => p.City).filter(c => c))].sort();
            citySelect.innerHTML = '<option value="">Todas as Cidades</option>' + 
                cities.map(c => `<option value="${c}" ${c === currentCity ? 'selected' : ''}>${c}</option>`).join('');
            
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = filteredProperties.map((row, index) => {
                const originalIndex = allNewProperties.indexOf(row);
                const legalDesc = (row['Legal Description'] || '').toUpperCase();
                const hasUndivided = legalDesc.includes('UNDIVIDED');
                
                // Check for custom alert keywords
                const alertKeywords = JSON.parse(localStorage.getItem('alertKeywords') || '{"risk": ["UNDIVIDED"], "warning": [], "info": []}');
                let alertBadges = '';
                let rowClass = 'hover:bg-blue-50 transition-colors text-[10px]';
                
                // Check risk keywords (red)
                if (alertKeywords.risk) {
                    alertKeywords.risk.forEach(keyword => {
                        if (legalDesc.includes(keyword.toUpperCase())) {
                            alertBadges += `<span class="alert-badge alert-risk">‚ö†Ô∏è ${keyword}</span> `;
                            rowClass = 'alert-row-risk text-[10px]';
                        }
                    });
                }
                
                // Check warning keywords (yellow)
                if (alertKeywords.warning && !alertBadges) {
                    alertKeywords.warning.forEach(keyword => {
                        if (legalDesc.includes(keyword.toUpperCase())) {
                            alertBadges += `<span class="alert-badge alert-warning">‚ö° ${keyword}</span> `;
                            if (rowClass === 'hover:bg-blue-50 transition-colors text-[10px]') {
                                rowClass = 'alert-row-warning text-[10px]';
                            }
                        }
                    });
                }
                
                // Check info keywords (blue)
                if (alertKeywords.info && !alertBadges) {
                    alertKeywords.info.forEach(keyword => {
                        if (legalDesc.includes(keyword.toUpperCase())) {
                            alertBadges += `<span class="alert-badge alert-info">‚ÑπÔ∏è ${keyword}</span> `;
                            if (rowClass === 'hover:bg-blue-50 transition-colors text-[10px]') {
                                rowClass = 'alert-row-info text-[10px]';
                            }
                        }
                    });
                }
                
                // Acres color coding
                const acres = parseFloat(row.Acres) || 0;
                let acresClass = '';
                if (acres < 0.25) acresClass = 'acres-small';
                else if (acres <= 0.5) acresClass = 'acres-medium';
                else acresClass = 'acres-large';
                
                // Check if property is favorited
                const favorites = JSON.parse(localStorage.getItem('gtSearchFavorites') || '[]');
                const isFavorite = favorites.includes(row['Parcel Number']);
                const starIcon = isFavorite ? '‚≠ê' : '‚òÜ';
                
                // Create a clean copy without marker (to avoid circular reference)
                const cleanRow = Object.assign({}, row);
                delete cleanRow.marker;
                
                return `
                <tr class="${rowClass}" data-index="${originalIndex}">
                    <td class="px-2 py-1 whitespace-nowrap text-center">
                        <input type="checkbox" class="row-checkbox w-3 h-3 cursor-pointer" data-index="${originalIndex}" data-property='${JSON.stringify(cleanRow).replace(/'/g, "&apos;")}'>
                    </td>
                    <td class="px-1 py-0.5 whitespace-nowrap text-center">
                        <button class="favorite-btn text-xl hover:scale-125 transition-transform" data-parcel="${row['Parcel Number']}" title="${isFavorite ? 'Remover dos favoritos' : 'Adicionar aos favoritos'}">${starIcon}</button>
                    </td>
                    <td class="px-1 py-0.5 whitespace-nowrap text-center text-gray-500 font-medium">${index + 1}</td>
                    <td class="px-1 py-0.5 whitespace-nowrap">${alertBadges}${row['Parcel Number']}</td>
                    <td class="px-1 py-0.5 whitespace-nowrap ${acresClass} font-semibold">${row.Acres}</td>
                    <td class="px-1 py-0.5 whitespace-nowrap">${row['Parcel Type'] || 'N/A'}</td>
                    <td class="px-1 py-0.5 whitespace-nowrap cursor-pointer">${row.Name}</td>
                    <td class="px-1 py-0.5 whitespace-nowrap">${row.Address}</td>
                    <td class="px-1 py-0.5 whitespace-nowrap">${row.City}</td>
                    <td class="px-1 py-0.5 whitespace-nowrap">${row.County}</td>
                    <td class="px-1 py-0.5 whitespace-nowrap">$${row['Amount Due']}</td>
                    <td class="px-1 py-0.5 whitespace-nowrap">${(row['Legal Description'] || 'N/A').substring(0, 50)}...</td>
                </tr>
            `}).join('');
            
            const rows = tbody.querySelectorAll('tr');
            rows.forEach(row => {
                row.addEventListener('click', (e) => {
                    // Don't trigger if clicking checkbox
                    if (e.target.type === 'checkbox') return;
                    
                    const index = parseInt(row.getAttribute('data-index'));
                    const property = allNewProperties[index];
                    
                    if (property && property.marker) {
                        // Center on map with animation
                        map.setView(property.marker.getLatLng(), 16);
                        
                        // Open popup
                        property.marker.openPopup();
                        
                        // Add bounce animation to marker
                        const markerElement = property.marker.getElement();
                        if (markerElement) {
                            markerElement.classList.add('marker-bounce');
                            setTimeout(() => {
                                markerElement.classList.remove('marker-bounce');
                            }, 1800);
                        }
                        
                        // Scroll to top
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                });
            });
            
            // Setup favorite button listeners
            const favoriteButtons = tbody.querySelectorAll('.favorite-btn');
            favoriteButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation(); // Don't trigger row click
                    const parcelNumber = btn.getAttribute('data-parcel');
                    toggleFavorite(parcelNumber);
                });
            });
            
            // Setup checkbox listeners
            setupCheckboxListeners();
        }
        
        // Favorites management
        function toggleFavorite(parcelNumber) {
            let favorites = JSON.parse(localStorage.getItem('gtSearchFavorites') || '[]');
            const index = favorites.indexOf(parcelNumber);
            
            if (index > -1) {
                // Remove from favorites
                favorites.splice(index, 1);
            } else {
                // Add to favorites
                favorites.push(parcelNumber);
            }
            
            localStorage.setItem('gtSearchFavorites', JSON.stringify(favorites));
            populateTable(); // Refresh table to update star icons
        }

        // Dropdown menu toggle
        const deleteOldDropdown = document.getElementById('deleteOldDropdown');
        const deleteOldMenu = document.getElementById('deleteOldMenu');
        
        deleteOldDropdown.addEventListener('click', (e) => {
            e.stopPropagation();
            deleteOldMenu.classList.toggle('hidden');
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', () => {
            deleteOldMenu.classList.add('hidden');
        });
        
        deleteOldMenu.addEventListener('click', (e) => {
            e.stopPropagation();
        });
        
        // Delete specific category
        const deleteCategoryButtons = document.querySelectorAll('.delete-category-btn');
        deleteCategoryButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const category = btn.getAttribute('data-category');
                const categoryNames = {
                    available: 'Available Lands',
                    partners: 'Partners Available',
                    sold: 'Sold Lands',
                    blocked: 'Blocked/Paused',
                    outros: 'Outros'
                };
                
                if (confirm(`Tem certeza que deseja deletar ${categoryNames[category]}?`)) {
                    categoryLayers[category].clearLayers();
                    propertyCounts[category] = 0;
                    document.getElementById(`${category}Count`).textContent = 0;
                    deleteOldMenu.classList.add('hidden');
                    
                    // Adjust map view
                    const allLayers = [...existingPropertiesLayer.getLayers(), ...newPropertiesLayer.getLayers()];
                    if (allLayers.length > 0) {
                        const bounds = L.latLngBounds([]);
                        allLayers.forEach(layer => bounds.extend(layer.getLatLng()));
                        map.fitBounds(bounds, { padding: [50, 50] });
                    } else {
                        map.setView([27.32, -81.37], 10);
                    }
                }
            });
        });
        
        // Delete all old properties
        document.getElementById('deleteAllOldBtn').addEventListener('click', () => {
            if (confirm('Tem certeza que deseja deletar TODAS as propriedades antigas (KML)?')) {
                existingPropertiesLayer.clearLayers();
                Object.keys(categoryLayers).forEach(cat => {
                    categoryLayers[cat].clearLayers();
                    propertyCounts[cat] = 0;
                    document.getElementById(`${cat}Count`).textContent = 0;
                });
                
                deleteOldMenu.classList.add('hidden');
                
                const newLayers = newPropertiesLayer.getLayers();
                if (newLayers.length > 0) {
                    const bounds = L.latLngBounds([]);
                    newLayers.forEach(layer => bounds.extend(layer.getLatLng()));
                    map.fitBounds(bounds, { padding: [50, 50] });
                } else {
                    map.setView([27.32, -81.37], 10);
                }
            }
        });

        // Delete new properties
        document.getElementById('deleteNewBtn').addEventListener('click', () => {
            if (confirm('Tem certeza que deseja deletar todas as novas propriedades?')) {
                allNewProperties = [];
                countyData = {};
                loadedFiles = [];
                newPropertiesLayer.clearLayers();
                propertyCounts.new = 0;
                
                document.getElementById('deleteNewBtn').classList.add('hidden');
                document.getElementById('downloadsSection').classList.add('hidden');
                document.getElementById('tableSection').classList.add('hidden');
                document.getElementById('fileList').innerHTML = '';
                
                updateUI();
                
                const layers = existingPropertiesLayer.getLayers();
                if (layers.length > 0) {
                    const bounds = L.latLngBounds([]);
                    layers.forEach(layer => bounds.extend(layer.getLatLng()));
                    map.fitBounds(bounds, { padding: [50, 50] });
                }
            }
        });

        // Import KML functionality
        const kmlFileInput = document.getElementById('kmlFileInput');
        document.getElementById('importKMLBtn').addEventListener('click', () => {
            kmlFileInput.click();
        });

        // Function to parse CSV from Google My Maps
        function parseCSV(csvText, type, name) {
            const lines = csvText.split('\n');
            let count = 0;
            
            for (let i = 1; i < lines.length; i++) { // Skip header
                const line = lines[i].trim();
                if (!line) continue;
                
                // Parse CSV line (handle quoted fields)
                const match = line.match(/^"([^"]+)","?([^"]*?)"?,?/);
                if (!match) continue;
                
                const geom = match[1];
                const propName = match[2] || `Property ${i}`;
                
                let lat, lng;
                
                // Extract coordinates from POINT (-81.40599 27.25065)
                const pointMatch = geom.match(/POINT \(([^ ]+) ([^ ]+)\)/);
                if (pointMatch) {
                    lng = parseFloat(pointMatch[1]);
                    lat = parseFloat(pointMatch[2]);
                } else {
                    // Extract from POLYGON ((-81.406225 27.250928, ...))
                    const polygonMatch = geom.match(/POLYGON \(\(([^ ]+) ([^ ]+),/);
                    if (polygonMatch) {
                        lng = parseFloat(polygonMatch[1]);
                        lat = parseFloat(polygonMatch[2]);
                    }
                }
                
                if (!isNaN(lat) && !isNaN(lng)) {
                    const marker = L.marker([lat, lng], { icon: icons[type] })
                        .bindPopup(`<strong>${propName}</strong><br>${name}`)
                        .addTo(existingPropertiesLayer)
                        .addTo(categoryLayers[type]);
                    
                    count++;
                    propertyCounts[type]++;
                }
            }
            
            document.getElementById(`${type}Count`).textContent = propertyCounts[type];
            console.log(`Imported ${count} properties from CSV`);
        }

        kmlFileInput.addEventListener('change', (e) => {
            const files = e.target.files;
            for (let file of files) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const fileContent = event.target.result;
                    let type = 'available';
                    let name = file.name.replace(/\.(kml|csv)$/, '');
                    
                    // Determine type from filename
                    if (file.name.toLowerCase().includes('sold')) {
                        type = 'sold';
                    } else if (file.name.toLowerCase().includes('blocked') || file.name.toLowerCase().includes('paused')) {
                        type = 'blocked';
                    } else if (file.name.toLowerCase().includes('partner')) {
                        type = 'partners';
                    }
                    
                    // Parse based on file type
                    if (file.name.endsWith('.kml')) {
                        parseKML(fileContent, type, name);
                    } else if (file.name.endsWith('.csv')) {
                        parseCSV(fileContent, type, name);
                    }
                    
                    // Adjust map view
                    const layers = existingPropertiesLayer.getLayers();
                    if (layers.length > 0) {
                        const bounds = L.latLngBounds([]);
                        layers.forEach(layer => bounds.extend(layer.getLatLng()));
                        map.fitBounds(bounds, { padding: [50, 50] });
                    }
                };
                reader.readAsText(file);
            }
        });

        // Global Search event listeners
        document.getElementById('globalSearch').addEventListener('input', function() {
            const value = this.value;
            const clearBtn = document.getElementById('clearGlobalSearch');
            if (value) {
                clearBtn.classList.remove('hidden');
            } else {
                clearBtn.classList.add('hidden');
            }
            saveFilters();
            populateTable();
        });
        
        document.getElementById('clearGlobalSearch').addEventListener('click', function() {
            document.getElementById('globalSearch').value = '';
            this.classList.add('hidden');
            populateTable();
        });
        
        // Filter event listeners (with auto-save)
        document.getElementById('filterName').addEventListener('input', () => { saveFilters(); populateTable(); });
        document.getElementById('filterCounty').addEventListener('change', () => { saveFilters(); populateTable(); });
        document.getElementById('filterCity').addEventListener('change', () => { saveFilters(); populateTable(); });
        document.getElementById('filterType').addEventListener('change', () => { saveFilters(); populateTable(); });
        document.getElementById('filterAcresMin').addEventListener('input', () => { saveFilters(); populateTable(); });
        document.getElementById('filterAcresMax').addEventListener('input', () => { saveFilters(); populateTable(); });
        document.getElementById('filterAmountMin').addEventListener('input', () => { saveFilters(); populateTable(); });
        document.getElementById('filterAmountMax').addEventListener('input', () => { saveFilters(); populateTable(); });
        
        // Auto-save filters to localStorage
        function saveFilters() {
            const filters = {
                globalSearch: document.getElementById('globalSearch').value,
                filterName: document.getElementById('filterName').value,
                filterCounty: document.getElementById('filterCounty').value,
                filterCity: document.getElementById('filterCity').value,
                filterType: document.getElementById('filterType').value,
                filterAcresMin: document.getElementById('filterAcresMin').value,
                filterAcresMax: document.getElementById('filterAcresMax').value,
                filterAmountMin: document.getElementById('filterAmountMin').value,
                filterAmountMax: document.getElementById('filterAmountMax').value
            };
            localStorage.setItem('gtSearchFilters', JSON.stringify(filters));
        }
        
        // Restore filters from localStorage
        function restoreFilters() {
            const saved = localStorage.getItem('gtSearchFilters');
            if (saved) {
                try {
                    const filters = JSON.parse(saved);
                    document.getElementById('globalSearch').value = filters.globalSearch || '';
                    document.getElementById('filterName').value = filters.filterName || '';
                    document.getElementById('filterCounty').value = filters.filterCounty || '';
                    document.getElementById('filterCity').value = filters.filterCity || '';
                    document.getElementById('filterType').value = filters.filterType || '';
                    document.getElementById('filterAcresMin').value = filters.filterAcresMin || '';
                    document.getElementById('filterAcresMax').value = filters.filterAcresMax || '';
                    document.getElementById('filterAmountMin').value = filters.filterAmountMin || '';
                    document.getElementById('filterAmountMax').value = filters.filterAmountMax || '';
                    
                    // Show clear button if global search has value
                    if (filters.globalSearch) {
                        document.getElementById('clearGlobalSearch').classList.remove('hidden');
                    }
                } catch (e) {
                    console.error('Error restoring filters:', e);
                }
            }
        }
        
        document.getElementById('clearFiltersBtn').addEventListener('click', () => {
            document.getElementById('filterName').value = '';
            document.getElementById('filterCounty').value = '';
            document.getElementById('filterCity').value = '';
            document.getElementById('filterType').value = '';
            document.getElementById('filterAcresMin').value = '';
            document.getElementById('filterAcresMax').value = '';
            document.getElementById('filterAmountMin').value = '';
            document.getElementById('filterAmountMax').value = '';
            document.getElementById('globalSearch').value = '';
            document.getElementById('clearGlobalSearch').classList.add('hidden');
            saveFilters();
            populateTable();
        });
        
        // Delete filtered properties
        document.getElementById('deleteFilteredBtn').addEventListener('click', () => {
            const filteredProps = window.currentFilteredProperties || [];
            if (filteredProps.length === 0) return;
            
            const count = filteredProps.length;
            if (!confirm(`Tem certeza que deseja deletar ${count} propriedade(s) filtrada(s)?\n\nEsta a√ß√£o n√£o pode ser desfeita!`)) {
                return;
            }
            
            // Remove from map
            filteredProps.forEach(prop => {
                if (prop.marker) {
                    newPropertiesLayer.removeLayer(prop.marker);
                }
            });
            
            // Remove from allNewProperties array
            allNewProperties = allNewProperties.filter(prop => !filteredProps.includes(prop));
            
            // Rebuild countyData
            countyData = {};
            allNewProperties.forEach(row => {
                const county = row.County;
                if (!countyData[county]) {
                    countyData[county] = [];
                }
                countyData[county].push(row);
            });
            
            // Save to localStorage
            localStorage.setItem('allNewProperties', JSON.stringify(allNewProperties));
            
            // Update UI
            propertyCounts.new = allNewProperties.length;
            updateUI();
            
            alert(`${count} propriedade(s) deletada(s) com sucesso!`);
        });

        // Checkbox and selection functionality
        function setupCheckboxListeners() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const rowCheckboxes = document.querySelectorAll('.row-checkbox');
            const analyzeSelectedBtn = document.getElementById('analyzeSelectedBtn');
            const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
            const exportSelectedBtn = document.getElementById('exportSelectedBtn');
            
            // Select all checkbox
            selectAllCheckbox.addEventListener('change', () => {
                rowCheckboxes.forEach(cb => cb.checked = selectAllCheckbox.checked);
                updateSelectionButtons();
            });
            
            // Individual checkboxes
            rowCheckboxes.forEach(cb => {
                cb.addEventListener('change', () => {
                    updateSelectionButtons();
                    // Update select all checkbox
                    const allChecked = Array.from(rowCheckboxes).every(c => c.checked);
                    selectAllCheckbox.checked = allChecked;
                });
            });
            
            // Delete selected button
            deleteSelectedBtn.addEventListener('click', deleteSelectedProperties);
            
            // Export selected button
            exportSelectedBtn.addEventListener('click', showExportOptions);
            
            // Save for analysis button
            const saveForAnalysisBtn = document.getElementById('saveForAnalysisBtn');
            saveForAnalysisBtn.addEventListener('click', saveSelectedForAnalysis);
            
            // View selected button
            const viewSelectedBtn = document.getElementById('viewSelectedBtn');
            viewSelectedBtn.addEventListener('click', viewSelectedProperties);
        }
        
        function viewSelectedProperties() {
            const rowCheckboxes = document.querySelectorAll('.row-checkbox:checked');
            
            if (rowCheckboxes.length === 0) {
                alert('Nenhuma propriedade selecionada!');
                return;
            }
            
            const selectedProperties = Array.from(rowCheckboxes)
                .map(cb => {
                    try {
                        const propData = cb.getAttribute('data-property');
                        return JSON.parse(propData.replace(/&apos;/g, "'"));
                    } catch (e) {
                        console.error('Erro ao parsear propriedade:', e);
                        return null;
                    }
                })
                .filter(p => p);
            
            // Save to localStorage
            localStorage.setItem('selectedPropertiesForCards', JSON.stringify(selectedProperties));
            
            // Navigate to cards page
            window.location.href = 'selected-cards.html';
        }
        
        function updateSelectionButtons() {
            const rowCheckboxes = document.querySelectorAll('.row-checkbox');
            const checkedCount = Array.from(rowCheckboxes).filter(cb => cb.checked).length;
            const analyzeSelectedBtn = document.getElementById('analyzeSelectedBtn');
            const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
            const exportSelectedBtn = document.getElementById('exportSelectedBtn');
            
            const saveForAnalysisBtn = document.getElementById('saveForAnalysisBtn');
            const viewSelectedBtn = document.getElementById('viewSelectedBtn');
            
            if (checkedCount > 0) {
                analyzeSelectedBtn.classList.remove('hidden');
                deleteSelectedBtn.classList.remove('hidden');
                exportSelectedBtn.classList.remove('hidden');
                saveForAnalysisBtn.classList.remove('hidden');
                viewSelectedBtn.classList.remove('hidden');
            } else {
                analyzeSelectedBtn.classList.add('hidden');
                deleteSelectedBtn.classList.add('hidden');
                exportSelectedBtn.classList.add('hidden');
                saveForAnalysisBtn.classList.add('hidden');
                viewSelectedBtn.classList.add('hidden');
            }
        }
        
        function saveSelectedForAnalysis() {
            console.log('üíú Bot√£o Salvar para An√°lise clicado!');
            
            const rowCheckboxes = document.querySelectorAll('.row-checkbox:checked');
            
            if (rowCheckboxes.length === 0) {
                alert('Nenhuma propriedade selecionada!');
                return;
            }
            
            const selectedProperties = Array.from(rowCheckboxes)
                .map(cb => {
                    const index = parseInt(cb.getAttribute('data-index'));
                    return allNewProperties[index];
                })
                .filter(p => p);
            
            // Salvar no localStorage
            localStorage.setItem('properties', JSON.stringify(selectedProperties));
            
            alert(`‚úÖ ${selectedProperties.length} propriedades salvas para an√°lise!\n\nVoc√™ pode abrir a p√°gina de an√°lise (analysis2.html) para analis√°-las.`);
            
            console.log(`üíæ ${selectedProperties.length} propriedades salvas no localStorage`);
        }
        
        function analyzeSelectedProperties() {
            console.log('üîµ Bot√£o Analisar Selecionadas clicado!');
            
            const rowCheckboxes = document.querySelectorAll('.row-checkbox:checked');
            console.log('Checkboxes marcados:', rowCheckboxes.length);
            
            if (rowCheckboxes.length === 0) {
                alert('Selecione pelo menos uma propriedade para analisar.');
                return;
            }
            
            // Get selected properties data from data-property attribute (more reliable)
            const selectedProperties = [];
            rowCheckboxes.forEach(function(checkbox) {
                try {
                    const propData = checkbox.getAttribute('data-property');
                    if (propData) {
                        const prop = JSON.parse(propData.replace(/&apos;/g, "'"));
                        selectedProperties.push(prop);
                        console.log('Propriedade adicionada:', prop['Parcel Number']);
                    } else {
                        console.error('Checkbox sem data-property!');
                    }
                } catch (e) {
                    console.error('Erro ao parsear propriedade:', e);
                }
            });
            
            console.log('Propriedades selecionadas:', selectedProperties.length);
            
            if (selectedProperties.length === 0) {
                alert('Erro: N√£o foi poss√≠vel coletar os dados das propriedades!');
                return;
            }
            
            // Save selected properties for analysis
            localStorage.setItem('selectedProperties', JSON.stringify(selectedProperties));
            console.log('Salvo no localStorage:', selectedProperties.length, 'propriedades');
            
            // Redirect to analysis page
            window.location.href = 'analysis2.html';
        }
        
        function deleteSelectedProperties() {
            const rowCheckboxes = document.querySelectorAll('.row-checkbox:checked');
            
            if (rowCheckboxes.length === 0) return;
            
            if (!confirm(`Tem certeza que deseja deletar ${rowCheckboxes.length} propriedade(s) selecionada(s)?`)) {
                return;
            }
            
            // Get indices to delete (in reverse order to avoid index shifting)
            const indicesToDelete = Array.from(rowCheckboxes)
                .map(cb => parseInt(cb.getAttribute('data-index')))
                .sort((a, b) => b - a);
            
            // Remove from array
            indicesToDelete.forEach(index => {
                allNewProperties.splice(index, 1);
            });
            
            // Clear all yellow markers from map
            newPropertiesLayer.clearLayers();
            
            // Re-add markers for remaining properties
            allNewProperties.forEach(row => {
                const coordsStr = row.Coordinates.replace(/"/g, '').trim();
                const coords = coordsStr.split(',');
                const lat = parseFloat(coords[0]);
                const lng = parseFloat(coords[1]);
                
                if (!isNaN(lat) && !isNaN(lng)) {
                    const marker = L.marker([lat, lng], { icon: icons.new })
                        .bindPopup(`
                            <strong>${row.Name}</strong><br>
                            ${row.Address}<br>
                            ${row.City}, ${row.State} ${row.Zip}<br>
                            <strong>Parcel ID:</strong> ${row['Parcel Number']}<br>
                            <strong>Tipo:</strong> ${row['Parcel Type'] || 'N/A'}<br>
                            <strong>Acres:</strong> ${row.Acres}<br>
                            <strong>Amount Due:</strong> $${row['Amount Due']}<br><br>
                            <a href="https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${lat},${lng}" target="_blank" class="inline-block bg-blue-600 px-3 py-1 rounded text-sm hover:bg-blue-700" style="color: white !important;">
                                üìç Ver Street View
                            </a>
                        `)
                        .addTo(newPropertiesLayer);
                }
            });
            
            // Rebuild county data
            countyData = {};
            allNewProperties.forEach(row => {
                const county = row.County;
                if (!countyData[county]) {
                    countyData[county] = [];
                }
                countyData[county].push(row);
            });
            
            // Update UI
            propertyCounts.new = allNewProperties.length;
            updateUI();
            
            // Uncheck select all
            document.getElementById('selectAllCheckbox').checked = false;
        }
        
        function showExportOptions() {
            // Show export modal
            const modal = document.getElementById('exportModal');
            if (modal) {
                modal.classList.remove('hidden');
                loadExportTemplates();
            }
        }
        
        // Export Templates Management
        function saveExportTemplate() {
            const templateName = prompt('Nome do template:');
            if (!templateName) return;
            
            const selectedColumns = Array.from(document.querySelectorAll('.column-checkbox:checked'))
                .map(cb => cb.value);
            
            const templates = JSON.parse(localStorage.getItem('exportTemplates') || '{}');
            templates[templateName] = selectedColumns;
            localStorage.setItem('exportTemplates', JSON.stringify(templates));
            
            loadExportTemplates();
            alert(`‚úÖ Template "${templateName}" salvo!`);
        }
        
        function loadExportTemplates() {
            const templates = JSON.parse(localStorage.getItem('exportTemplates') || '{}');
            const select = document.getElementById('templateSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">-- Selecione um template --</option>';
            Object.keys(templates).forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            });
        }
        
        function applyExportTemplate() {
            const select = document.getElementById('templateSelect');
            const templateName = select.value;
            if (!templateName) return;
            
            const templates = JSON.parse(localStorage.getItem('exportTemplates') || '{}');
            const columns = templates[templateName];
            
            // Uncheck all
            document.querySelectorAll('.column-checkbox').forEach(cb => cb.checked = false);
            
            // Check template columns
            columns.forEach(col => {
                const checkbox = document.querySelector(`.column-checkbox[value="${col}"]`);
                if (checkbox) checkbox.checked = true;
            });
        }
        
        function deleteExportTemplate() {
            const select = document.getElementById('templateSelect');
            const templateName = select.value;
            if (!templateName) return;
            
            if (!confirm(`Deletar template "${templateName}"?`)) return;
            
            const templates = JSON.parse(localStorage.getItem('exportTemplates') || '{}');
            delete templates[templateName];
            localStorage.setItem('exportTemplates', JSON.stringify(templates));
            
            loadExportTemplates();
            alert(`‚úÖ Template "${templateName}" deletado!`);
        }
        
        function exportSelectedAsCSV(selectedColumns = null) {
            const rowCheckboxes = document.querySelectorAll('.row-checkbox:checked');
            
            if (rowCheckboxes.length === 0) {
                alert('Nenhuma propriedade selecionada!');
                return;
            }
            
            let selectedProperties = Array.from(rowCheckboxes)
                .map(cb => {
                    try {
                        const propData = cb.getAttribute('data-property');
                        return JSON.parse(propData.replace(/&apos;/g, "'"));
                    } catch (e) {
                        console.error('Erro ao parsear propriedade:', e);
                        return null;
                    }
                })
                .filter(p => p);
            
            // Filter columns if specified
            if (selectedColumns && selectedColumns.length > 0) {
                selectedProperties = selectedProperties.map(prop => {
                    const filtered = {};
                    selectedColumns.forEach(col => {
                        if (prop.hasOwnProperty(col)) {
                            filtered[col] = prop[col];
                        }
                    });
                    return filtered;
                });
            }
            
            const csv = Papa.unparse(selectedProperties);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const date = new Date();
            const dateStr = `${String(date.getDate()).padStart(2, '0')}${String(date.getMonth() + 1).padStart(2, '0')}`;
            a.download = `selected_properties_${dateStr}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            // Close modal if open
            const modal = document.getElementById('exportModal');
            if (modal) modal.classList.add('hidden');
            
            // Show success notification
            showNotification(`‚úÖ ${rowCheckboxes.length} propriedades exportadas com sucesso!`, 'success');
        }
        
        function exportSelectedAsKML() {
            const rowCheckboxes = document.querySelectorAll('.row-checkbox:checked');
            
            if (rowCheckboxes.length === 0) {
                alert('Nenhuma propriedade selecionada!');
                return;
            }
            
            const selectedProperties = Array.from(rowCheckboxes)
                .map(cb => {
                    const index = parseInt(cb.getAttribute('data-index'));
                    return allNewProperties[index];
                })
                .filter(p => p);
            
            let kml = `<?xml version="1.0" encoding="UTF-8"?>\n`;
            kml += `<kml xmlns="http://www.opengis.net/kml/2.2">\n`;
            kml += `  <Document>\n`;
            kml += `    <name>Selected Properties</name>\n`;
            
            selectedProperties.forEach(prop => {
                kml += `    <Placemark>\n`;
                kml += `      <name>${prop.Name}</name>\n`;
                kml += `      <description>Parcel ID: ${prop['Parcel Number']}\nAcres: ${prop.Acres}\nAmount Due: $${prop['Amount Due']}</description>\n`;
                kml += `      <Point>\n`;
                kml += `        <coordinates>${prop.Longitude},${prop.Latitude},0</coordinates>\n`;
                kml += `      </Point>\n`;
                kml += `    </Placemark>\n`;
            });
            
            kml += `  </Document>\n`;
            kml += `</kml>`;
            
            const blob = new Blob([kml], { type: 'application/vnd.google-earth.kml+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const date = new Date();
            const dateStr = `${String(date.getDate()).padStart(2, '0')}${String(date.getMonth() + 1).padStart(2, '0')}`;
            a.download = `selected_properties_${dateStr}.kml`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Dark Mode functionality
        const darkModeToggle = document.getElementById('darkModeToggle');
        const darkModeIcon = document.getElementById('darkModeIcon');
        const darkModeText = document.getElementById('darkModeText');
        const body = document.body;
        
        // Check saved preference
        const isDarkMode = localStorage.getItem('darkMode') === 'true';
        if (isDarkMode) {
            body.classList.add('dark-mode');
            darkModeIcon.textContent = '‚òÄÔ∏è';
            darkModeText.textContent = 'Modo Claro';
        }
        
        // ============================================
        // FUN√á√ïES DE AN√ÅLISE (IDEIAS 11, 12, 13)
        // ============================================

        // Fun√ß√µes auxiliares
        function showLoading(message) {
            const loading = document.createElement('div');
            loading.id = 'loadingModal';
            loading.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            loading.innerHTML = `
                <div class="bg-white rounded-lg p-8 text-center">
                    <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600 mx-auto mb-4"></div>
                    <p class="text-lg font-semibold text-gray-800">${message}</p>
                </div>
            `;
            document.body.appendChild(loading);
        }

        function hideLoading() {
            const loading = document.getElementById('loadingModal');
            if (loading) loading.remove();
        }

        // Armazenar propriedades globalmente
        window.allProperties = allNewProperties;

        // Fun√ß√µes de navega√ß√£o para an√°lise
        window.openPropertyAnalysis = function(parcelNumber) {
            const property = allNewProperties.find(p => p['Parcel Number'] === parcelNumber);
            if (!property) {
                alert('‚ùå Propriedade n√£o encontrada!');
                return;
            }
            
            // Salvar dados no localStorage
            localStorage.setItem('currentProperty', JSON.stringify(property));
            localStorage.setItem('allProperties', JSON.stringify(allNewProperties));
            
            // Redirecionar para tela de an√°lise
            window.location.href = 'screen2-prototype.html';
        };

        window.openCompsAnalysis = function(parcelNumber) {
            const property = allNewProperties.find(p => p['Parcel Number'] === parcelNumber);
            if (!property) {
                alert('‚ùå Propriedade n√£o encontrada!');
                return;
            }
            
            // Salvar dados no localStorage
            localStorage.setItem('currentProperty', JSON.stringify(property));
            localStorage.setItem('allProperties', JSON.stringify(allNewProperties));
            
            // Redirecionar para tela de comps
            window.location.href = 'comps-bid-prototype.html';
        };

        darkModeToggle.addEventListener('click', () => {
            body.classList.toggle('dark-mode');
            const isNowDark = body.classList.contains('dark-mode');
            
            if (isNowDark) {
                darkModeIcon.textContent = '‚òÄÔ∏è';
                darkModeText.textContent = 'Modo Claro';
                localStorage.setItem('darkMode', 'true');
            } else {
                darkModeIcon.textContent = 'üåô';
                darkModeText.textContent = 'Modo Escuro';
                localStorage.setItem('darkMode', 'false');
            }
        });
        
        // Timestamp is now fixed in HTML (version timestamp from Git commit)
        
        // ============================================
        // CARREGAMENTO AUTOM√ÅTICO DE KML
        // ============================================
        async function loadDefaultKMLFiles() {
            const kmlFiles = [
                { url: 'AvailableLands.kml', name: 'Available Lands' },
                { url: 'SoldLands.kml', name: 'Sold Lands' },
                { url: 'BlockedPaused.kml', name: 'Blocked/Paused' },
                { url: 'PartnersAvailableLands.kml', name: 'Partners Available Lands' }
            ];
            
            for (const file of kmlFiles) {
                try {
                    const response = await fetch(file.url);
                    const kmlText = await response.text();
                    const parser = new DOMParser();
                    const kmlDoc = parser.parseFromString(kmlText, 'text/xml');
                    const placemarks = kmlDoc.getElementsByTagName('Placemark');
                    
                    for (let i = 0; i < placemarks.length; i++) {
                        const placemark = placemarks[i];
                        const name = placemark.getElementsByTagName('name')[0]?.textContent || '';
                        const description = placemark.getElementsByTagName('description')[0]?.textContent || '';
                        const coordinates = placemark.getElementsByTagName('coordinates')[0]?.textContent.trim();
                        
                        if (coordinates) {
                            const [lng, lat] = coordinates.split(',').map(c => parseFloat(c.trim()));
                            if (!isNaN(lat) && !isNaN(lng)) {
                                const marker = L.marker([lat, lng], {
                                    icon: L.divIcon({
                                        className: 'custom-div-icon',
                                        html: `<div style="background-color: ${file.url.includes('Sold') ? '#ef4444' : file.url.includes('Blocked') ? '#f59e0b' : file.url.includes('Partners') ? '#8b5cf6' : '#10b981'}; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white;"></div>`,
                                        iconSize: [12, 12],
                                        iconAnchor: [6, 6]
                                    })
                                });
                                
                                marker.bindPopup(`
                                    <div style="min-width: 200px;">
                                        <h3 style="margin: 0 0 8px 0; font-weight: bold;">${name}</h3>
                                        <p style="margin: 0; font-size: 12px; color: #666;">${description}</p>
                                        <p style="margin: 4px 0 0 0; font-size: 11px; color: #999;">Fonte: ${file.name}</p>
                                    </div>
                                `);
                                
                                marker.addTo(map);
                            }
                        }
                    }
                    
                    console.log(`‚úÖ ${file.name} carregado com sucesso!`);
                } catch (error) {
                    console.error(`‚ùå Erro ao carregar ${file.name}:`, error);
                }
            }
        }
        
        // Carregar KML automaticamente ap√≥s 1 segundo
        setTimeout(loadDefaultKMLFiles, 1000);
        
        // Event Listener para o bot√£o Terreno 0.20
        document.getElementById('filterTerrenoBtn').addEventListener('click', function() {
            console.log('üèûÔ∏è Filtro Terreno 0.20 ativado!');
            
            // Filtrar propriedades: >= 0.20 acres E apenas Land Only
            allNewProperties = allNewProperties.filter(prop => {
                const acres = parseFloat(prop.Acres) || 0;
                const parcelType = prop['Parcel Type'] || '';
                return acres >= 0.20 && parcelType !== 'Land & Structures';
            });
            
            // Limpar todos os marcadores amarelos do mapa
            newPropertiesLayer.clearLayers();
            
            // Re-adicionar apenas os marcadores das propriedades filtradas
            allNewProperties.forEach(row => {
                const coordsStr = row.Coordinates.replace(/"/g, '').trim();
                const coords = coordsStr.split(',');
                const lat = parseFloat(coords[0]);
                const lng = parseFloat(coords[1]);
                
                if (!isNaN(lat) && !isNaN(lng)) {
                    const marker = L.marker([lat, lng], { icon: icons.new })
                        .bindPopup(`
                            <strong>${row.Name}</strong><br>
                            ${row.Address}<br>
                            ${row.City}, ${row.State} ${row.Zip}<br>
                            <strong>Parcel ID:</strong> ${row['Parcel Number']}<br>
                            <strong>Tipo:</strong> ${row['Parcel Type'] || 'N/A'}<br>
                            <strong>Acres:</strong> ${row.Acres}<br>
                            <strong>Amount Due:</strong> $${row['Amount Due']}<br><br>
                            <a href="https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${lat},${lng}" target="_blank" class="inline-block bg-blue-600 px-3 py-1 rounded text-sm hover:bg-blue-700" style="color: white !important;">
                                üìç Ver Street View
                            </a>
                        `)
                        .addTo(newPropertiesLayer);
                    
                    // Add click event to marker
                    marker.on('click', function() {
                        const tableSection = document.getElementById('tableSection');
                        const tableBody = document.getElementById('tableBody');
                        const rows = tableBody.getElementsByTagName('tr');
                        
                        for (let i = 0; i < rows.length; i++) {
                            const parcelCell = rows[i].cells[2];
                            if (parcelCell && parcelCell.textContent.trim() === row['Parcel Number']) {
                                rows[i].scrollIntoView({ behavior: 'smooth', block: 'center' });
                                rows[i].style.backgroundColor = '#fef3c7';
                                setTimeout(() => {
                                    rows[i].style.backgroundColor = '';
                                }, 5000);
                                break;
                            }
                        }
                    });
                }
            });
            
            // Atualizar tabela
            populateTable();
            
            // Esconder bot√£o ap√≥s uso
            this.classList.add('hidden');
            
            alert(`‚úÖ Filtro aplicado!\n- Removidas: < 0.20 acres\n- Removidas: Land & Structures\nTotal restante: ${allNewProperties.length}`);
        });
        
        // Event Listener para o bot√£o Favoritos
        let showingFavoritesOnly = false;
        document.getElementById('filterFavoritesBtn').addEventListener('click', function() {
            showingFavoritesOnly = !showingFavoritesOnly;
            
            if (showingFavoritesOnly) {
                this.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
                this.classList.add('bg-green-600', 'hover:bg-green-700');
                this.innerHTML = '‚úÖ Mostrando Favoritos (<span id="favoritesCount">0</span>)';
            } else {
                this.classList.remove('bg-green-600', 'hover:bg-green-700');
                this.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
                this.innerHTML = '‚≠ê Favoritos (<span id="favoritesCount">0</span>)';
            }
            
            populateTable();
        });
        
        // ===== üîî SISTEMA DE NOTIFICA√á√ïES =====
        
        function showNotification(message, type = 'info') {
            // Criar elemento de notifica√ß√£o
            const notification = document.createElement('div');
            notification.className = 'notification-toast';
            
            // Definir cores baseado no tipo
            let bgColor, borderColor, icon;
            switch(type) {
                case 'success':
                    bgColor = 'bg-green-50';
                    borderColor = 'border-green-500';
                    icon = '‚úÖ';
                    break;
                case 'error':
                    bgColor = 'bg-red-50';
                    borderColor = 'border-red-500';
                    icon = '‚ùå';
                    break;
                case 'warning':
                    bgColor = 'bg-yellow-50';
                    borderColor = 'border-yellow-500';
                    icon = '‚ö†Ô∏è';
                    break;
                default:
                    bgColor = 'bg-blue-50';
                    borderColor = 'border-blue-500';
                    icon = '‚ÑπÔ∏è';
            }
            
            notification.innerHTML = `
                <div class="${bgColor} ${borderColor} border-l-4 p-4 rounded shadow-lg max-w-md">
                    <div class="flex items-center gap-3">
                        <span class="text-2xl">${icon}</span>
                        <p class="text-sm font-medium text-gray-800">${message}</p>
                    </div>
                </div>
            `;
            
            // Adicionar estilos inline
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 9999;
                animation: slideIn 0.3s ease-out;
            `;
            
            document.body.appendChild(notification);
            
            // Remover ap√≥s 5 segundos
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 5000);
        }
        
        // Adicionar estilos de anima√ß√£o
        if (!document.getElementById('notification-styles')) {
            const style = document.createElement('style');
            style.id = 'notification-styles';
            style.textContent = `
                @keyframes slideIn {
                    from {
                        transform: translateX(400px);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
                @keyframes slideOut {
                    from {
                        transform: translateX(0);
                        opacity: 1;
                    }
                    to {
                        transform: translateX(400px);
                        opacity: 0;
                    }
                }
            `;
            document.head.appendChild(style);
        }
        
        // ===== FIM SISTEMA DE NOTIFICA√á√ïES =====
        
        // Event Listener para o bot√£o Analisar Selecionadas
        document.addEventListener('DOMContentLoaded', function() {
            const analyzeBtn = document.getElementById('analyzeSelectedBtn');
            if (analyzeBtn) {
                analyzeBtn.addEventListener('click', function() {
                    console.log('üî¥ Bot√£o clicado via addEventListener!');
                    analyzeSelectedProperties();
                });
                console.log('‚úÖ Event listener adicionado ao bot√£o analyzeSelectedBtn');
            } else {
                console.error('‚ùå Bot√£o analyzeSelectedBtn n√£o encontrado!');
            }
        
        // ============================================
        // FUN√á√ÉO DE ORDENA√á√ÉO DA TABELA
        // ============================================
        let sortDirections = {}; // Armazena dire√ß√£o de ordena√ß√£o para cada coluna
        
        function sortTable(columnIndex) {
            const table = document.getElementById('dataTable');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            // Determinar dire√ß√£o da ordena√ß√£o (alternar entre asc/desc)
            if (!sortDirections[columnIndex]) {
                sortDirections[columnIndex] = 'asc';
            } else if (sortDirections[columnIndex] === 'asc') {
                sortDirections[columnIndex] = 'desc';
            } else {
                sortDirections[columnIndex] = 'asc';
            }
            
            const direction = sortDirections[columnIndex];
            
            // Resetar √≠cones de todas as colunas
            for (let i = 0; i < 9; i++) {
                const icon = document.getElementById(`sort-icon-${i}`);
                if (icon) icon.textContent = '‚áÖ';
            }
            
            // Atualizar √≠cone da coluna atual
            const currentIcon = document.getElementById(`sort-icon-${columnIndex}`);
            if (currentIcon) {
                currentIcon.textContent = direction === 'asc' ? '‚Üë' : '‚Üì';
            }
            
            // Ordenar linhas
            rows.sort((a, b) => {
                // +1 porque a primeira coluna √© o checkbox
                const cellA = a.cells[columnIndex + 1]?.textContent.trim() || '';
                const cellB = b.cells[columnIndex + 1]?.textContent.trim() || '';
                
                // Tentar converter para n√∫mero se poss√≠vel
                const numA = parseFloat(cellA.replace(/[^0-9.-]/g, ''));
                const numB = parseFloat(cellB.replace(/[^0-9.-]/g, ''));
                
                let comparison = 0;
                
                // Se ambos s√£o n√∫meros v√°lidos, comparar como n√∫meros
                if (!isNaN(numA) && !isNaN(numB)) {
                    comparison = numA - numB;
                } else {
                    // Caso contr√°rio, comparar como strings
                    comparison = cellA.localeCompare(cellB, 'pt-BR', { numeric: true, sensitivity: 'base' });
                }
                
                return direction === 'asc' ? comparison : -comparison;
            });
            
            // Limpar tbody e adicionar linhas ordenadas
            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
            
            console.log(`üîÑ Tabela ordenada por coluna ${columnIndex} (${direction})`);
        }
        
        // ===== üé® TABLE DENSITY CONTROLS =====
        let currentDensity = 'comfortable';
        const densityButtons = document.querySelectorAll('.density-btn');
        const dataTable = document.getElementById('dataTable');
        
        densityButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                const density = this.getAttribute('data-density');
                
                // Remove all density classes
                dataTable.classList.remove('table-compact', 'table-comfortable', 'table-spacious');
                
                // Add new density class
                dataTable.classList.add(`table-${density}`);
                
                // Update button styles
                densityButtons.forEach(b => {
                    b.classList.remove('bg-blue-600', 'text-white');
                    b.classList.add('bg-gray-200', 'hover:bg-gray-300');
                });
                this.classList.remove('bg-gray-200', 'hover:bg-gray-300');
                this.classList.add('bg-blue-600', 'text-white');
                
                // Save preference
                localStorage.setItem('tableDensity', density);
                currentDensity = density;
            });
        });
        
        // Restore density preference
        const savedDensity = localStorage.getItem('tableDensity') || 'compact';
        const savedDensityBtn = document.querySelector(`[data-density="${savedDensity}"]`);
        if (savedDensityBtn) {
            savedDensityBtn.click();
        }
        
        // ===== ‚ö° KEYBOARD SHORTCUTS =====
        document.addEventListener('keydown', function(e) {
            // Ctrl+F: Focus on global search
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                const globalSearch = document.getElementById('globalSearch');
                if (globalSearch) {
                    globalSearch.focus();
                    globalSearch.select();
                }
            }
            
            // Ctrl+A: Select all visible rows
            if (e.ctrlKey && e.key === 'a') {
                const tableSection = document.getElementById('tableSection');
                if (tableSection && !tableSection.classList.contains('hidden')) {
                    e.preventDefault();
                    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
                    if (selectAllCheckbox) {
                        selectAllCheckbox.checked = true;
                        selectAllCheckbox.dispatchEvent(new Event('change'));
                    }
                }
            }
            
            // Ctrl+E: Export selected properties
            if (e.ctrlKey && e.key === 'e') {
                const exportBtn = document.getElementById('exportSelectedBtn');
                if (exportBtn && !exportBtn.classList.contains('hidden')) {
                    e.preventDefault();
                    exportBtn.click();
                }
            }
            
            // Delete: Delete selected properties
            if (e.key === 'Delete') {
                const deleteBtn = document.getElementById('deleteSelectedBtn');
                if (deleteBtn && !deleteBtn.classList.contains('hidden')) {
                    e.preventDefault();
                    deleteBtn.click();
                }
            }
        });
    </script>
    
    <!-- Export Modal -->
    <div id="exportModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-2xl p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">üì§ Exportar Propriedades</h2>
                <button onclick="document.getElementById('exportModal').classList.add('hidden')" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
            </div>
            
            <!-- Templates Section -->
            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                <h3 class="text-lg font-semibold mb-3">üíæ Templates</h3>
                <div class="flex gap-2 mb-2">
                    <select id="templateSelect" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg">
                        <option value="">-- Selecione um template --</option>
                    </select>
                    <button onclick="applyExportTemplate()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">‚úÖ Aplicar</button>
                </div>
                <div class="flex gap-2">
                    <button onclick="saveExportTemplate()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">üíæ Salvar Template</button>
                    <button onclick="deleteExportTemplate()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">üóëÔ∏è Deletar Template</button>
                </div>
            </div>
            
            <!-- Column Selection -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-3">üìã Selecionar Colunas</h3>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-2 max-h-60 overflow-y-auto p-2 border border-gray-200 rounded-lg">
                    <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-2 rounded">
                        <input type="checkbox" class="column-checkbox" value="Parcel Number" checked>
                        <span class="text-sm">Parcel Number</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-2 rounded">
                        <input type="checkbox" class="column-checkbox" value="Name" checked>
                        <span class="text-sm">Name</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-2 rounded">
                        <input type="checkbox" class="column-checkbox" value="Address" checked>
                        <span class="text-sm">Address</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-2 rounded">
                        <input type="checkbox" class="column-checkbox" value="City" checked>
                        <span class="text-sm">City</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-2 rounded">
                        <input type="checkbox" class="column-checkbox" value="State" checked>
                        <span class="text-sm">State</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-2 rounded">
                        <input type="checkbox" class="column-checkbox" value="Zip" checked>
                        <span class="text-sm">Zip</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-2 rounded">
                        <input type="checkbox" class="column-checkbox" value="County" checked>
                        <span class="text-sm">County</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-2 rounded">
                        <input type="checkbox" class="column-checkbox" value="Acres" checked>
                        <span class="text-sm">Acres</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-2 rounded">
                        <input type="checkbox" class="column-checkbox" value="Parcel Type" checked>
                        <span class="text-sm">Parcel Type</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-2 rounded">
                        <input type="checkbox" class="column-checkbox" value="Amount Due" checked>
                        <span class="text-sm">Amount Due</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-2 rounded">
                        <input type="checkbox" class="column-checkbox" value="Legal Description" checked>
                        <span class="text-sm">Legal Description</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-2 rounded">
                        <input type="checkbox" class="column-checkbox" value="Latitude" checked>
                        <span class="text-sm">Latitude</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-2 rounded">
                        <input type="checkbox" class="column-checkbox" value="Longitude" checked>
                        <span class="text-sm">Longitude</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-2 rounded">
                        <input type="checkbox" class="column-checkbox" value="Coordinates" checked>
                        <span class="text-sm">Coordinates</span>
                    </label>
                </div>
                <div class="flex gap-2 mt-2">
                    <button onclick="document.querySelectorAll('.column-checkbox').forEach(cb => cb.checked = true)" class="text-sm px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded">‚úÖ Selecionar Todas</button>
                    <button onclick="document.querySelectorAll('.column-checkbox').forEach(cb => cb.checked = false)" class="text-sm px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded">‚ùå Desmarcar Todas</button>
                </div>
            </div>
            
            <!-- Export Buttons -->
            <div class="flex gap-3">
                <button onclick="const cols = Array.from(document.querySelectorAll('.column-checkbox:checked')).map(cb => cb.value); exportSelectedAsCSV(cols);" class="flex-1 px-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition-colors">
                    üìÑ Exportar CSV
                </button>
                <button onclick="exportSelectedAsKML(); document.getElementById('exportModal').classList.add('hidden');" class="flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                    üó∫Ô∏è Exportar KML
                </button>
            </div>
        </div>
    </div>
    
    <!-- Workflow System e Analysis Functions removidos - arquivos n√£o existem -->
</body>
</html>

