<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚öôÔ∏è Configura√ß√µes - GTSearch</title>
    <script src="/js/utils.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 2rem;
            color: #333;
        }

        .header p {
            color: #666;
            margin-top: 5px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-back {
            background: #f5f5f5;
            color: #333;
        }

        .btn-back:hover {
            background: #e0e0e0;
            transform: translateY(-2px);
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .settings-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .settings-card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .settings-card h3 {
            color: #333;
            margin: 20px 0 10px 0;
            font-size: 1.2rem;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            color: #555;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            padding-right: 45px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .toggle-password {
            position: absolute;
            right: 10px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 5px;
            color: #666;
            transition: color 0.3s;
        }

        .toggle-password:hover {
            color: #667eea;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-group small {
            display: block;
            color: #999;
            margin-top: 5px;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-success {
            background: #4caf50;
            color: white;
        }

        .btn-success:hover {
            background: #45a049;
        }

        .test-results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .test-card {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #e0e0e0;
        }

        .test-card h4 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
        }

        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .status.loading {
            background: #ffc107;
            color: white;
        }

        .status.success {
            background: #4caf50;
            color: white;
        }

        .status.error {
            background: #f44336;
            color: white;
        }

        .test-content {
            min-height: 200px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .test-content img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .error-message {
            padding: 15px;
            background: #ffebee;
            color: #c62828;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .success-message {
            padding: 15px;
            background: #e8f5e9;
            color: #2e7d32;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
        }

        .info-box h4 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .info-box ul {
            margin-left: 20px;
            color: #555;
        }

        .info-box li {
            margin-bottom: 5px;
        }

        .info-box a {
            color: #1976d2;
            text-decoration: none;
            font-weight: bold;
        }

        .info-box a:hover {
            text-decoration: underline;
        }

        #mapTest {
            width: 100%;
            height: 300px;
            border-radius: 8px;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .saved-indicator {
            display: none;
            color: #4caf50;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        .saved-indicator.show {
            display: block;
        }

        .keywords-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            min-height: 40px;
            padding: 10px;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px dashed #d1d5db;
        }
        
        .keyword-tag {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .keyword-tag.risk {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #fca5a5;
        }
        
        .keyword-tag.warning {
            background: #fef3c7;
            color: #d97706;
            border: 1px solid #fcd34d;
        }
        
        .keyword-tag.info {
            background: #dbeafe;
            color: #2563eb;
            border: 1px solid #93c5fd;
        }
        
        .keyword-tag button {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            font-size: 1.1rem;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }
        
        .keyword-tag button:hover {
            background: rgba(0,0,0,0.1);
            transform: scale(1.1);
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .test-results {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>‚öôÔ∏è Configura√ß√µes</h1>
                <p>Configure suas APIs e prefer√™ncias</p>
            </div>
            <a href="index.html" class="btn btn-back">
                ‚Üê Voltar ao Dashboard
            </a>
        </div>

        <div class="settings-grid">
            <!-- Google Sheets Integration -->
            <div class="settings-card">
                <h2>üîí Google Sheets Integration</h2>
                <p style="color: #666; margin-bottom: 20px;">
                    Gerencie todas as suas API keys de forma segura usando Google Sheets + Google Apps Script.
                    <a href="GOOGLE-SHEETS-SETUP.md" target="_blank" style="color: #667eea; font-weight: bold;">üìö Ver Guia Completo</a>
                </p>
                
                <div class="input-group">
                    <label for="googleSheetsWebAppUrl">Web App URL</label>
                    <input type="text" id="googleSheetsWebAppUrl" placeholder="https://script.google.com/macros/s/AKfycby.../exec">
                    <small>URL do Google Apps Script publicado como Web App</small>
                </div>
                
                <div class="input-group">
                    <label for="googleSheetsPassword">Senha Secreta</label>
                    <input type="password" id="googleSheetsPassword" placeholder="Sua senha secreta definida no Apps Script">
                    <small>Senha SECRET_PASSWORD definida no Google Apps Script</small>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-success" onclick="saveGoogleSheetsConfig()">üíæ Salvar Configura√ß√£o</button>
                    <button class="btn btn-primary" onclick="loadApiKeysFromSheets()">üîÑ Carregar API Keys do Google Sheets</button>
                    <button class="btn btn-secondary" onclick="toggleAutoLoad()" id="autoLoadBtn">‚è∏Ô∏è Auto-Load: OFF</button>
                </div>
                
                <div id="googleSheetsResult"></div>
                
                <div class="saved-indicator" id="savedIndicatorSheets">
                    ‚úÖ Configura√ß√£o do Google Sheets salva com sucesso!
                </div>
            </div>

            <!-- Google Maps API Settings -->
            <div class="settings-card">
                <h2>üó∫Ô∏è Google Maps API</h2>
                
                <div class="input-group">
                    <label for="googleMapsApiKey">API Key</label>
                    <div class="input-wrapper">
                        <input type="password" id="googleMapsApiKey" placeholder="Cole sua Google Maps API Key aqui...">
                        <button type="button" class="toggle-password" onclick="togglePassword('googleMapsApiKey')">üëÅÔ∏è</button>
                    </div>
                    <small>Obtenha sua API key em: <a href="https://console.cloud.google.com/apis/credentials" target="_blank">Google Cloud Console</a></small>
                </div>

                <div class="button-group">
                    <button class="btn btn-success" onclick="saveGoogleMapsApiKey()">üíæ Salvar API Key</button>
                    <button class="btn btn-primary" onclick="testGoogleMapsAPI()">üß™ Testar API</button>
                    <button class="btn btn-secondary" onclick="clearTestResults()">üóëÔ∏è Limpar Resultados</button>
                </div>

                <div class="saved-indicator" id="savedIndicator">
                    ‚úÖ API Key salva com sucesso!
                </div>

                <div class="info-box">
                    <h4>üìã APIs Necess√°rias:</h4>
                    <ul>
                        <li><strong>Maps JavaScript API</strong> - Para mapas interativos</li>
                        <li><strong>Street View Static API</strong> - Para imagens Street View</li>
                        <li><strong>Maps Static API</strong> - Para imagens de sat√©lite</li>
                        <li><strong>Geocoding API</strong> - Para convers√£o de endere√ßos</li>
                    </ul>
                    <p style="margin-top: 10px;">
                        <strong>‚ö†Ô∏è Importante:</strong> Configure o faturamento no Google Cloud para usar estas APIs.
                        <br>
                        <a href="https://console.cloud.google.com/billing" target="_blank">Configurar Faturamento ‚Üí</a>
                    </p>
                </div>

                <div id="testResults" class="test-results">
                    <!-- Results will be inserted here -->
                </div>
            </div>

            <!-- Other API Settings -->
            <div class="settings-card">
                <h2>ü§ñ Outras APIs</h2>
                
                <h3>OpenAI API</h3>
                <div class="input-group">
                    <label for="openaiApiKey">API Key</label>
                    <div class="input-wrapper">
                        <input type="password" id="openaiApiKey" placeholder="sk-...">
                        <button type="button" class="toggle-password" onclick="togglePassword('openaiApiKey')">üëÅÔ∏è</button>
                    </div>
                    <small>Para an√°lise de red flags e descri√ß√µes</small>
                </div>
                <div class="button-group">
                    <button class="btn btn-success" onclick="saveOpenAIKey()">üíæ Salvar</button>
                    <button class="btn btn-primary" onclick="testOpenAI()">üß™ Testar API</button>
                </div>
                <div id="openaiTestResult"></div>

                <h3>Google Gemini API</h3>
                <div class="input-group">
                    <label for="geminiApiKey">API Key</label>
                    <div class="input-wrapper">
                        <input type="password" id="geminiApiKey" placeholder="AIza...">
                        <button type="button" class="toggle-password" onclick="togglePassword('geminiApiKey')">üëÅÔ∏è</button>
                    </div>
                    <small>Para an√°lise de imagens e vis√£o computacional</small>
                </div>
                <div class="button-group">
                    <button class="btn btn-success" onclick="saveGeminiKey()">üíæ Salvar</button>
                    <button class="btn btn-primary" onclick="testGemini()">üß™ Testar API</button>
                </div>
                <div id="geminiTestResult"></div>

                <h3>Perplexity (Sonar) API</h3>
                <div class="input-group">
                    <label for="perplexityApiKey">API Key</label>
                    <div class="input-wrapper">
                        <input type="password" id="perplexityApiKey" placeholder="pplx-...">
                        <button type="button" class="toggle-password" onclick="togglePassword('perplexityApiKey')">üëÅÔ∏è</button>
                    </div>
                    <small>Para pesquisa de mercado e informa√ß√µes atualizadas</small>
                </div>
                <div class="button-group">
                    <button class="btn btn-success" onclick="savePerplexityKey()">üíæ Salvar</button>
                    <button class="btn btn-primary" onclick="testPerplexity()">üß™ Testar API</button>
                </div>
                <div id="perplexityTestResult"></div>

            </div>

            <!-- Real Estate API Settings -->
            <div class="settings-card">
                <h2>üè° APIs Imobili√°rias</h2>
                
                <h3>üîë RapidAPI Key (Unificada)</h3>
                <div class="input-group">
                    <label for="rapidApiKey">X-RapidAPI-Key</label>
                    <div class="input-wrapper">
                        <input type="password" id="rapidApiKey" placeholder="sua-rapidapi-key...">
                        <button type="button" class="toggle-password" onclick="togglePassword('rapidApiKey')">üëÅÔ∏è</button>
                    </div>
                    <small>üí° Uma √∫nica chave para: Zillow, Realtor.com, Realty Mole, FEMA | <a href="https://rapidapi.com/hub" target="_blank">üîó Obter API Key</a></small>
                </div>
                <div class="button-group">
                    <button class="btn btn-success" onclick="saveRapidApiKey()">üíæ Salvar</button>
                    <button class="btn btn-primary" onclick="testAllRapidApis()">üß™ Testar Todas as APIs</button>
                </div>
                <div id="rapidApiTestResult"></div>
                
                <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #3b82f6;">
                    <p style="margin: 0; color: #1e40af; font-size: 0.9rem;">
                        <strong>‚ÑπÔ∏è Info:</strong> A mesma RapidAPI Key funciona para todas as APIs abaixo (desde que voc√™ tenha subscrito cada uma no RapidAPI Hub):
                    </p>
                    <ul style="margin: 10px 0 0 20px; color: #1e40af; font-size: 0.85rem;">
                        <li><a href="https://rapidapi.com/apimaker/api/zillow-com1" target="_blank">Zillow API</a></li>
                        <li><a href="https://rapidapi.com/apidojo/api/realtor" target="_blank">Realtor.com API</a></li>
                        <li><a href="https://rapidapi.com/realtymole/api/realty-mole-property-api" target="_blank">Realty Mole API</a></li>
                        <li><a href="https://rapidapi.com/fyhao/api/fema-flood-hazard-florida" target="_blank">FEMA Flood Risk API</a></li>
                    </ul>
                </div>

                <h3>üõ∞Ô∏è USGS M2M Token (Landsat/Satellite Imagery)</h3>
                <div class="input-group">
                    <label for="usgsM2mToken">M2M Token</label>
                    <div class="input-wrapper">
                        <input type="password" id="usgsM2mToken" placeholder="seu-usgs-m2m-token...">
                        <button type="button" class="toggle-password" onclick="togglePassword('usgsM2mToken')">üëÅÔ∏è</button>
                    </div>
                    <small>Para acessar imagens de sat√©lite Landsat (1984-2024) e an√°lise temporal | <a href="https://ers.cr.usgs.gov/register" target="_blank">üîó Criar Conta USGS</a> | <a href="https://m2m.cr.usgs.gov/api/docs/json/" target="_blank">üìö Documenta√ß√£o</a></small>
                </div>
                <div class="button-group">
                    <button class="btn btn-success" onclick="saveUsgsToken()">üíæ Salvar</button>
                    <button class="btn btn-info" onclick="showUsgsInfo()">‚ÑπÔ∏è Como Obter Token</button>
                </div>
                <div id="usgsTestResult"></div>

                <h3>üèôÔ∏è US Census Bureau API Key</h3>
                <div class="input-group">
                    <label for="censusApiKey">API Key</label>
                    <div class="input-wrapper">
                        <input type="password" id="censusApiKey" placeholder="sua-census-api-key...">
                        <button type="button" class="toggle-password" onclick="togglePassword('censusApiKey')">üëÅÔ∏è</button>
                    </div>
                    <small>üìä Para dados demogr√°ficos, popula√ß√£o, renda e habita√ß√£o | <a href="https://api.census.gov/data/key_signup.html" target="_blank">üîó Obter API Key (GRATUITA)</a></small>
                </div>
                <div class="button-group">
                    <button class="btn btn-success" onclick="saveCensusApiKey()">üíæ Salvar</button>
                    <button class="btn btn-primary" onclick="testCensusApi()">üß™ Testar API</button>
                </div>
                <div id="censusTestResult"></div>

                <hr style="margin: 30px 0; border: 1px solid #e0e0e0;">
                <button class="btn btn-success" onclick="saveRealEstateApiKeys()">üíæ Salvar Todas as APIs Imobili√°rias</button>
                
                <div class="saved-indicator" id="savedIndicatorRealEstate">
                    ‚úÖ APIs Imobili√°rias salvas com sucesso!
                </div>
                
                <div class="saved-indicator" id="savedIndicatorOther">
                    ‚úÖ APIs salvas com sucesso!
                </div>
            </div>
            
            <!-- Alert Keywords Configuration -->
            <div class="settings-card">
                <h2>‚ö†Ô∏è Alertas de Legal Description</h2>
                <p style="color: #666; margin-bottom: 20px;">
                    Configure palavras-chave para monitorar no campo "Legal Description" das propriedades.
                    O sistema alertar√° automaticamente quando detectar essas palavras.
                </p>
                
                <!-- Risk Alerts (Red) -->
                <h3 style="color: #dc2626;">‚ö†Ô∏è Alertas de Risco (Vermelho)</h3>
                <div id="riskKeywordsList" class="keywords-list"></div>
                <div class="input-group">
                    <input type="text" id="riskKeywordInput" placeholder="Digite uma palavra-chave (ex: EASEMENT)" style="margin-bottom: 10px;">
                    <button class="btn btn-danger" onclick="addKeyword('risk')">+ Adicionar Alerta de Risco</button>
                </div>
                
                <!-- Warning Alerts (Yellow) -->
                <h3 style="color: #f59e0b; margin-top: 30px;">‚ö° Alertas de Aten√ß√£o (Amarelo)</h3>
                <div id="warningKeywordsList" class="keywords-list"></div>
                <div class="input-group">
                    <input type="text" id="warningKeywordInput" placeholder="Digite uma palavra-chave (ex: RIGHT OF WAY)" style="margin-bottom: 10px;">
                    <button class="btn" style="background: #f59e0b; color: white;" onclick="addKeyword('warning')">+ Adicionar Alerta de Aten√ß√£o</button>
                </div>
                
                <!-- Info Alerts (Blue) -->
                <h3 style="color: #3b82f6; margin-top: 30px;">‚ÑπÔ∏è Alertas Informativos (Azul)</h3>
                <div id="infoKeywordsList" class="keywords-list"></div>
                <div class="input-group">
                    <input type="text" id="infoKeywordInput" placeholder="Digite uma palavra-chave (ex: MINERAL RIGHTS)" style="margin-bottom: 10px;">
                    <button class="btn btn-info" onclick="addKeyword('info')">+ Adicionar Alerta Informativo</button>
                </div>
                
                <!-- Threshold Settings -->
                <hr style="margin: 30px 0; border: 1px solid #e0e0e0;">
                <h3>üìä Configura√ß√µes de Limite</h3>
                <div class="input-group">
                    <label for="undividedThreshold">Limite de Propriedades UNDIVIDED</label>
                    <input type="number" id="undividedThreshold" value="5" min="1" max="100">
                    <small>Alertar quando o n√∫mero de propriedades UNDIVIDED exceder este valor</small>
                </div>
                
                <div class="input-group">
                    <label for="totalAlertsThreshold">Limite Total de Alertas</label>
                    <input type="number" id="totalAlertsThreshold" value="10" min="1" max="100">
                    <small>Alertar quando o total de propriedades com palavras-chave exceder este valor</small>
                </div>
                
                <div class="button-group" style="margin-top: 20px;">
                    <button class="btn btn-success" onclick="saveAlertSettings()">üíæ Salvar Configura√ß√µes</button>
                    <button class="btn btn-secondary" onclick="resetAlertSettings()">üîÑ Resetar para Padr√£o</button>
                </div>
                
                <div class="saved-indicator" id="savedIndicatorAlerts">
                    ‚úÖ Configura√ß√µes de alertas salvas com sucesso!
                </div>
            </div>

            <!-- Investment Calculation Settings -->
            <div class="settings-card">
                <h2>üí∞ Configura√ß√µes de Investimento</h2>
                <p style="color: #666; margin-bottom: 20px;">
                    Configure os par√¢metros padr√£o para o c√°lculo de Max Bid e ROI na Tela de Avalia√ß√£o.
                </p>

                <div class="input-group">
                    <label for="closingCostPercent">Closing Cost (%)</label>
                    <input type="number" id="closingCostPercent" value="9" min="0" max="100" step="0.5">
                    <small>Percentual sobre o Valor de Mercado para custos de fechamento. Padr√£o: 9%</small>
                </div>

                <div class="input-group">
                    <label for="cleanTitleCost">Clean Title ($)</label>
                    <input type="number" id="cleanTitleCost" value="2500" min="0" step="100">
                    <small>Custo fixo para limpeza de t√≠tulo. Padr√£o: $2,500</small>
                </div>

                <div class="input-group">
                    <label for="defaultROI1">ROI 1 - Padr√£o (%)</label>
                    <input type="number" id="defaultROI1" value="30" min="0" max="500" step="1">
                    <small>Primeiro cen√°rio de ROI desejado. Padr√£o: 30%</small>
                </div>

                <div class="input-group">
                    <label for="defaultROI2">ROI 2 - Padr√£o (%)</label>
<input type="number" id="defaultROI2" value="40" min="0" max="500" step="1">
                     <small>Segundo cen√°rio de ROI desejado. Padr√£o: 40%</small>
                </div>

                <div class="input-group">
                    <label for="defaultROI3">ROI 3 - Padr√£o (%)</label>
<input type="number" id="defaultROI3" value="50" min="0" max="500" step="1">
                     <small>Terceiro cen√°rio de ROI desejado. Padr√£o: 50%</small>
                </div>

                <div class="button-group" style="margin-top: 20px;">
                    <button class="btn btn-success" onclick="saveInvestmentSettings()">üíæ Salvar Configura√ß√µes</button>
                    <button class="btn btn-secondary" onclick="resetInvestmentSettings()">üîÑ Resetar para Padr√£o</button>
                </div>

                <div class="saved-indicator" id="savedIndicatorInvestment">
                    ‚úÖ Configura√ß√µes de investimento salvas com sucesso!
                </div>
            </div>

        </div>
    </div>

    <script>
        // Toggle password visibility
        // ========================================
        // CRYPTO FUNCTIONS - API KEY ENCRYPTION
        // ========================================

        /**
         * Encrypt API key using Base64 + simple XOR cipher
         * @param {string} text - Plain text API key
         * @returns {string} - Encrypted string
         */
        function encryptApiKey(text) {
            if (!text) return '';
            
            // Salt for XOR cipher (change this to make it unique)
            const salt = 'GT-LANDS-SECURE-2025';
            
            // XOR encryption
            let encrypted = '';
            for (let i = 0; i < text.length; i++) {
                const charCode = text.charCodeAt(i) ^ salt.charCodeAt(i % salt.length);
                encrypted += String.fromCharCode(charCode);
            }
            
            // Encode to Base64 to make it URL-safe
            return btoa(encrypted);
        }

        /**
         * Decrypt API key
         * @param {string} encrypted - Encrypted string
         * @returns {string} - Decrypted plain text API key
         */
        function decryptApiKey(encrypted) {
            if (!encrypted) return '';
            
            try {
                // Decode from Base64
                const decoded = atob(encrypted);
                
                // Salt for XOR cipher (must match encryption salt)
                const salt = 'GT-LANDS-SECURE-2025';
                
                // XOR decryption
                let decrypted = '';
                for (let i = 0; i < decoded.length; i++) {
                    const charCode = decoded.charCodeAt(i) ^ salt.charCodeAt(i % salt.length);
                    decrypted += String.fromCharCode(charCode);
                }
                
                return decrypted;
            } catch (error) {
                console.error('Erro ao descriptografar API key:', error);
                return '';
            }
        }

        /**
         * Save encrypted API key to localStorage
         * @param {string} key - localStorage key name
         * @param {string} value - Plain text API key
         */
        function saveEncryptedKey(key, value) {
            const encrypted = encryptApiKey(value);
            localStorage.setItem(key, encrypted);
        }

        /**
         * Load and decrypt API key from localStorage
         * @param {string} key - localStorage key name
         * @returns {string} - Decrypted plain text API key
         */
        function loadEncryptedKey(key) {
            const encrypted = localStorage.getItem(key);
            return decryptApiKey(encrypted);
        }

        // ========================================
        // UI FUNCTIONS
        // ========================================

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const button = input.nextElementSibling;
            
            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = 'üö´'; // √çcone de esconder
            } else {
                input.type = 'password';
                button.textContent = 'üëÅÔ∏è'; // √çcone de mostrar
            }
        }

        // Load saved API keys on page load (with decryption)
        window.addEventListener('DOMContentLoaded', () => {
            const googleMapsKey = loadEncryptedKey('googleMapsApiKey');
            const openaiKey = loadEncryptedKey('openaiApiKey');
            const geminiKey = loadEncryptedKey('geminiApiKey');
            const perplexityKey = loadEncryptedKey('perplexityApiKey');
            const rapidApiKey = loadEncryptedKey('rapidApiKey') || loadEncryptedKey('zillowApiKey') || loadEncryptedKey('realtorApiKey');
            const censusApiKey = loadEncryptedKey('censusApiKey');

            if (googleMapsKey) document.getElementById('googleMapsApiKey').value = googleMapsKey;
            if (openaiKey) document.getElementById('openaiApiKey').value = openaiKey;
            if (geminiKey) document.getElementById('geminiApiKey').value = geminiKey;
            if (perplexityKey) document.getElementById('perplexityApiKey').value = perplexityKey;
            if (rapidApiKey) document.getElementById('rapidApiKey').value = rapidApiKey;
            if (censusApiKey) document.getElementById('censusApiKey').value = censusApiKey;
        });

        async function saveGoogleMapsApiKey() {
            const apiKey = document.getElementById('googleMapsApiKey').value.trim();
            
            if (!apiKey) {
                alert('‚ùå Por favor, insira uma API Key!');
                return;
            }

            // üíæ Salvar no localStorage (para uso local)
            saveEncryptedKey('googleMapsApiKey', apiKey);
            
            // üöÄ Enviar para o servidor (para uso em analysis.html)
            try {
                const response = await fetch('/api/config/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ google_maps: apiKey })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('‚úÖ API Key salva no servidor com sucesso!');
                } else {
                    console.error('‚ùå Erro ao salvar no servidor:', result.error);
                }
            } catch (error) {
                console.error('‚ùå Erro ao enviar para servidor:', error);
            }
            
            const indicator = document.getElementById('savedIndicator');
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 3000);
        }

        async function saveOtherApiKeys() {
            const openaiKey = document.getElementById('openaiApiKey').value.trim();
            const geminiKey = document.getElementById('geminiApiKey').value.trim();
            const perplexityKey = document.getElementById('perplexityApiKey').value.trim();

            if (openaiKey) saveEncryptedKey('openaiApiKey', openaiKey);
            if (geminiKey) saveEncryptedKey('geminiApiKey', geminiKey);
            if (perplexityKey) saveEncryptedKey('perplexityApiKey', perplexityKey);

            // üöÄ Enviar para o servidor (para salvar no .env)
            try {
                const response = await fetch('/api/config/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        openai: openaiKey,
                        gemini: geminiKey,
                        perplexity: perplexityKey
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('‚úÖ API Keys salvas no servidor com sucesso!');
                } else {
                    console.error('‚ùå Erro ao salvar no servidor:', result.error);
                }
            } catch (error) {
                console.error('‚ùå Erro ao enviar para servidor:', error);
            }

            const indicator = document.getElementById('savedIndicatorOther');
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 3000);
        }

        function clearTestResults() {
            document.getElementById('testResults').innerHTML = '';
        }

        const testLocation = {
            address: '123 Main St, Miami, FL 33101',
            lat: 25.7617,
            lng: -80.1918
        };

        async function testGoogleMapsAPI() {
            const apiKey = document.getElementById('googleMapsApiKey').value.trim();
            
            if (!apiKey) {
                alert('‚ùå Por favor, insira uma API Key primeiro!');
                return;
            }

            clearTestResults();

            const resultsContainer = document.getElementById('testResults');

            // Test 1: Maps JavaScript API
            resultsContainer.innerHTML += createTestCard('test1', 'üó∫Ô∏è Maps JavaScript API', 'loading');
            testMapsJavaScript(apiKey);

            // Test 2: Street View Static API
            resultsContainer.innerHTML += createTestCard('test2', 'üì∏ Street View Static API', 'loading');
            testStreetView(apiKey);

            // Test 3: Maps Static API (Satellite)
            resultsContainer.innerHTML += createTestCard('test3', 'üõ∞Ô∏è Maps Static API (Satellite)', 'loading');
            testStaticMap(apiKey);

            // Test 4: Geocoding API
            resultsContainer.innerHTML += createTestCard('test4', 'üìç Geocoding API', 'loading');
            testGeocoding(apiKey);
        }

        function createTestCard(id, title, status) {
            return `
                <div class="test-card" id="${id}">
                    <h4>${title}</h4>
                    <div class="status ${status}">
                        ${status === 'loading' ? '<span class="loading-spinner"></span> Testando...' : ''}
                    </div>
                    <div class="test-content" id="${id}-content">
                        <div style="display: flex; align-items: center; justify-content: center; height: 200px; color: #999;">
                            Aguardando teste...
                        </div>
                    </div>
                </div>
            `;
        }

        function updateTestCard(id, status, content, message) {
            const card = document.getElementById(id);
            const statusEl = card.querySelector('.status');
            const contentEl = document.getElementById(`${id}-content`);

            statusEl.className = `status ${status}`;
            statusEl.innerHTML = status === 'success' ? '‚úÖ Funcionando!' : '‚ùå Erro';

            contentEl.innerHTML = content;

            if (message) {
                contentEl.innerHTML += status === 'success' 
                    ? `<div class="success-message">${message}</div>`
                    : `<div class="error-message">${message}</div>`;
            }
        }

        function testMapsJavaScript(apiKey) {
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initMap`;
            script.async = true;
            script.defer = true;
            
            script.onerror = () => {
                updateTestCard('test1', 'error', 
                    '<div style="padding: 20px; text-align: center;">‚ùå Falha ao carregar</div>',
                    '<strong>Erro:</strong> N√£o foi poss√≠vel carregar a Maps JavaScript API.<br><br><strong>Poss√≠veis causas:</strong><br>‚Ä¢ API n√£o est√° ativada<br>‚Ä¢ Restri√ß√µes de dom√≠nio na API key<br>‚Ä¢ Faturamento n√£o configurado<br><br><a href="https://console.cloud.google.com/apis/library/maps-backend.googleapis.com" target="_blank">Ativar API ‚Üí</a>'
                );
            };

            window.initMap = function() {
                try {
                    const mapDiv = document.createElement('div');
                    mapDiv.id = 'mapTest';
                    
                    const map = new google.maps.Map(mapDiv, {
                        center: { lat: testLocation.lat, lng: testLocation.lng },
                        zoom: 15
                    });

                    new google.maps.Marker({
                        position: { lat: testLocation.lat, lng: testLocation.lng },
                        map: map,
                        title: 'Test Location'
                    });

                    updateTestCard('test1', 'success', mapDiv.outerHTML,
                        '<strong>Sucesso!</strong> A Maps JavaScript API est√° funcionando perfeitamente! ‚ú®'
                    );
                } catch (error) {
                    updateTestCard('test1', 'error',
                        '<div style="padding: 20px; text-align: center;">‚ùå Erro ao criar mapa</div>',
                        `<strong>Erro:</strong> ${error.message}`
                    );
                }
            };

            document.head.appendChild(script);
        }

        function testStreetView(apiKey) {
            const url = `https://maps.googleapis.com/maps/api/streetview?size=600x300&location=${testLocation.lat},${testLocation.lng}&fov=90&heading=235&pitch=10&key=${apiKey}`;
            
            const img = new Image();
            img.onload = () => {
                updateTestCard('test2', 'success',
                    `<img src="${url}" alt="Street View">`,
                    '<strong>Sucesso!</strong> A Street View Static API est√° funcionando! üéâ'
                );
            };
            img.onerror = () => {
                updateTestCard('test2', 'error',
                    '<div style="padding: 20px; text-align: center;">‚ùå Falha ao carregar</div>',
                    '<strong>Erro:</strong> API n√£o autorizada<br><br><strong>Poss√≠veis solu√ß√µes:</strong><br>‚Ä¢ Ative a Street View Static API<br>‚Ä¢ Remova restri√ß√µes da API key<br>‚Ä¢ Configure o faturamento<br>‚Ä¢ Aguarde 5-10 minutos ap√≥s ativar<br><br><a href="https://console.cloud.google.com/apis/library/street-view-image-backend.googleapis.com" target="_blank">Ativar API ‚Üí</a>'
                );
            };
            img.src = url;
        }

        function testStaticMap(apiKey) {
            const url = `https://maps.googleapis.com/maps/api/staticmap?center=${testLocation.lat},${testLocation.lng}&zoom=17&size=600x300&maptype=satellite&markers=color:red%7C${testLocation.lat},${testLocation.lng}&key=${apiKey}`;
            
            const img = new Image();
            img.onload = () => {
                updateTestCard('test3', 'success',
                    `<img src="${url}" alt="Satellite View">`,
                    '<strong>Sucesso!</strong> A Maps Static API est√° funcionando! üõ∞Ô∏è'
                );
            };
            img.onerror = () => {
                updateTestCard('test3', 'error',
                    '<div style="padding: 20px; text-align: center;">‚ùå Falha ao carregar</div>',
                    '<strong>Erro:</strong> API n√£o autorizada<br><br><strong>Poss√≠veis solu√ß√µes:</strong><br>‚Ä¢ Ative a Maps Static API<br>‚Ä¢ Remova restri√ß√µes da API key<br>‚Ä¢ Configure o faturamento<br><br><a href="https://console.cloud.google.com/apis/library/static-maps-backend.googleapis.com" target="_blank">Ativar API ‚Üí</a>'
                );
            };
            img.src = url;
        }

        async function testGeocoding(apiKey) {
            const url = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(testLocation.address)}&key=${apiKey}`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.status === 'OK') {
                    const result = data.results[0];
                    updateTestCard('test4', 'success',
                        `<div style="padding: 20px;">
                            <strong>üìç Endere√ßo:</strong> ${result.formatted_address}<br><br>
                            <strong>üåç Coordenadas:</strong><br>
                            Latitude: ${result.geometry.location.lat}<br>
                            Longitude: ${result.geometry.location.lng}
                        </div>`,
                        '<strong>Sucesso!</strong> A Geocoding API est√° funcionando! üéØ'
                    );
                } else {
                    let errorMsg = data.error_message || data.status;
                    if (data.status === 'REQUEST_DENIED') {
                        errorMsg = 'Requisi√ß√£o negada - API n√£o autorizada';
                    }
                    
                    updateTestCard('test4', 'error',
                        '<div style="padding: 20px; text-align: center;">‚ùå Erro na geocodifica√ß√£o</div>',
                        `<strong>Erro:</strong> ${errorMsg}<br><br><strong>Status:</strong> ${data.status}<br><br><a href="https://console.cloud.google.com/apis/library/geocoding-backend.googleapis.com" target="_blank">Ativar API ‚Üí</a>`
                    );
                }
            } catch (error) {
                updateTestCard('test4', 'error',
                    '<div style="padding: 20px; text-align: center;">‚ùå Erro na requisi√ß√£o</div>',
                    `<strong>Erro:</strong> ${error.message}`
                );
            }
        }

        // ============================================
        // TESTADORES DE OUTRAS APIs
        // ============================================

        function saveOpenAIKey() {
            const apiKey = document.getElementById('openaiApiKey').value.trim();
            if (!apiKey) {
                alert('‚ùå Por favor, insira uma API Key!');
                return;
            }
            saveEncryptedKey('openaiApiKey', apiKey);
            showSaveSuccess('openaiTestResult');
        }

        function saveGeminiKey() {
            const apiKey = document.getElementById('geminiApiKey').value.trim();
            if (!apiKey) {
                alert('‚ùå Por favor, insira uma API Key!');
                return;
            }
            saveEncryptedKey('geminiApiKey', apiKey);
            showSaveSuccess('geminiTestResult');
        }

        function savePerplexityKey() {
            const apiKey = document.getElementById('perplexityApiKey').value.trim();
            if (!apiKey) {
                alert('‚ùå Por favor, insira uma API Key!');
                return;
            }
            saveEncryptedKey('perplexityApiKey', apiKey);
            showSaveSuccess('perplexityTestResult');
        }

        function showSaveSuccess(elementId) {
            const element = document.getElementById(elementId);
            element.innerHTML = '<div class="success-message" style="margin-top: 10px;">‚úÖ API Key salva com sucesso!</div>';
            setTimeout(() => {
                element.innerHTML = '';
            }, 3000);
        }

        async function testOpenAI() {
            const apiKey = document.getElementById('openaiApiKey').value.trim();
            
            if (!apiKey) {
                alert('‚ùå Por favor, insira uma API Key primeiro!');
                return;
            }

            const resultDiv = document.getElementById('openaiTestResult');
            resultDiv.innerHTML = '<div class="status loading" style="margin-top: 10px;"><span class="loading-spinner"></span> Testando OpenAI API...</div>';

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [{
                            role: 'user',
                            content: 'Say "API test successful!" in one sentence.'
                        }],
                        max_tokens: 50
                    })
                });

                const data = await response.json();

                if (response.ok && data.choices && data.choices[0]) {
                    resultDiv.innerHTML = `
                        <div class="success-message" style="margin-top: 10px;">
                            <strong>‚úÖ Sucesso!</strong> OpenAI API est√° funcionando!<br><br>
                            <strong>Resposta:</strong> ${data.choices[0].message.content}<br>
                            <strong>Modelo:</strong> ${data.model}<br>
                            <strong>Tokens usados:</strong> ${data.usage.total_tokens}
                        </div>
                    `;
                } else {
                    throw new Error(data.error?.message || 'Erro desconhecido');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error-message" style="margin-top: 10px;">
                        <strong>‚ùå Erro:</strong> ${typeof escapeHTML === 'function' ? escapeHTML(error.message) : error.message}<br><br>
                        <strong>Poss√≠veis causas:</strong><br>
                        ‚Ä¢ API key inv√°lida<br>
                        ‚Ä¢ Sem cr√©ditos dispon√≠veis<br>
                        ‚Ä¢ API key sem permiss√µes<br><br>
                        <a href="https://platform.openai.com/api-keys" target="_blank">Verificar API Keys ‚Üí</a>
                    </div>
                `;
            }
        }

        async function testGemini() {
            const apiKey = document.getElementById('geminiApiKey').value.trim();
            
            if (!apiKey) {
                alert('‚ùå Por favor, insira uma API Key primeiro!');
                return;
            }

            const resultDiv = document.getElementById('geminiTestResult');
            resultDiv.innerHTML = '<div class="status loading" style="margin-top: 10px;"><span class="loading-spinner"></span> Testando Gemini API...</div>';

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: 'Say "API test successful!" in one sentence.'
                            }]
                        }]
                    })
                });

                const data = await response.json();

                if (response.ok && data.candidates && data.candidates[0]) {
                    const text = data.candidates[0].content.parts[0].text;
                    resultDiv.innerHTML = `
                        <div class="success-message" style="margin-top: 10px;">
                            <strong>‚úÖ Sucesso!</strong> Gemini API est√° funcionando!<br><br>
                            <strong>Resposta:</strong> ${text}<br>
                            <strong>Modelo:</strong> gemini-1.5-flash
                        </div>
                    `;
                } else {
                    throw new Error(data.error?.message || 'Erro desconhecido');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error-message" style="margin-top: 10px;">
                        <strong>‚ùå Erro:</strong> ${typeof escapeHTML === 'function' ? escapeHTML(error.message) : error.message}<br><br>
                        <strong>Poss√≠veis causas:</strong><br>
                        ‚Ä¢ API key inv√°lida<br>
                        ‚Ä¢ API n√£o ativada<br>
                        ‚Ä¢ Limite de requisi√ß√µes excedido<br><br>
                        <a href="https://aistudio.google.com/app/apikey" target="_blank">Verificar API Keys ‚Üí</a>
                    </div>
                `;
            }
        }

        async function testPerplexity() {
            const apiKey = document.getElementById('perplexityApiKey').value.trim();
            
            if (!apiKey) {
                alert('‚ùå Por favor, insira uma API Key primeiro!');
                return;
            }

            const resultDiv = document.getElementById('perplexityTestResult');
            resultDiv.innerHTML = '<div class="status loading" style="margin-top: 10px;"><span class="loading-spinner"></span> Testando Perplexity API...</div>';

            try {
                const response = await fetch('https://api.perplexity.ai/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'sonar',
                        messages: [{
                            role: 'user',
                            content: 'Say "API test successful!" in one sentence.'
                        }]
                    })
                });

                const data = await response.json();

                if (response.ok && data.choices && data.choices[0]) {
                    resultDiv.innerHTML = `
                        <div class="success-message" style="margin-top: 10px;">
                            <strong>‚úÖ Sucesso!</strong> Perplexity API est√° funcionando!<br><br>
                            <strong>Resposta:</strong> ${data.choices[0].message.content}<br>
                            <strong>Modelo:</strong> ${data.model}
                        </div>
                    `;
                } else {
                    throw new Error(data.error?.message || data.message || 'Erro desconhecido');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error-message" style="margin-top: 10px;">
                        <strong>‚ùå Erro:</strong> ${typeof escapeHTML === 'function' ? escapeHTML(error.message) : error.message}<br><br>
                        <strong>Poss√≠veis causas:</strong><br>
                        ‚Ä¢ API key inv√°lida<br>
                        ‚Ä¢ Sem cr√©ditos dispon√≠veis<br>
                        ‚Ä¢ API key sem permiss√µes<br><br>
                        <a href="https://www.perplexity.ai/settings/api" target="_blank">Verificar API Keys ‚Üí</a>
                    </div>
                `;
            }
        }

        // ========================================
        // REAL ESTATE APIs - SAVE & TEST
        // ========================================

        // üîë Fun√ß√£o unificada para salvar RapidAPI Key
        async function saveRapidApiKey() {
            const apiKey = document.getElementById('rapidApiKey').value.trim();
            if (!apiKey) {
                alert('‚ùå Por favor, insira uma API Key!');
                return;
            }
            // Salvar em todas as chaves antigas para compatibilidade
            saveEncryptedKey('rapidApiKey', apiKey);
            saveEncryptedKey('zillowApiKey', apiKey);
            saveEncryptedKey('realtorApiKey', apiKey);
            saveEncryptedKey('realtyMoleApiKey', apiKey);
            saveEncryptedKey('femaApiKey', apiKey);
            
            // üöÄ Enviar para o servidor (para salvar no .env)
            try {
                const response = await fetch('/api/config/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ rapidapi: apiKey })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('‚úÖ RapidAPI Key salva no servidor com sucesso!');
                } else {
                    console.error('‚ùå Erro ao salvar no servidor:', result.error);
                }
            } catch (error) {
                console.error('‚ùå Erro ao enviar para servidor:', error);
            }
            
            const resultDiv = document.getElementById('rapidApiTestResult');
            resultDiv.innerHTML = '<div class="success-message" style="margin-top: 10px;"><strong>‚úÖ Salvo!</strong> RapidAPI Key salva com sucesso (localStorage + .env).</div>';
            setTimeout(() => {
                resultDiv.innerHTML = '';
            }, 3000);
        }

        function saveUsgsToken() {
            const token = document.getElementById('usgsM2mToken').value.trim();
            if (!token) {
                alert('‚ùå Por favor, insira o USGS M2M Token!');
                return;
            }
            saveEncryptedKey('usgsM2mToken', token);
            showSaveSuccess('usgsTestResult');
        }

        function showUsgsInfo() {
            const resultDiv = document.getElementById('usgsTestResult');
            resultDiv.innerHTML = `
                <div class="info-message" style="margin-top: 10px; padding: 15px; background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 5px;">
                    <strong>üìö Como Obter o USGS M2M Token:</strong><br><br>
                    <strong>1. Criar Conta USGS:</strong><br>
                    ‚Ä¢ Acesse: <a href="https://ers.cr.usgs.gov/register" target="_blank">https://ers.cr.usgs.gov/register</a><br>
                    ‚Ä¢ Preencha o formul√°rio de registro<br>
                    ‚Ä¢ Confirme seu email<br><br>
                    <strong>2. Fazer Login:</strong><br>
                    ‚Ä¢ Acesse: <a href="https://ers.cr.usgs.gov/login" target="_blank">https://ers.cr.usgs.gov/login</a><br>
                    ‚Ä¢ Entre com suas credenciais<br><br>
                    <strong>3. Obter Token:</strong><br>
                    ‚Ä¢ Acesse: <a href="https://m2m.cr.usgs.gov/api/docs/json/" target="_blank">https://m2m.cr.usgs.gov/api/docs/json/</a><br>
                    ‚Ä¢ Fa√ßa login quando solicitado<br>
                    ‚Ä¢ O token ser√° gerado automaticamente<br><br>
                    <strong>üåü O que voc√™ pode fazer:</strong><br>
                    ‚Ä¢ Baixar imagens de sat√©lite Landsat (1984-2024)<br>
                    ‚Ä¢ An√°lise temporal de propriedades<br>
                    ‚Ä¢ Detectar mudan√ßas ao longo dos anos<br>
                    ‚Ä¢ 100% GRATUITO!<br><br>
                    <strong>üìö Documenta√ß√£o:</strong><br>
                    ‚Ä¢ <a href="https://m2m.cr.usgs.gov/api/docs/json/" target="_blank">M2M API Docs</a><br>
                    ‚Ä¢ <a href="https://espa.cr.usgs.gov/static/docs/api-readme.html" target="_blank">ESPA API Docs</a><br>
                    ‚Ä¢ An√°lise completa: <code>/docs/usgs-m2m-espa-api-analise.md</code>
                </div>
            `;
        }

        function saveCensusApiKey() {
            const apiKey = document.getElementById('censusApiKey').value.trim();
            if (!apiKey) {
                alert('‚ùå Por favor, insira uma API Key!');
                return;
            }
            saveEncryptedKey('censusApiKey', apiKey);
            const resultDiv = document.getElementById('censusTestResult');
            resultDiv.innerHTML = '<div class="success-message" style="margin-top: 10px;"><strong>‚úÖ Salvo!</strong> US Census API Key salva com sucesso.</div>';
            setTimeout(() => {
                resultDiv.innerHTML = '';
            }, 3000);
        }

        async function testCensusApi() {
            const apiKey = document.getElementById('censusApiKey').value.trim();
            
            if (!apiKey) {
                alert('‚ùå Por favor, insira uma API Key primeiro!');
                return;
            }

            const resultDiv = document.getElementById('censusTestResult');
            resultDiv.innerHTML = '<div class="status loading" style="margin-top: 10px;"><span class="loading-spinner"></span> Testando US Census API...</div>';

            try {
                // Teste com Orlando, FL (exemplo)
                const response = await fetch(`https://api.census.gov/data/2021/acs/acs5?get=NAME,B01003_001E,B19013_001E&for=place:53000&in=state:12&key=${apiKey}`);
                const data = await response.json();

                if (response.ok && data && data.length > 1) {
                    const [headers, values] = data;
                    const name = values[0];
                    const population = parseInt(values[1]).toLocaleString();
                    const income = parseInt(values[2]).toLocaleString();
                    
                    resultDiv.innerHTML = `
                        <div class="success-message" style="margin-top: 10px;">
                            <strong>‚úÖ Sucesso!</strong> US Census API est√° funcionando!<br><br>
                            <strong>Teste:</strong> ${name}<br>
                            <strong>Popula√ß√£o:</strong> ${population}<br>
                            <strong>Renda M√©dia:</strong> $${income}
                        </div>
                    `;
                } else {
                    throw new Error('Resposta inv√°lida da API');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error-message" style="margin-top: 10px;">
                        <strong>‚ùå Erro:</strong> ${typeof escapeHTML === 'function' ? escapeHTML(error.message) : error.message}<br><br>
                        <strong>Poss√≠veis causas:</strong><br>
                        ‚Ä¢ API key inv√°lida<br>
                        ‚Ä¢ API key n√£o ativada (verifique seu email)<br>
                        ‚Ä¢ Limite de requisi√ß√µes excedido<br><br>
                        <a href="https://api.census.gov/data/key_signup.html" target="_blank">Obter Nova API Key ‚Üí</a>
                    </div>
                `;
            }
        }

        function saveRealEstateApiKeys() {
            const zillowKey = document.getElementById('zillowApiKey').value.trim();
            const realtorKey = document.getElementById('realtorApiKey').value.trim();
            const realtyMoleKey = document.getElementById('realtyMoleApiKey').value.trim();
            const usgsToken = document.getElementById('usgsM2mToken').value.trim();

            if (zillowKey) saveEncryptedKey('zillowApiKey', zillowKey);
            if (realtorKey) saveEncryptedKey('realtorApiKey', realtorKey);
            if (realtyMoleKey) saveEncryptedKey('realtyMoleApiKey', realtyMoleKey);
            if (usgsToken) saveEncryptedKey('usgsM2mToken', usgsToken);

            const indicator = document.getElementById('savedIndicatorRealEstate');
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 3000);
        }

        // üß™ Fun√ß√£o unificada para testar todas as RapidAPIs
        async function testAllRapidApis() {
            const apiKey = document.getElementById('rapidApiKey').value.trim();
            
            if (!apiKey) {
                alert('‚ùå Por favor, insira uma API Key primeiro!');
                return;
            }

            const resultDiv = document.getElementById('rapidApiTestResult');
            resultDiv.innerHTML = '<div class="status loading" style="margin-top: 10px;"><span class="loading-spinner"></span> Testando todas as APIs RapidAPI...</div>';

            const results = [];
            
            // Teste 1: Zillow
            try {
                const response = await fetch('https://zillow-com1.p.rapidapi.com/property?zpid=61975204', {
                    method: 'GET',
                    headers: {
                        'X-RapidAPI-Key': apiKey,
                        'X-RapidAPI-Host': 'zillow-com1.p.rapidapi.com'
                    }
                });
                const data = await response.json();
                if (response.ok && data) {
                    results.push({ name: 'Zillow', status: 'success', message: `${data.address?.streetAddress || 'Teste OK'}` });
                } else {
                    results.push({ name: 'Zillow', status: 'error', message: data.message || 'Erro desconhecido' });
                }
            } catch (error) {
                results.push({ name: 'Zillow', status: 'error', message: error.message });
            }
            
            // Teste 2: Realtor.com
            try {
                const response = await fetch('https://realtor.p.rapidapi.com/properties/v3/list?limit=1&offset=0&postal_code=90004&status=for_sale&sort=relevance', {
                    method: 'GET',
                    headers: {
                        'X-RapidAPI-Key': apiKey,
                        'X-RapidAPI-Host': 'realtor.p.rapidapi.com'
                    }
                });
                const data = await response.json();
                if (response.ok && data.data) {
                    results.push({ name: 'Realtor.com', status: 'success', message: 'API funcionando' });
                } else {
                    results.push({ name: 'Realtor.com', status: 'error', message: data.message || 'Erro desconhecido' });
                }
            } catch (error) {
                results.push({ name: 'Realtor.com', status: 'error', message: error.message });
            }
            
            // Teste 3: Realty Mole
            try {
                const response = await fetch('https://realty-mole-property-api.p.rapidapi.com/properties?address=5500%20Grand%20Lake%20Drive%2C%20San%20Antonio%2C%20TX', {
                    method: 'GET',
                    headers: {
                        'X-RapidAPI-Key': apiKey,
                        'X-RapidAPI-Host': 'realty-mole-property-api.p.rapidapi.com'
                    }
                });
                const data = await response.json();
                if (response.ok && data && data.length > 0) {
                    results.push({ name: 'Realty Mole', status: 'success', message: 'API funcionando' });
                } else {
                    results.push({ name: 'Realty Mole', status: 'error', message: 'Sem dados' });
                }
            } catch (error) {
                results.push({ name: 'Realty Mole', status: 'error', message: error.message });
            }
            
            // Teste 4: FEMA
            try {
                const response = await fetch('https://fema-flood-hazard-florida.p.rapidapi.com/query?point=-81.3792,28.5383', {
                    method: 'GET',
                    headers: {
                        'X-RapidAPI-Key': apiKey,
                        'X-RapidAPI-Host': 'fema-flood-hazard-florida.p.rapidapi.com'
                    }
                });
                const data = await response.json();
                if (response.ok && data) {
                    results.push({ name: 'FEMA Flood Risk', status: 'success', message: 'API funcionando' });
                } else {
                    results.push({ name: 'FEMA Flood Risk', status: 'error', message: 'Erro na resposta' });
                }
            } catch (error) {
                results.push({ name: 'FEMA Flood Risk', status: 'error', message: error.message });
            }
            
            // Exibir resultados
            let html = '<div style="margin-top: 15px;">';
            html += '<h4 style="margin-bottom: 10px;">üìã Resultados dos Testes:</h4>';
            html += '<div class="test-results">';
            
            results.forEach(result => {
                const statusClass = result.status === 'success' ? 'success' : 'error';
                const icon = result.status === 'success' ? '‚úÖ' : '‚ùå';
                html += `
                    <div class="test-card">
                        <h4>${icon} ${result.name}</h4>
                        <div class="status ${statusClass}">${result.status === 'success' ? 'Funcionando' : 'Erro'}</div>
                        <p style="font-size: 0.9rem; color: #666;">${result.message}</p>
                    </div>
                `;
            });
            
            html += '</div>';
            html += '</div>';
            
            resultDiv.innerHTML = html;
        }

        // ========================================
        // GOOGLE SHEETS INTEGRATION
        // ========================================

        /**
         * Salvar configura√ß√£o do Google Sheets
         */
        function saveGoogleSheetsConfig() {
            const webAppUrl = document.getElementById('googleSheetsWebAppUrl').value.trim();
            const password = document.getElementById('googleSheetsPassword').value.trim();
            
            if (!webAppUrl || !password) {
                alert('‚ùå Por favor, preencha a URL e a senha!');
                return;
            }
            
            localStorage.setItem('googleSheetsWebAppUrl', webAppUrl);
            sessionStorage.setItem('googleSheetsPassword', password);
            
            const indicator = document.getElementById('savedIndicatorSheets');
            indicator.style.display = 'block';
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 3000);
            
            alert('‚úÖ Configura√ß√£o do Google Sheets salva com sucesso!');
        }

        /**
         * Carregar API keys do Google Sheets
         */
        async function loadApiKeysFromSheets() {
            const webAppUrl = localStorage.getItem('googleSheetsWebAppUrl');
            const password = sessionStorage.getItem('googleSheetsPassword');
            
            if (!webAppUrl || !password) {
                alert('‚ùå Configure a URL e senha do Google Sheets primeiro!');
                return;
            }
            
            const resultDiv = document.getElementById('googleSheetsResult');
            resultDiv.innerHTML = '<div class="status loading" style="margin-top: 10px;"><span class="loading-spinner"></span> Carregando API Keys do Google Sheets...</div>';
            
            try {
                const response = await fetch(`${webAppUrl}?password=${encodeURIComponent(password)}`);
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Erro desconhecido');
                }
                
                // Carregar API keys nos campos
                const apiKeys = data.data;
                let loadedCount = 0;
                
                if (apiKeys.googleMapsApiKey) {
                    document.getElementById('googleMapsApiKey').value = apiKeys.googleMapsApiKey;
                    saveEncryptedKey('googleMapsApiKey', apiKeys.googleMapsApiKey);
                    loadedCount++;
                }
                
                if (apiKeys.openaiApiKey) {
                    document.getElementById('openaiApiKey').value = apiKeys.openaiApiKey;
                    saveEncryptedKey('openaiApiKey', apiKeys.openaiApiKey);
                    loadedCount++;
                }
                
                if (apiKeys.geminiApiKey) {
                    document.getElementById('geminiApiKey').value = apiKeys.geminiApiKey;
                    saveEncryptedKey('geminiApiKey', apiKeys.geminiApiKey);
                    loadedCount++;
                }
                
                if (apiKeys.perplexityApiKey) {
                    document.getElementById('perplexityApiKey').value = apiKeys.perplexityApiKey;
                    saveEncryptedKey('perplexityApiKey', apiKeys.perplexityApiKey);
                    loadedCount++;
                }
                
                if (apiKeys.rapidApiKey || apiKeys.zillowApiKey || apiKeys.realtorApiKey) {
                    const key = apiKeys.rapidApiKey || apiKeys.zillowApiKey || apiKeys.realtorApiKey;
                    document.getElementById('rapidApiKey').value = key;
                    saveEncryptedKey('rapidApiKey', key);
                    saveEncryptedKey('zillowApiKey', key);
                    saveEncryptedKey('realtorApiKey', key);
                    saveEncryptedKey('realtyMoleApiKey', key);
                    saveEncryptedKey('femaApiKey', key);
                    loadedCount++;
                }
                
                resultDiv.innerHTML = `
                    <div class="success-message" style="margin-top: 10px;">
                        <strong>‚úÖ Sucesso!</strong> ${loadedCount} API keys carregadas do Google Sheets!<br><br>
                        <strong>Timestamp:</strong> ${data.timestamp}<br>
                        <strong>APIs carregadas:</strong> ${Object.keys(apiKeys).map(k => escapeHTML(k)).join(', ')}
                    </div>
                `;
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error-message" style="margin-top: 10px;">
                        <strong>‚ùå Erro:</strong> ${typeof escapeHTML === 'function' ? escapeHTML(error.message) : error.message}<br><br>
                        <strong>Poss√≠veis causas:</strong><br>
                        ‚Ä¢ URL do Web App incorreta<br>
                        ‚Ä¢ Senha incorreta<br>
                        ‚Ä¢ Google Apps Script n√£o publicado<br>
                        ‚Ä¢ Permiss√µes n√£o autorizadas<br><br>
                        <a href="GOOGLE-SHEETS-SETUP.md" target="_blank">Ver Guia de Configura√ß√£o ‚Üí</a>
                    </div>
                `;
            }
        }

        /**
         * Ativar/Desativar carregamento autom√°tico
         */
        function toggleAutoLoad() {
            const currentState = localStorage.getItem('googleSheetsAutoLoad') === 'true';
            const newState = !currentState;
            
            localStorage.setItem('googleSheetsAutoLoad', newState.toString());
            
            const btn = document.getElementById('autoLoadBtn');
            if (newState) {
                btn.textContent = '‚ñ∂Ô∏è Auto-Load: ON';
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-success');
                alert('‚úÖ Auto-Load ativado! API keys ser√£o carregadas automaticamente ao abrir a p√°gina.');
            } else {
                btn.textContent = '‚è∏Ô∏è Auto-Load: OFF';
                btn.classList.remove('btn-success');
                btn.classList.add('btn-secondary');
                alert('‚è∏Ô∏è Auto-Load desativado.');
            }
        }

        /**
         * Carregar configura√ß√£o do Google Sheets ao carregar a p√°gina
         */
        window.addEventListener('DOMContentLoaded', () => {
            // Carregar configura√ß√£o salva
            const webAppUrl = localStorage.getItem('googleSheetsWebAppUrl');
            const password = sessionStorage.getItem('googleSheetsPassword');
            const autoLoad = localStorage.getItem('googleSheetsAutoLoad') === 'true';
            
            if (webAppUrl) document.getElementById('googleSheetsWebAppUrl').value = webAppUrl;
            if (password) document.getElementById('googleSheetsPassword').value = password;
            
            // Atualizar bot√£o de auto-load
            const btn = document.getElementById('autoLoadBtn');
            if (autoLoad) {
                btn.textContent = '‚ñ∂Ô∏è Auto-Load: ON';
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-success');
                
                // Carregar automaticamente se configurado
                if (webAppUrl && password) {
                    setTimeout(() => {
                        loadApiKeysFromSheets();
                    }, 1000);
                }
            }
        });
        
        // ========================================
        // ALERT KEYWORDS MANAGEMENT
        // ========================================
        
        // Load alert keywords on page load
        function loadAlertKeywords() {
            const alertKeywords = JSON.parse(localStorage.getItem('alertKeywords') || '{"risk": ["UNDIVIDED"], "warning": [], "info": []}');
            
            // Render each type
            renderKeywords('risk', alertKeywords.risk || []);
            renderKeywords('warning', alertKeywords.warning || []);
            renderKeywords('info', alertKeywords.info || []);
            
            // Load thresholds
            document.getElementById('undividedThreshold').value = localStorage.getItem('undividedThreshold') || '5';
            document.getElementById('totalAlertsThreshold').value = localStorage.getItem('totalAlertsThreshold') || '10';
        }
        
        function renderKeywords(type, keywords) {
            const container = document.getElementById(`${type}KeywordsList`);
            container.innerHTML = '';
            
            if (keywords.length === 0) {
                container.innerHTML = '<p style="color: #9ca3af; font-size: 0.9rem; margin: 0;">Nenhuma palavra-chave adicionada</p>';
                return;
            }
            
            keywords.forEach(keyword => {
                const tag = document.createElement('div');
                tag.className = `keyword-tag ${type}`;
                tag.innerHTML = `
                    <span>${keyword}</span>
                    <button onclick="removeKeyword('${type}', '${keyword}')">√ó</button>
                `;
                container.appendChild(tag);
            });
        }
        
        function addKeyword(type) {
            const input = document.getElementById(`${type}KeywordInput`);
            const keyword = input.value.trim().toUpperCase();
            
            if (!keyword) {
                alert('Por favor, digite uma palavra-chave!');
                return;
            }
            
            const alertKeywords = JSON.parse(localStorage.getItem('alertKeywords') || '{"risk": ["UNDIVIDED"], "warning": [], "info": []}');
            
            if (!alertKeywords[type]) {
                alertKeywords[type] = [];
            }
            
            if (alertKeywords[type].includes(keyword)) {
                alert('Esta palavra-chave j√° foi adicionada!');
                return;
            }
            
            alertKeywords[type].push(keyword);
            localStorage.setItem('alertKeywords', JSON.stringify(alertKeywords));
            
            renderKeywords(type, alertKeywords[type]);
            input.value = '';
            
            showSavedIndicator('savedIndicatorAlerts');
        }
        
        function removeKeyword(type, keyword) {
            if (!confirm(`Remover "${keyword}" dos alertas de ${type === 'risk' ? 'risco' : type === 'warning' ? 'aten√ß√£o' : 'informativos'}?`)) {
                return;
            }
            
            const alertKeywords = JSON.parse(localStorage.getItem('alertKeywords') || '{"risk": ["UNDIVIDED"], "warning": [], "info": []}');
            
            if (alertKeywords[type]) {
                alertKeywords[type] = alertKeywords[type].filter(k => k !== keyword);
                localStorage.setItem('alertKeywords', JSON.stringify(alertKeywords));
                renderKeywords(type, alertKeywords[type]);
                showSavedIndicator('savedIndicatorAlerts');
            }
        }
        
        function saveAlertSettings() {
            const undividedThreshold = document.getElementById('undividedThreshold').value;
            const totalAlertsThreshold = document.getElementById('totalAlertsThreshold').value;
            
            localStorage.setItem('undividedThreshold', undividedThreshold);
            localStorage.setItem('totalAlertsThreshold', totalAlertsThreshold);
            
            showSavedIndicator('savedIndicatorAlerts');
            alert('‚úÖ Configura√ß√µes de alertas salvas com sucesso!');
        }
        
        function resetAlertSettings() {
            if (!confirm('Resetar todas as configura√ß√µes de alertas para o padr√£o?')) {
                return;
            }
            
            localStorage.setItem('alertKeywords', JSON.stringify({"risk": ["UNDIVIDED"], "warning": [], "info": []}));
            localStorage.setItem('undividedThreshold', '5');
            localStorage.setItem('totalAlertsThreshold', '10');
            
            loadAlertKeywords();
            alert('‚úÖ Configura√ß√µes resetadas para o padr√£o!');
        }
        
        // Load alert keywords on page load
        loadAlertKeywords();

        // ========================================
        // INVESTMENT SETTINGS FUNCTIONS
        // ========================================
        
        function loadInvestmentSettings() {
            const settings = JSON.parse(localStorage.getItem('investmentSettings') || '{}');
            document.getElementById('closingCostPercent').value = settings.closingCostPercent ?? 9;
            document.getElementById('cleanTitleCost').value = settings.cleanTitleCost ?? 2500;
            document.getElementById('defaultROI1').value = settings.defaultROI1 ?? 30;
document.getElementById('defaultROI2').value = settings.defaultROI2 ?? 40;
             document.getElementById('defaultROI3').value = settings.defaultROI3 ?? 50;
        }
        
        function saveInvestmentSettings() {
            const settings = {
                closingCostPercent: parseFloat(document.getElementById('closingCostPercent').value) || 9,
                cleanTitleCost: parseFloat(document.getElementById('cleanTitleCost').value) || 2500,
                defaultROI1: parseFloat(document.getElementById('defaultROI1').value) || 30,
defaultROI2: parseFloat(document.getElementById('defaultROI2').value) || 40,
                 defaultROI3: parseFloat(document.getElementById('defaultROI3').value) || 50
            };
            localStorage.setItem('investmentSettings', JSON.stringify(settings));
            showSavedIndicator('savedIndicatorInvestment');
            alert('\u2705 Configura\u00e7\u00f5es de investimento salvas com sucesso!');
        }
        
        function resetInvestmentSettings() {
            if (!confirm('Resetar configura\u00e7\u00f5es de investimento para o padr\u00e3o?')) {
                return;
            }
            const defaults = {
                closingCostPercent: 9,
                cleanTitleCost: 2500,
                defaultROI1: 30,
defaultROI2: 40,
                 defaultROI3: 50
            };
            localStorage.setItem('investmentSettings', JSON.stringify(defaults));
            loadInvestmentSettings();
            alert('\u2705 Configura\u00e7\u00f5es de investimento resetadas para o padr\u00e3o!');
        }
        
        // Load investment settings on page load
        loadInvestmentSettings();

    </script>
</body>
</html>

